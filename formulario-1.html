<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Presupuesto Municipal | Municipalidad de Arica</title>
    <script src="dir_formularioapps.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        body {
            background-color: #f5f5f7;
            color: #1d1d1f;
            overflow-x: hidden;
        }
        
  
        html {
            scroll-behavior: smooth;
        }
        
          
header {
  background-color: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  transition: all 0.4s ease;
}

.top-header {
  display: flex;
  justify-content: center; 
  align-items: center;
  padding: 15px 5%;
  max-width: 1400px;
  margin: 0 auto;
  text-align: center;
}

.logo {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.logo img {
  height: 40px;
  transition: transform 0.3s ease;
}

.logo:hover img {
  transform: scale(1.05);
}

.logo-text {
  display: flex;
  flex-direction: column;
  align-items: center; 
  margin-left: 0;
}

.logo-text h1 {
  font-size: 24px;
  font-weight: 600;
  letter-spacing: -0.5px;
}

.logo-text span {
  font-size: 12px;
  font-weight: 400;
  color: #86868b;
}
        
   
        .transparency-container {
            position: relative;
            background-color: rgba(0, 0, 0, 0.03);
            text-align: center;
        }
        
        .transparency-toggle {
            display: none;
            background-color: rgba(0, 0, 0, 0.03);
            border: none;
            color: #06c;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            text-align: center;
            transition: background-color 0.3s ease;
        }
        
        .transparency-toggle:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .toggle-icon {
            display: inline-block;
            margin-left: 8px;
            transition: transform 0.3s ease;
        }
        
        .transparency-links {
            background-color: rgba(0, 0, 0, 0.03);
            display: flex;
            justify-content: center;
            padding: 10px 0;
            overflow-x: auto;
            white-space: nowrap;
            transition: max-height 0.4s ease;
        }
        
        .transparency-links a {
            color: #06c;
            text-decoration: none;
            margin: 0 15px;
            font-size: 14px;
            font-weight: 400;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .transparency-links a:hover {
            opacity: 0.7;
            transform: translateY(-1px);
        }
        
        /* Navigation menu */
        nav {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 1px 0 rgba(0, 0, 0, 0.05);
        }
        
        .main-menu {
            display: flex;
            list-style: none;
            justify-content: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 5%;
            overflow-x: auto;
        }
        
        .main-menu li {
            position: relative;
        }
        
        .main-menu a {
            display: block;
            padding: 15px 20px;
            color: #1d1d1f;
            text-decoration: none;
            font-weight: 400;
            font-size: 14px;
            transition: color 0.3s ease;
            position: relative;
        }
        
        .main-menu a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) scaleX(0);
            width: 20px;
            height: 2px;
            background-color: #06c;
            transition: transform 0.3s ease;
        }
        
        .main-menu a:hover {
            color: #06c;
        }
        
        .main-menu a:hover::after {
            transform: translateX(-50%) scaleX(1);
        }
        
       
         .dashboard-container {
            padding: 40px 5%;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }
        
        .dashboard-title {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: #1d2939;
            position: relative;
        }
        
        .dashboard-title:after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 0;
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, #0066cc, #1a8cff);
            border-radius: 2px;
        }
        
        .back-button {
            display: flex;
            align-items: center;
            background-color: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 100px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            color: #0066cc;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .back-button:hover {
            background-color: #f5f9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.15);
        }
        
        .back-icon {
            margin-right: 8px;
        }
        
     
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
            margin: 40px 0;
        }
        
        .card {
          flex: 0 1 calc(50% - 20px); 
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
            transition: all 0.4s ease;
            position: relative;
            z-index: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #0066cc, #1a8cff);
            z-index: 2;
        }
        
        .card-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #f0f7ff, #e6f2ff);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 25px auto 15px;
            color: #0066cc;
            font-size: 24px;
            transition: all 0.3s ease;
        }
        
        .card:hover .card-icon {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 5px 15px rgba(0, 102, 204, 0.15);
        }
        
        .card-title {
            font-size: 22px;
            font-weight: 600;
            text-align: center;
            margin: 10px 0;
            color: #1d2939;
            padding: 0 20px;
        }
        
        .card-description {
            text-align: center;
            padding: 0 25px;
            color: #64748b;
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 25px;
            flex-grow: 1;
        }
        
        .card-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            background: linear-gradient(135deg, #0066cc, #1a8cff);
            border: none;
            border-radius: 100px;
            text-decoration: none;
            transition: all 0.3s ease;
            margin: 0 auto 25px;
            box-shadow: 0 5px 15px rgba(0, 102, 204, 0.2);
        }
        
        .card-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 102, 204, 0.3);
            background: linear-gradient(135deg, #005cb8, #0080ff);
        }
        
        .card-button .arrow {
            margin-left: 8px;
            transition: transform 0.3s ease;
        }
        
        .card-button:hover .arrow {
            transform: translateX(4px);
        }
        
        
        .stats-section {
            background: linear-gradient(135deg, #ffffff, #f5f9ff);
            border-radius: 16px;
            padding: 40px;
            margin: 50px 0 40px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.04);
        }
        
        .stats-title {
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 30px;
            color: #1d2939;
        }
        
        .stats-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 0 20px;
            min-width: 220px;
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #0066cc, #1a8cff);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-label {
            color: #64748b;
            font-size: 16px;
        }
        
   
        footer {
            background-color: #f5f5f7;
            color: #1d1d1f;
            padding: 60px 5%;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            margin-top: 60px;
        }
        
        .footer-container {
            display: flex;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .footer-column {
            flex: 1;
            padding: 0 20px;
        }
        
        .footer-column h3 {
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }
        
        .footer-column p {
            margin-bottom: 10px;
            color: #86868b;
            font-size: 14px;
        }
        
        .footer-column ul {
            list-style: none;
        }
        
        .footer-column ul li {
            margin-bottom: 12px;
        }
        
        .footer-column a {
            color: #06c;
            text-decoration: none;
            font-size: 14px;
            transition: opacity 0.3s ease;
        }
        
        .footer-column a:hover {
            opacity: 0.7;
        }
        
        .social-icons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .social-icons a {
            background-color: rgba(0, 0, 0, 0.05);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: transform 0.3s ease, background-color 0.3s ease;
        }
        
        .social-icons a:hover {
            transform: translateY(-3px);
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        .footer-bottom {
            max-width: 1400px;
            margin: 40px auto 0;
            padding-top: 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            text-align: center;
            font-size: 12px;
            color: #86868b;
        }
        
        
        .assistant-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: rgba(6, 12, 204, 0.9);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 100;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .assistant-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
    
        @media (max-width: 992px) {
            .footer-container {
                flex-direction: column;
            }
            
            .footer-column {
                margin-bottom: 40px;
            }
            
            .dashboard-iframe {
                height: 65vh;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-title {
                font-size: 24px;
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .dashboard-iframe {
                height: 50vh;
            }
            
            .transparency-toggle {
                display: block;
            }
            
            .transparency-toggle.active .toggle-icon {
                transform: rotate(180deg);
            }
            
            .transparency-links {
                max-height: 0;
                padding: 0;
                overflow: hidden;
                flex-direction: column;
            }
            
            .transparency-links.active {
                max-height: 200px;
                padding: 10px 0;
            }
            
            .transparency-links a {
                margin: 8px 0;
                padding: 5px 0;
            }
        }
        .custom-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 12px 28px;
    font-size: 16px;
    font-weight: 600;
    color: #fff;
    background: linear-gradient(135deg, #ff6a00, #ee0979);
    border: none;
    border-radius: 999px;
    box-shadow: 0 8px 20px rgba(255, 105, 135, 0.3);
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .custom-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(255, 105, 135, 0.5);
    background: linear-gradient(135deg, #ee0979, #ff6a00);
  }

  .arrow {
    margin-left: 10px;
    font-size: 18px;
    transition: transform 0.3s ease;
  }

  .custom-btn:hover .arrow {
    transform: translateX(4px);
  }

  .card-icon-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-color: #f5f5f5;
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0 auto 15px; 
    overflow: hidden; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .card-icon-circle img {
    width: 80%; 
    height: 80%;
    object-fit: cover; 
    border-radius: 50%; 
  }
  
  .card-title {
    font-size: 1.5rem;
    color: #333;
    margin-bottom: 10px;
    text-align: center;
  }
  
  .card-description {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 20px;
    text-align: center;
    flex-grow: 1;
  }
  
  .card-button:hover {
    background-color: #0b7dda;
  }
  
  .arrow {
    margin-left: 8px;
    transition: transform 0.3s;
  }
  
  .card-button:hover .arrow {
    transform: translateX(5px);
  }
  
  
  @media (max-width: 768px) {
    .card {
      max-width: 100%;
    }
  }

.card-icon-circle-border {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background-color: white;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 15px;
  overflow: hidden;
  border: 3px solid #2196F3; 
}


.card-icon-circle-colored {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background-color: #2196F3;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 15px;
  overflow: hidden;
}

.card-icon-circle-colored img {
  width: 60%;
  height: 60%;
  object-fit: contain;
  filter: brightness(0) invert(1); 
}

.card-icon-circle-shadow {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background-color: #f5f5f5;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 15px;
  overflow: hidden;
  box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
}


.card-icon-circle-glow {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background-color: white;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 15px;
  overflow: hidden;
  box-shadow: 0 0 15px rgba(33, 150, 243, 0.5); 
}

.stats-section {
      margin-top: 30px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 20px;
    }
    
    .stats-title {
      color: #333;
      margin-bottom: 20px;
      text-align: center;
      font-size: 1.4em;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    
    .stats-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .stat-item {
      text-align: center;
      flex: 1;
      min-width: 150px;
      background-color: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }
    
    .stat-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    
    .stat-number {
      font-size: 2em;
      font-weight: bold;
      color: #2196F3;
      margin-bottom: 5px;
    }
    
    .stat-label {
      color: #555;
      font-size: 0.9em;
    }
    
   
    .alerts-container {
      margin-top: 20px;
    }
    
    .alert {
      padding: 12px 15px;
      margin-bottom: 15px;
      border-left: 5px solid;
      border-radius: 5px;
      font-size: 14px;
      display: flex;
      align-items: center;
    }
    
    .alert-icon {
      margin-right: 15px;
      width: 24px;
      height: 24px;
      flex-shrink: 0;
    }
    
    .alert-danger {
      background-color: #ffebee;
      border-color: #f44336;
      color: #d32f2f;
    }
    
    .alert-warning {
      background-color: #fff8e1;
      border-color: #ffc107;
      color: #ff8f00;
    }
    
    .alert-info {
      background-color: #e3f2fd;
      border-color: #2196F3;
      color: #0d47a1;
    }
    
    .alert-success {
      background-color: #e8f5e9;
      border-color: #4CAF50;
      color: #2e7d32;
    }
    
  
.charts-container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-top: 30px;
  width: 100%;
}

.chart-container {
  flex: 1;
  min-width: 300px;
  height: 300px;
  background-color: #f9f9f9;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  position: relative;
  overflow: hidden; 
}

@media (max-width: 768px) {
  .charts-container {
    flex-direction: column;
  }
  
  .chart-container {
    width: 100%;
    min-width: 0;
    height: 250px; 
    margin-bottom: 20px;
  }
}
    
 
    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }
    
    .summary-table th,
    .summary-table td {
      border: 1px solid #ddd;
      padding: 8px 12px;
      text-align: left;
    }
    
    .summary-table th {
      background-color: #f2f2f2;
      color: #333;
    }
    
    .summary-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    .progress-container {
      width: 100%;
      background-color: #e0e0e0;
      border-radius: 4px;
      height: 8px;
      margin-top: 5px;
    }
    
    .progress-bar {
      height: 100%;
      border-radius: 4px;
      background-color: #4CAF50;
    }
    
    .progress-bar-warning {
      background-color: #FFC107;
    }
    
    .progress-bar-danger {
      background-color: #F44336;
    }
    

    @media screen and (max-width: 768px) {
      .stats-container {
        flex-direction: column;
      }
      
      .chart-container {
        min-width: 100%;
      }
    }
    </style>
</head>
<body>
   
            <div class="top-header">
                <div class="logo">
                    <img src="logo_MUNI.png" alt="Logo Municipalidad de Arica">
                    <div class="logo-text">
                        <h1>ARICA</h1>
                        <span>MUNICIPALIDAD | mejor ciudad</span>
                    </div>
                </div>
            </div>
    


    </section>
   
     <section class="dashboard-container">
        <div class="dashboard-header">
            <h2 class="dashboard-title">Sistema de Gestión de Presupuestos</h2>
            <button class="back-button" onclick="window.location.href='index.html'">
                <span class="back-icon"><i class="fas fa-arrow-left"></i></span> Volver al Inicio
            </button>
        </div>

   
        <div class="cards-container">
    
            <div class="card">
                <div class="card-icon-circle">
                    <img src="Presupuesto-Ingresos.webp" alt="Icono de Presupuesto">
                  </div>
                <h3 class="card-title">Ingreso de Compras</h3>
                <p class="card-description">
                    Complete el formulario para registrar un nuevo presupuesto anual de compra para su departamento o área municipal.
                </p>
                <a href="Formulario_agregar_compra.html" class="card-button">
                    Acceder <span class="arrow"><i class="fas fa-arrow-right"></i></span>
                </a>
            </div>
            
      
            <div class="card">
                <div class="card-icon-circle">
                    <img src="exceeel" alt="Icono de Presupuesto">
                  </div>
                <h3 class="card-title">Explorador de Compras</h3>
                <p class="card-description">
                    Consulte y analice los presupuestos ingresados, con opciones para filtrar por departamento, período y estado.
                </p>
                <a href="exportador_datos.html" class="card-button">
                    Acceder <span class="arrow"><i class="fas fa-arrow-right"></i></span>
                </a>
            </div>
            
            
            <div class="card">
                <div class="card-icon-circle">
                    <img src="imagenpac.jpeg" alt="Icono de Presupuesto">
                  </div>
                <h3 class="card-title">Ingreso de PAC</h3>
                <p class="card-description">
                  Complete el formulario para registrar los Presupuesto Anual de Compras para su departamento o área municipal.
                </p>
                <a href="ingreso_PAC.html" class="card-button">
                    Acceder <span class="arrow"><i class="fas fa-arrow-right"></i></span>
                </a>
            </div>
           
            <div class="card">
              <div class="card-icon-circle">
                  <img src="exceeel" alt="Icono de Presupuesto">
                </div>
              <h3 class="card-title">Explorador de PAC</h3>
              <p class="card-description">
                Consulte y analice los Presupuesto Anual de Compras, con opciones para filtrar por departamento, período y estado.
              </p>
              <a href="exportador_de_datos_PAC.html" class="card-button">
                  Acceder <span class="arrow"><i class="fas fa-arrow-right"></i></span>
              </a>
          </div>
        </div>
        

        <div class="stats-section">
            <h3 class="stats-title">Estadísticas del Sistema</h3>
           
            <div class="stats-container">
              <div class="stat-item">
                <div class="stat-number" id="presupuestos-count">0</div>
                <div class="stat-label">Presupuestos Activos</div>
              </div>
              <div class="stat-item">
                <div class="stat-number" id="departments-count">0</div>
                <div class="stat-label">Departamentos</div>
              </div>
              <div class="stat-item">
                <div class="stat-number" id="compras-count">0</div>
                <div class="stat-label">Compras Registradas</div>
              </div>
              <div class="stat-item">
                <div class="stat-number" id="total-year">$0</div>
                <div class="stat-label">Total Comprometido</div>
              </div>
            </div>
            
        
            <div class="alerts-container" id="alerts-container">
    
            </div>
           
            <h4 class="stats-title">Resumen por Departamento</h4>
            <div style="overflow-x: auto;">
              <table class="summary-table" id="dept-summary-table">
                <thead>
                  <tr>
                    <th>Departamento</th>
                    <th>Presupuesto Anual</th>
                    <th>Comprometido</th>
                    <th>Gastado</th>
                    <th>% Ejecución</th>
                    <th>Estado</th>
                   
                  </tr>
                </thead>
                <tbody id="dept-summary-body">
              
                </tbody>
              </table>
            </div>
            
            
            <div class="charts-container">
              <div class="chart-container">
                <h4 class="chart-title">Distribución de Saldo Comprometido por Departamento</h4>
                <canvas id="departmentChart"></canvas>
              </div>
              <div class="chart-container">
                <h4 class="chart-title">Ejecución Presupuestaria Mensual</h4>
                <canvas id="monthlyChart"></canvas>
              </div>
            </div>
          </div>
    </section>
    

     <footer>
        <div class="footer-container">
            <div class="footer-column">
                <h3>Municipalidad de Arica</h3>
                <p>Renato Rocca , Arica</p>
                <p>Anexo:6959 </p>
                <p>Email:roberto.mamani@municipalidadarica.cl </p>
                <div class="social-icons">
                    <a href="#">📘</a>
                    <a href="#">📱</a>
                    <a href="#">🐦</a>
                    <a href="#">📸</a>
                </div>
            </div>
            <div class="footer-column">
                <h3>Colaboración Interdepartamental</h3>
                <p style="line-height: 1.6;">
                    Este proyecto surge con el propósito de fortalecer la colaboración entre diversas áreas municipales, como <strong>iluminación pública</strong>, <strong>Of. Mantenimiento de Vehículos y Maquinaria</strong>, <strong>Aseo y Ornato</strong>, <strong>Asesoría Tecnica </strong> y más, en un solo sistema integral. 
                    Buscando consolidar la información y los procesos en un solo sistema, permitiendo un <strong>mayor control operativo</strong>, <strong>gestión por áreas</strong> y una visión integral para la <strong>mejora continua de los servicios municipales</strong>.
                </p>
            </div>
            <div class="footer-column licitaciones">
              <h3>Licitaciones</h3>
              <ul class="licitaciones-list">
                  <li><a href="licitacion_agil.html">Licitación Ágil</a></li>
                  <li><a href="licitacion_gran_compra.html">Gran Compra</a></li>
                  <li><a href="licitacion_trato_directo.html">Trato Directo</a></li>
                  <li><a href="licitacion_publica.html">Licitación Pública</a></li>
                  <li><a href="licitacion_convenio_marco.html">Convenio Marco</a></li>
              </ul>
          </div>
        </div>
        <div class="footer-bottom">
            <p>© 2025 Municipalidad de Arica. Todos los derechos reservados.</p
            <p> Desarrollado por Junior Barrera</p
        </div>
    </footer>
 
    <div class="assistant-button" onclick="openAssistance()">💬</div>
    
    <script>
        //propiedad JUNIOR BARRERA .....
        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }
        
        
        function handleIframeError() {
            const iframe = document.getElementById('dashboardIframe');
            
           
            setTimeout(function() {
                try {
                    
                    const iframeContent = iframe.contentWindow || iframe.contentDocument;
                    if (!iframeContent) {
                        
                        showFallbackMessage();
                    }
                } catch (e) {
                    
                    showFallbackMessage();
                }
            }, 10000);
        }
        
       
        function showFallbackMessage() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <h3 style="margin-bottom: 15px;">No se pudo cargar el dashboard</h3>
                    <p style="margin-bottom: 20px;">Parece que hay un problema al cargar el dashboard. Por favor, intenta:</p>
                    <a href="https://lookerstudio.google.com/reporting/da465897-8e1a-4d06-9f8e-27d84a749431" 
                       target="_blank" 
                       style="display: inline-block; background-color: #06c; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none;">
                        Ver dashboard en Looker Studio
                    </a>
                </div>
            `;
            loadingIndicator.style.display = 'flex';
        }
        
    
        function openAssistance() {
           
            const phoneNumber = "56959414178"; 
            window.open(`https://wa.me/${phoneNumber}`, '_blank');
        }
        
        
        document.addEventListener('DOMContentLoaded', function() {
            const transparencyToggle = document.querySelector('.transparency-toggle');
            const transparencyLinks = document.querySelector('.transparency-links');
            
            if (transparencyToggle && transparencyLinks) {
                transparencyToggle.addEventListener('click', function() {
                    transparencyToggle.classList.toggle('active');
                    transparencyLinks.classList.toggle('active');
                });
                
                
                function checkScreenWidth() {
                    if (window.innerWidth <= 768) {
                        transparencyLinks.classList.remove('active');
                    } else {
                        transparencyLinks.classList.add('active');
                    }
                }
                
             
                checkScreenWidth();
                window.addEventListener('resize', checkScreenWidth);
            }
            
        
            const header = document.querySelector('header');
            
            window.addEventListener('scroll', () => {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                if (scrollTop > 100) {
                    header.style.boxShadow = '0 5px 20px rgba(0, 0, 0, 0.1)';
                } else {
                    header.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.05)';
                }
            });
            
           
            handleIframeError();
        });
    </script>
  
    <script>
      const WEB_APP_URL = dir_pac;
      
      
      let dat_PAC = [];  
      let chartInstancesDep = null;
      let chartInstancesMonthly = null;
      let aniosDisponibles = []; 
      let anioSeleccionado = new Date().getFullYear().toString(); 
      
    
      function formatearNumero(valor) {
        if (valor === null || valor === undefined) return "0";
        
        let valor2 = valor.toString().replace(/\./g, '').replace(/\D/g, '');
        
        let numeroFormateado = new Intl.NumberFormat('es-ES').format(parseInt(valor2) || 0);
        return numeroFormateado;
      }
      
      
      function mostrarErrorEnContadores(mensaje) {
        document.getElementById('presupuestos-count').textContent = 'Error';
        document.getElementById('departments-count').textContent = 'Error';
        document.getElementById('compras-count').textContent = 'Error';
        document.getElementById('total-year').textContent = 'Error';
        
        
        const alertasContainer = document.getElementById('alerts-container');
        alertasContainer.innerHTML = `
          <div class="alert alert-danger">
            <strong>Error:</strong> ${mensaje || 'No se pudieron cargar los datos. Intente recargar la página.'}
          </div>
        `;
        
        console.error(mensaje || 'Error al cargar datos');
      }
      
    
      function crearSelectorAnios() {
      
        aniosDisponibles = Array.from(new Set(dat_PAC
          .filter(fila => fila && fila[0]) 
          .map(fila => fila[0].toString()))); 
        
       
        aniosDisponibles.sort((a, b) => b - a);
        
        
        if (!aniosDisponibles.includes(anioSeleccionado) && aniosDisponibles.length > 0) {
          anioSeleccionado = aniosDisponibles[0];
        }
        
        
        const dashboardHeader = document.querySelector('.dashboard-header');
        let selectorAnios = document.getElementById('selector-anios');
        
        if (!selectorAnios) {
         
          const selectorContainer = document.createElement('div');
          selectorContainer.className = 'year-selector-container';
          selectorContainer.innerHTML = `
            <label for="selector-anios">Año: </label>
            <select id="selector-anios" class="year-selector"></select>
          `;
          
          
          dashboardHeader.insertBefore(selectorContainer, dashboardHeader.querySelector('.back-button'));
          selectorAnios = document.getElementById('selector-anios');
          
          
          selectorAnios.addEventListener('change', function() {
            anioSeleccionado = this.value;
            actualizarEstadisticas();
            generarAlertas();
            actualizarTablaDepartamentos();
            crearGraficos();
          });
        }
        
        
        selectorAnios.innerHTML = '';
        aniosDisponibles.forEach(anio => {
          const option = document.createElement('option');
          option.value = anio;
          option.textContent = anio;
          option.selected = anio === anioSeleccionado;
          selectorAnios.appendChild(option);
        });
        
       
        const statsTitle = document.querySelector('.stats-title');
        if (statsTitle) {
          statsTitle.textContent = `Estadísticas del Sistema (${anioSeleccionado})`;
        }
      }
      

function cargarDatosEstadisticas() {
  document.getElementById('presupuestos-count').innerHTML = '<div class="loading-spinner"></div>';
  document.getElementById('departments-count').innerHTML = '<div class="loading-spinner"></div>';
  document.getElementById('compras-count').innerHTML = '<div class="loading-spinner"></div>';
  document.getElementById('total-year').innerHTML = '<div class="loading-spinner"></div>';
  
 
  fetch(WEB_APP_URL)
    .then(response => {
      if (!response.ok) {
        throw new Error(`Error de red: ${response.status} ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('Datos recibidos:', data); 
      if (!data || typeof data !== 'object') {
        throw new Error('Formato de datos inesperado');
      }
      
      
      dat_PAC = Array.isArray(data.dat_PAC) ? data.dat_PAC : [];
      
      
      if (dat_PAC.length === 0) {
        throw new Error('No se recibieron datos del PAC');
      }
      
     
      actualizarEstadisticas();
      
      
      generarAlertas();
      
      
      actualizarTablaDepartamentos();
      
      if (typeof Chart !== 'undefined') {
        crearGraficos();
      } else {
        console.warn('Chart.js no está disponible. Los gráficos no se mostrarán.');
      }
    })
    .catch(error => {
      console.error('Error al obtener los datos:', error);
      mostrarErrorEnContadores(error.message);
    });
}

function actualizarEstadisticas() {
  try {
    const anioActual = new Date().getFullYear().toString();
    const datosAnioActual = dat_PAC.filter(fila => 
      fila && Array.isArray(fila) && fila[0] && fila[0].toString() === anioActual
    );
    
    
    const productosUnicos = new Set();
    datosAnioActual.forEach(fila => {
      if (fila && fila[4]) productosUnicos.add(fila[4].toString().trim().toUpperCase());
    });
  
    const departamentosUnicos = new Set();
    datosAnioActual.forEach(fila => {
      if (fila && fila[1]) departamentosUnicos.add(fila[1].toString().trim().toUpperCase());
    });
    
  
    const itemsRegistrados = datosAnioActual.length;
    
  
    let totalPresupuestoAnual = 0;
    datosAnioActual.forEach(fila => {
      if (fila && fila[7]) {  
    
        const valor = fila[7].toString().replace(/\./g, '').replace(/\D/g, '');
        totalPresupuestoAnual += parseInt(valor) || 0;
      }
    });
    
  
    document.getElementById('presupuestos-count').textContent = productosUnicos.size;
    document.getElementById('departments-count').textContent = departamentosUnicos.size;
    document.getElementById('compras-count').textContent = itemsRegistrados;
    document.getElementById('total-year').textContent = '$' + formatearNumero(totalPresupuestoAnual);
  } catch (error) {
    console.error('Error al actualizar estadísticas:', error);
    mostrarErrorEnContadores('Error al procesar estadísticas del PAC');
  }
}


function generarAlertas() {
  try {
    const alertasContainer = document.getElementById('alerts-container');
    alertasContainer.innerHTML = ''; 
    
    const anioActual = new Date().getFullYear().toString();
    

    const presupuestoPorDepartamento = {};
    const comprometidoPorDepartamento = {};
    const gastadoPorDepartamento = {};
    
    dat_PAC.forEach(fila => {
      if (fila && fila[0] && fila[0].toString() === anioActual && fila[1]) {
        const departamento = fila[1].toString().trim().toUpperCase();
        
        
        const presupuesto = fila[7] ? parseInt(fila[7].toString().replace(/\./g, '').replace(/\D/g, '')) || 0 : 0;  // Columna 8
        const comprometido = fila[17] ? parseInt(fila[17].toString().replace(/\./g, '').replace(/\D/g, '')) || 0 : 0;  // Columna 18
        const gastado = fila[19] ? parseInt(fila[19].toString().replace(/\./g, '').replace(/\D/g, '')) || 0 : 0;  // Columna 20
        
        
        presupuestoPorDepartamento[departamento] = (presupuestoPorDepartamento[departamento] || 0) + presupuesto;
        comprometidoPorDepartamento[departamento] = (comprometidoPorDepartamento[departamento] || 0) + comprometido;
        gastadoPorDepartamento[departamento] = (gastadoPorDepartamento[departamento] || 0) + gastado;
      }
    });
    
  
    const deptosBajaEjecucion = [];
    for (const depto in presupuestoPorDepartamento) {
      if (presupuestoPorDepartamento[depto] > 0) {
        const porcentajeEjecucion = (gastadoPorDepartamento[depto] / presupuestoPorDepartamento[depto]) * 100;
        if (porcentajeEjecucion < 30) {
          deptosBajaEjecucion.push({ nombre: depto, porcentaje: porcentajeEjecucion.toFixed(2) });
        }
      }
    }
    
   
    if (deptosBajaEjecucion.length > 0) {
      const alertaHtml = `
        <div class="alert alert-warning">
          <strong>¡Atención!</strong> ${deptosBajaEjecucion.length} departamento(s) con menos del 30% del presupuesto ejecutado.
          <a href="#" onclick="mostrarDetalleAlerta('deptos-baja-ejecucion')">Ver detalles</a>
        </div>
      `;
      alertasContainer.innerHTML += alertaHtml;
    }
    
    
    const deptosAltaEjecucion = [];
    for (const depto in presupuestoPorDepartamento) {
      if (presupuestoPorDepartamento[depto] > 0) {
        const porcentajeEjecucion = (gastadoPorDepartamento[depto] / presupuestoPorDepartamento[depto]) * 100;
        if (porcentajeEjecucion > 90) {
          deptosAltaEjecucion.push({ nombre: depto, porcentaje: porcentajeEjecucion.toFixed(2) });
        }
      }
    }
    
    
    if (deptosAltaEjecucion.length > 0) {
      const alertaHtml = `
        <div class="alert alert-success">
          <strong>¡Excelente!</strong> ${deptosAltaEjecucion.length} departamento(s) han ejecutado más del 90% de su presupuesto.
          <a href="#" onclick="mostrarDetalleAlerta('deptos-alta-ejecucion')">Ver detalles</a>
        </div>
      `;
      alertasContainer.innerHTML += alertaHtml;
    }
    
    
    const deptosGranDiferencia = [];
    for (const depto in comprometidoPorDepartamento) {
      if (comprometidoPorDepartamento[depto] > 0) {
        const porcentajeGastadoVsComprometido = (gastadoPorDepartamento[depto] / comprometidoPorDepartamento[depto]) * 100;
        if (porcentajeGastadoVsComprometido < 50 && comprometidoPorDepartamento[depto] > presupuestoPorDepartamento[depto] * 0.5) {
          deptosGranDiferencia.push({ 
            nombre: depto, 
            comprometido: formatearNumero(comprometidoPorDepartamento[depto]),
            gastado: formatearNumero(gastadoPorDepartamento[depto]),
            porcentaje: porcentajeGastadoVsComprometido.toFixed(2)
          });
        }
      }
    }
    
    
    if (deptosGranDiferencia.length > 0) {
      const alertaHtml = `
        <div class="alert alert-info">
          <strong>Información:</strong> ${deptosGranDiferencia.length} departamento(s) tienen menos del 50% de ejecución sobre su presupuesto comprometido.
          <a href="#" onclick="mostrarDetalleAlerta('deptos-diferencia')">Ver detalles</a>
        </div>
      `;
      alertasContainer.innerHTML += alertaHtml;
    }
    
    
    if (alertasContainer.innerHTML === '') {
      alertasContainer.innerHTML = '<div class="alert alert-success">No hay alertas pendientes en el sistema.</div>';
    }
  } catch (error) {
    console.error('Error al generar alertas:', error);
    const alertasContainer = document.getElementById('alerts-container');
    alertasContainer.innerHTML = `
      <div class="alert alert-danger">
        <strong>Error:</strong> No se pudieron generar las alertas del sistema.
      </div>
    `;
  }
}

function actualizarTablaDepartamentos() {
  try {
    const tbody = document.getElementById('dept-summary-body');
    tbody.innerHTML = ''; 
    
    const anioActual = new Date().getFullYear().toString();
    
    
    const datosPorDepartamento = {};
    
    dat_PAC.forEach(fila => {
      if (fila && fila[0] && fila[0].toString() === anioActual && fila[1]) {
        const departamento = fila[1].toString().trim().toUpperCase();
        
        const presupuesto = fila[7] ? parseInt(fila[7].toString().replace(/\./g, '').replace(/\D/g, '')) || 0 : 0;  // Columna 8: Total Ítem
        const comprometido = fila[17] ? parseInt(fila[17].toString().replace(/\./g, '').replace(/\D/g, '')) || 0 : 0;  // Columna 18: Comprometido
        const gastado = fila[19] ? parseInt(fila[19].toString().replace(/\./g, '').replace(/\D/g, '')) || 0 : 0;  // Columna 20: Gastado
        
        if (!datosPorDepartamento[departamento]) {
          datosPorDepartamento[departamento] = {
            presupuesto: 0,
            comprometido: 0,
            gastado: 0
          };
        }
        
        datosPorDepartamento[departamento].presupuesto += presupuesto;
        datosPorDepartamento[departamento].comprometido += comprometido;
        datosPorDepartamento[departamento].gastado += gastado;
      }
    });
    
    
    const departamentosArray = Object.keys(datosPorDepartamento).map(dept => ({
      nombre: dept,
      presupuesto: datosPorDepartamento[dept].presupuesto,
      comprometido: datosPorDepartamento[dept].comprometido,
      gastado: datosPorDepartamento[dept].gastado,
      porcentajeEjecucion: datosPorDepartamento[dept].presupuesto > 0 
        ? (datosPorDepartamento[dept].gastado / datosPorDepartamento[dept].presupuesto * 100).toFixed(2) 
        : 0
    }));
    
   
    departamentosArray.sort((a, b) => b.presupuesto - a.presupuesto);
    
    
    departamentosArray.forEach(dept => {
      
      let estado = '';
      let estadoClase = '';
      
      const porcentaje = parseFloat(dept.porcentajeEjecucion);
      if (porcentaje >= 90) {
        estado = 'Óptimo';
        estadoClase = 'estado-optimo';
      } else if (porcentaje >= 70) {
        estado = 'Avanzado';
        estadoClase = 'estado-avanzado';
      } else if (porcentaje >= 30) {
        estado = 'Normal';
        estadoClase = 'estado-normal';
      } else {
        estado = 'Bajo';
        estadoClase = 'estado-bajo';
      }
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${dept.nombre}</td>
        <td>$${formatearNumero(dept.presupuesto)}</td>
        <td>$${formatearNumero(dept.comprometido)}</td>
        <td>$${formatearNumero(dept.gastado)}</td>
        <td>${dept.porcentajeEjecucion}%</td>
        <td class="${estadoClase}">${estado}</td>
      `;
      
      tbody.appendChild(tr);
    });
  } catch (error) {
    console.error('Error al actualizar tabla:', error);
    const tbody = document.getElementById('dept-summary-body');
    tbody.innerHTML = `
      <tr>
        <td colspan="6" style="text-align:center; color:red;">
          Error al cargar los datos de la tabla. Intente recargar la página.
        </td>
      </tr>
    `;
  }
}

function crearGraficos() {
  if (typeof Chart === 'undefined') {
    console.error('Chart.js no está disponible');
    return;
  }
  
  try {
    
    crearGraficoDepartamentos();
    
    
    crearGraficoMensual();
  } catch (error) {
    console.error('Error al crear gráficos:', error);
  }
}


function crearGraficoDepartamentos() {
  try {
    const canvas = document.getElementById('departmentChart');
    if (!canvas) {
      console.error('Canvas para gráfico de departamentos no encontrado');
      return;
    }
    
    const ctx = canvas.getContext('2d');
    
    
    const anioActual = new Date().getFullYear().toString();
    const datosPorDepartamento = {};
    
    dat_PAC.forEach(fila => {
      if (fila && fila[0] && fila[0].toString() === anioActual && fila[1]) {
        const departamento = fila[1].toString().trim().toUpperCase();
        const presupuesto = fila[8] ? parseInt(fila[8].toString().replace(/\./g, '').replace(/\D/g, '')) || 0 : 0;
        
        if (!datosPorDepartamento[departamento]) {
          datosPorDepartamento[departamento] = 0;
        }
        
        datosPorDepartamento[departamento] += presupuesto;
      }
    });
    
    
    const labels = Object.keys(datosPorDepartamento);
    const data = Object.values(datosPorDepartamento);
    
    
    const backgroundColors = [
      '#4CAF50', '#2196F3', '#FFC107', '#FF5722', '#9C27B0',
      '#3F51B5', '#E91E63', '#00BCD4', '#FFEB3B', '#795548'
    ];
    
   
    if (chartInstancesDep) {
      chartInstancesDep.destroy();
    }
    
    
    chartInstancesDep = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: backgroundColors.slice(0, labels.length),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
            labels: {
              boxWidth: 15,
              font: {
                size: 10
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.raw;
                return label + ': $' + formatearNumero(value);
              }
            }
          }
        }
      }
    });
  } catch (error) {
    console.error('Error al crear gráfico de departamentos:', error);
  }
}


function crearGraficoDepartamentos() {
  try {
    const canvas = document.getElementById('departmentChart');
    if (!canvas) {
      console.error('Canvas para gráfico de departamentos no encontrado');
      return;
    }
    
    const ctx = canvas.getContext('2d');
    
    
    const anioActual = new Date().getFullYear().toString();
    const datosPorDepartamento = {};
    
    dat_PAC.forEach(fila => {
      if (fila && fila[0] && fila[0].toString() === anioActual && fila[1]) {
        const departamento = fila[1].toString().trim().toUpperCase();
        const presupuesto = fila[7] ? parseInt(fila[7].toString().replace(/\./g, '').replace(/\D/g, '')) || 0 : 0;  // Columna 8: Total Ítem
        
        if (!datosPorDepartamento[departamento]) {
          datosPorDepartamento[departamento] = 0;
        }
        
        datosPorDepartamento[departamento] += presupuesto;
      }
    });
    
    
    const labels = Object.keys(datosPorDepartamento);
    const data = Object.values(datosPorDepartamento);
    
   
    const backgroundColors = [
      '#4CAF50', '#2196F3', '#FFC107', '#FF5722', '#9C27B0',
      '#3F51B5', '#E91E63', '#00BCD4', '#FFEB3B', '#795548'
    ];
    
    
    if (chartInstancesDep) {
      chartInstancesDep.destroy();
    }
    
   
    chartInstancesDep = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: backgroundColors.slice(0, labels.length),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
            labels: {
              boxWidth: 15,
              font: {
                size: 10
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.raw;
                return label + ': $' + formatearNumero(value);
              }
            }
          }
        }
      }
    });
  } catch (error) {
    console.error('Error al crear gráfico de departamentos:', error);
  }
}

function crearGraficoMensual() {
  try {
    const canvas = document.getElementById('monthlyChart');
    if (!canvas) {
      console.error('Canvas para gráfico mensual no encontrado');
      return;
    }
    
    const ctx = canvas.getContext('2d');
   
    const anioActual = new Date().getFullYear().toString();
    
    
    const datosPorDepartamento = {};
    
    dat_PAC.forEach(fila => {
      if (fila && fila[0] && fila[0].toString() === anioActual && fila[1]) {
        const departamento = fila[1].toString().trim().toUpperCase();
        
        if (!datosPorDepartamento[departamento]) {
          datosPorDepartamento[departamento] = {
            presupuesto: 0,
            comprometido: 0,
            gastado: 0
          };
        }
        
      
        const presupuesto = fila[7] ? parseInt(fila[7].toString().replace(/\./g, '').replace(/\D/g, '')) || 0 : 0;
        
        const comprometido = fila[17] ? parseInt(fila[17].toString().replace(/\./g, '').replace(/\D/g, '')) || 0 : 0;
       
        const gastado = fila[19] ? parseInt(fila[19].toString().replace(/\./g, '').replace(/\D/g, '')) || 0 : 0;
        
        datosPorDepartamento[departamento].presupuesto += presupuesto;
        datosPorDepartamento[departamento].comprometido += comprometido;
        datosPorDepartamento[departamento].gastado += gastado;
      }
    });
    
    
    const departamentos = Object.keys(datosPorDepartamento);
    const presupuestos = [];
    const comprometidos = [];
    const gastados = [];
    
    
    const topDepartamentos = departamentos
      .map(dept => ({ 
        nombre: dept, 
        presupuesto: datosPorDepartamento[dept].presupuesto 
      }))
      .sort((a, b) => b.presupuesto - a.presupuesto)
      .slice(0, 8)
      .map(item => item.nombre);
    
    
    topDepartamentos.forEach(dept => {
      presupuestos.push(datosPorDepartamento[dept].presupuesto);
      comprometidos.push(datosPorDepartamento[dept].comprometido);
      gastados.push(datosPorDepartamento[dept].gastado);
    });
    
    
    if (chartInstancesMonthly) {
      chartInstancesMonthly.destroy();
    }
    
    
    chartInstancesMonthly = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: topDepartamentos,
        datasets: [
          {
            label: 'Presupuesto Anual',
            data: presupuestos,
            backgroundColor: 'rgba(75, 192, 192, 0.5)',
            borderColor: 'rgb(75, 192, 192)',
            borderWidth: 1
          },
          {
            label: 'Comprometido',
            data: comprometidos,
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgb(54, 162, 235)',
            borderWidth: 1
          },
          {
            label: 'Ejecutado',
            data: gastados,
            backgroundColor: 'rgba(255, 99, 132, 0.5)',
            borderColor: 'rgb(255, 99, 132)',
            borderWidth: 1
          }
        ]
      },
      options: {
        indexAxis: 'y',  
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                if (value >= 1000000) {
                  return '$' + (value / 1000000).toFixed(1) + 'M';
                } else if (value >= 1000) {
                  return '$' + (value / 1000).toFixed(1) + 'K';
                }
                return '$' + value;
              }
            }
          }
        },
        plugins: {
          legend: {
            position: 'top',
          },
          title: {
            display: true,
            text: 'Comparativa Presupuesto-Ejecución por Departamento'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.dataset.label || '';
                const value = context.raw;
                return label + ': $' + formatearNumero(value);
              }
            }
          }
        }
      }
    });
  } catch (error) {
    console.error('Error al crear gráfico por departamento:', error);
  }
}


function inicializarSistema() {
  try {
   
    if (typeof Chart === 'undefined') {
      console.log('Cargando Chart.js...');
      
      const scriptChartJs = document.createElement('script');
      scriptChartJs.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
      scriptChartJs.integrity = 'sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgMabC3vkumRokgJA==';
      scriptChartJs.crossOrigin = 'anonymous';
      scriptChartJs.referrerPolicy = 'no-referrer';
      
      
      scriptChartJs.onload = function() {
        console.log('Chart.js cargado correctamente');
        setTimeout(cargarDatosEstadisticas, 500); 
      };
      
      scriptChartJs.onerror = function() {
        console.error('Error al cargar Chart.js');
        cargarDatosEstadisticas(); 
      };
      
      document.head.appendChild(scriptChartJs);
    } else {
    
      cargarDatosEstadisticas();
    }
    
  
    setInterval(cargarDatosEstadisticas, 300000);
    
  } catch (error) {
    console.error('Error al inicializar el sistema:', error);
    mostrarErrorEnContadores('Error al inicializar el sistema');
  }
}


function agregarEstilos() {
  const estilosCSS = document.createElement('style');
  estilosCSS.innerHTML = `
    /* Estilos para alertas */
    .alert {
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid transparent;
      border-radius: 4px;
    }
    .alert-success {
      color: #155724;
      background-color: #d4edda;
      border-color: #c3e6cb;
    }
    .alert-info {
      color: #0c5460;
      background-color: #d1ecf1;
      border-color: #bee5eb;
    }
    .alert-warning {
      color: #856404;
      background-color: #fff3cd;
      border-color: #ffeeba;
    }
    .alert-danger {
      color: #721c24;
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }
    .alert a {
      font-weight: bold;
      text-decoration: underline;
      color: inherit;
    }
    
    /* Estilos para estados */
    .estado-critico {
      color: #721c24;
      font-weight: bold;
    }
    .estado-avanzado {
      color: #856404;
      font-weight: bold;
    }
    .estado-normal {
      color: #155724;
    }
    .estado-bajo {
      color: #0c5460;
    }
    
    /* Animación de carga */
    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: #333;
      animation: spin 1s ease-in-out infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Mejorar responsividad de los gráficos */
    .chart-container {
      height: 300px;
      position: relative;
    }
    
    @media (max-width: 768px) {
      .charts-container {
        flex-direction: column;
      }
      .chart-container {
        width: 100%;
        margin-bottom: 20px;
      }
    }
  `;
  document.head.appendChild(estilosCSS);
}


document.addEventListener('DOMContentLoaded', function() {
  console.log('Inicializando sistema de estadísticas del PAC...');
  agregarEstilos();
  inicializarSistema();
});

function explicarDashboardPorVoz() {
  
  if (!('speechSynthesis' in window)) {
    mostrarToast('Tu navegador no soporta la síntesis de voz', '#e74c3c');
    return;
  }
  
  
  window.speechSynthesis.cancel();
  
 
  const anioActual = document.getElementById('selector-anios') ? 
    document.getElementById('selector-anios').value : 
    new Date().getFullYear().toString();
    
  
  const productosCount = document.getElementById('presupuestos-count').textContent;
  const departamentosCount = document.getElementById('departments-count').textContent;
  const itemsCount = document.getElementById('compras-count').textContent;
  
 
  let presupuestoTotal = document.getElementById('total-year').textContent;
  
  presupuestoTotal = presupuestoTotal.replace(/dólares|dolares|usd|\$/gi, '').trim();
  

  const departamentos = [];
  const filasTabla = document.querySelectorAll('#dept-summary-body tr');
  filasTabla.forEach(fila => {
    const celdas = fila.querySelectorAll('td');
    if (celdas.length >= 6) {
      departamentos.push({
        nombre: celdas[0].textContent,
        presupuesto: celdas[1].textContent,
        comprometido: celdas[2].textContent,
        gastado: celdas[3].textContent,
        porcentaje: celdas[4].textContent,
        estado: celdas[5].textContent
      });
    }
  });
  
 
  departamentos.sort((a, b) => {
    const porcA = parseFloat(a.porcentaje);
    const porcB = parseFloat(b.porcentaje);
    return porcB - porcA;
  });
  

  const alertas = document.querySelectorAll('.alert');
  const cantidadAlertas = alertas.length;
  const tiposAlertas = [];
  
  alertas.forEach(alerta => {
    if (alerta.classList.contains('alert-warning')) {
      tiposAlertas.push('advertencia');
    } else if (alerta.classList.contains('alert-success')) {
      tiposAlertas.push('éxito');
    } else if (alerta.classList.contains('alert-info')) {
      tiposAlertas.push('informativa');
    } else if (alerta.classList.contains('alert-danger')) {
      tiposAlertas.push('peligro');
    }
  });
  
   
   let textoExplicacion = `
    Análisis del Dashboard de Estadísticas del Plan Anual de Compras para el año ${anioActual}.
    
    Comenzando con un resumen general, el dashboard muestra que tenemos ${productosCount} productos o servicios únicos
    distribuidos en ${departamentosCount} departamentos, con un total de ${itemsCount} ítems registrados en el PAC.
    El presupuesto total asignado es de ${presupuestoTotal} pesos chilenos.
    
    En cuanto a la ejecución presupuestaria, `;
  
 
  const deptosAltaEjecucion = departamentos.filter(d => parseFloat(d.porcentaje) > 80);
  const deptosBajaEjecucion = departamentos.filter(d => parseFloat(d.porcentaje) < 30);
  const deptosEjecucionNormal = departamentos.filter(d => parseFloat(d.porcentaje) >= 30 && parseFloat(d.porcentaje) <= 80);
  
 
  const formatearPorcentaje = (porcentajeStr) => {
    
    const numero = parseFloat(porcentajeStr.replace(/[^\d.]/g, ''));
    return !isNaN(numero) ? numero.toFixed(1) + '%' : '0%';
  };
  

  if (deptosAltaEjecucion.length > 0) {
   
    deptosAltaEjecucion.sort((a, b) => parseFloat(b.porcentaje) - parseFloat(a.porcentaje));
    
    textoExplicacion += `
      Destaca positivamente que ${deptosAltaEjecucion.length} departamento${deptosAltaEjecucion.length !== 1 ? 's' : ''} 
      presenta${deptosAltaEjecucion.length !== 1 ? 'n' : ''} una ejecución presupuestaria superior al 80%.
    `;
    
   
    if (deptosAltaEjecucion.length === 1) {
      textoExplicacion += `
        El departamento ${deptosAltaEjecucion[0].nombre} lidera con un ${formatearPorcentaje(deptosAltaEjecucion[0].porcentaje)} de ejecución.
      `;
    } else if (deptosAltaEjecucion.length > 1) {
      textoExplicacion += `
        Entre ellos, destacan ${deptosAltaEjecucion[0].nombre} con ${formatearPorcentaje(deptosAltaEjecucion[0].porcentaje)} 
        y ${deptosAltaEjecucion[1].nombre} con ${formatearPorcentaje(deptosAltaEjecucion[1].porcentaje)} 
        de ejecución, demostrando una gestión eficiente de sus recursos.
      `;
    }
  }
  
  
  if (deptosBajaEjecucion.length > 0) {
  
    deptosBajaEjecucion.sort((a, b) => parseFloat(a.porcentaje) - parseFloat(b.porcentaje));
    
    textoExplicacion += `
      ${deptosAltaEjecucion.length > 0 ? 'Sin embargo, ' : ''}${deptosBajaEjecucion.length} 
      departamento${deptosBajaEjecucion.length !== 1 ? 's' : ''} muestra${deptosBajaEjecucion.length !== 1 ? 'n' : ''} 
      una ejecución inferior al 30%, lo que representa un punto de atención urgente.
    `;
    
   
    if (deptosBajaEjecucion.length === 1) {
      textoExplicacion += `
        Específicamente, ${deptosBajaEjecucion[0].nombre} tiene solo un ${formatearPorcentaje(deptosBajaEjecucion[0].porcentaje)} 
        de ejecución, situación que debe ser revisada con prioridad.
      `;
    } else if (deptosBajaEjecucion.length > 1) {
      textoExplicacion += `
        Los casos más críticos son ${deptosBajaEjecucion[0].nombre} con apenas ${formatearPorcentaje(deptosBajaEjecucion[0].porcentaje)} 
        y ${deptosBajaEjecucion[1].nombre} con ${formatearPorcentaje(deptosBajaEjecucion[1].porcentaje)} de ejecución.
        Ambos departamentos requieren atención inmediata para identificar las barreras en sus procesos de compra.
      `;
    }
    
    
    textoExplicacion += `
      Sería recomendable programar reuniones con los responsables de estos departamentos para revisar las causas de esta baja ejecución,
      proporcionar apoyo administrativo en los procesos de compra y, si fuera necesario, evaluar la posibilidad de reasignar 
      recursos que no se utilizarán antes del cierre del período fiscal.
    `;
  }
  

  if (deptosEjecucionNormal.length > 0) {
    textoExplicacion += `
      En cuanto a los ${deptosEjecucionNormal.length} departamentos con ejecución entre 30% y 80%, 
      muestran un avance aceptable pero requieren seguimiento para asegurar que completen su ejecución 
      presupuestaria antes del cierre del período.
    `;
  }
  

  if (cantidadAlertas > 0 && !tiposAlertas.includes('peligro')) {
    textoExplicacion += `
      El sistema muestra ${cantidadAlertas} alertas que requieren atención, principalmente de tipo ${tiposAlertas.join(', ')}.
      ${tiposAlertas.includes('advertencia') ? 'Las alertas de advertencia indican departamentos con baja ejecución presupuestaria que deben ser monitoreados.' : ''}
      ${tiposAlertas.includes('éxito') ? 'Las alertas de éxito indican departamentos con alta ejecución, lo que refleja una buena gestión.' : ''}
      ${tiposAlertas.includes('informativa') ? 'Las alertas informativas muestran diferencias entre presupuesto comprometido y ejecutado que deben ser revisadas.' : ''}
    `;
  } else if (tiposAlertas.includes('peligro')) {
    textoExplicacion += `
      Atención: el sistema muestra alertas de peligro que requieren atención inmediata. 
      Recomiendo revisar los errores indicados y solucionar los problemas técnicos que puedan estar afectando al sistema.
    `;
  } else {
    textoExplicacion += `
      Es positivo mencionar que no se detectan alertas críticas en el sistema en este momento.
    `;
  }
  
  
  textoExplicacion += `
    Analizando la distribución del presupuesto, `;
  
  if (departamentos.length > 0) {
   
    const deptosPorPresupuesto = [...departamentos].sort((a, b) => {
      const presA = parseFloat(a.presupuesto.replace(/[^\d]/g, ''));
      const presB = parseFloat(b.presupuesto.replace(/[^\d]/g, ''));
      return presB - presA;
    });
    
    const deptoMayorPresupuesto = deptosPorPresupuesto[0];
    const porcentajePresupuestoMayor = Math.round((parseFloat(deptoMayorPresupuesto.presupuesto.replace(/[^\d]/g, '')) / 
      parseFloat(presupuestoTotal.replace(/[^\d]/g, ''))) * 100);
    
    textoExplicacion += `
      el departamento ${deptoMayorPresupuesto.nombre} concentra aproximadamente el ${porcentajePresupuestoMayor}% del presupuesto total,
      lo que evidencia su relevancia estratégica dentro de la organización.
    `;
    
    
    const deptosConBrechaAlta = departamentos.filter(d => {
      const comprometido = parseFloat(d.comprometido.replace(/[^\d]/g, ''));
      const gastado = parseFloat(d.gastado.replace(/[^\d]/g, ''));
      return comprometido > 0 && (gastado / comprometido) < 0.5;
    });
    
    if (deptosConBrechaAlta.length > 0) {
      textoExplicacion += `
        Un punto importante a considerar es que ${deptosConBrechaAlta.length} departamentos presentan una brecha significativa
        entre el presupuesto comprometido y el efectivamente gastado. Esto podría indicar procesos de compra en curso
        que deben ser monitoreados para asegurar su finalización antes del cierre del período fiscal.
      `;
    }
  }
  
 
  textoExplicacion += `
    A modo de recomendación general, sugiero:
    
    Primero, realizar seguimiento cercano a los departamentos con ejecución inferior al 30%, identificando barreras 
    en los procesos de compra y ofreciendo apoyo administrativo cuando sea necesario.
    
    Segundo, evaluar la posibilidad de redistribuir recursos desde departamentos con baja ejecución hacia aquellos 
    que están ejecutando eficientemente y podrían requerir recursos adicionales.
    
    Tercero, verificar que los compromisos presupuestarios se materialicen en gastos efectivos, especialmente 
    en aquellos departamentos donde existe una brecha importante entre lo comprometido y lo ejecutado.
    
    Y finalmente, felicitar a los departamentos con alta ejecución, reconociendo su buena gestión administrativa 
    como ejemplo para el resto de la organización.
    
    Este dashboard se actualiza automáticamente cada 5 minutos, por lo que siempre muestra la información más reciente 
    disponible en el sistema.
  `;
  
 
  textoExplicacion = textoExplicacion.replace(/\n\s+/g, ' ').trim();
  
  
  const utterance = new SpeechSynthesisUtterance(textoExplicacion);
  
  
  let voices = window.speechSynthesis.getVoices();
  
 
  if (voices.length === 0) {
    window.speechSynthesis.onvoiceschanged = function() {
      voices = window.speechSynthesis.getVoices();
      configurarYReproducirVoz();
    };
 
    window.speechSynthesis.getVoices();
  } else {
    configurarYReproducirVoz();
  }
  
  function configurarYReproducirVoz() {
    
    const spanishVoice = voices.find(voice => 
      voice.lang.includes('es') && 
      (voice.name.toLowerCase().includes('female') || voice.name.toLowerCase().includes('mujer'))
    ) || voices.find(voice => voice.lang.includes('es'));
    
    
    if (spanishVoice) {
      utterance.voice = spanishVoice;
    }
    
   
    utterance.rate = 0.95; 
    utterance.pitch = 1.0; 
   
    mostrarToast('Explicando el dashboard de estadísticas...', '#3498db');
    
    
    const botonDetenerExistente = document.getElementById('detener-explicacion');
    if (botonDetenerExistente) {
      botonDetenerExistente.remove();
    }
    
    
    const botonDetener = document.createElement('button');
    botonDetener.id = 'detener-explicacion';
    botonDetener.className = 'btn-stop';
    botonDetener.innerHTML = '<i class="fas fa-stop"></i> Detener explicación';
    botonDetener.onclick = function() {
     
      window.speechSynthesis.cancel();
      
      
      this.remove();
      
      
      const botonExplicacion = document.getElementById('btn-explicacion');
      if (botonExplicacion) {
        botonExplicacion.disabled = false;
      }
      
      mostrarToast('Explicación detenida', '#e74c3c');
    };
    
   
    document.querySelector('.dashboard-header') ? 
      document.querySelector('.dashboard-header').appendChild(botonDetener) : 
      document.body.appendChild(botonDetener);
    
    
    utterance.onstart = () => {
      
      const botonExplicacion = document.getElementById('btn-explicacion');
      if (botonExplicacion) {
        botonExplicacion.disabled = true;
      }
    };
    
    utterance.onend = () => {
      
      const botonExplicacion = document.getElementById('btn-explicacion');
      if (botonExplicacion) {
        botonExplicacion.disabled = false;
      }
      
     
      const botonDetener = document.getElementById('detener-explicacion');
      if (botonDetener) {
        botonDetener.remove();
      }
      
      mostrarToast('Explicación completada', '#2ecc71');
    };
    
  
    utterance.onerror = (event) => {
      console.error('Error en la síntesis de voz:', event);
      
     
      const botonExplicacion = document.getElementById('btn-explicacion');
      if (botonExplicacion) {
        botonExplicacion.disabled = false;
      }
      
      
      const botonDetener = document.getElementById('detener-explicacion');
      if (botonDetener) {
        botonDetener.remove();
      }
      
      mostrarToast('Error al reproducir la explicación', '#e74c3c');
    };
    
    
    try {
      window.speechSynthesis.speak(utterance);
    } catch (error) {
      console.error('Error al iniciar la síntesis de voz:', error);
      mostrarToast('Error al iniciar la explicación', '#e74c3c');
      
      
      const botonExplicacion = document.getElementById('btn-explicacion');
      if (botonExplicacion) {
        botonExplicacion.disabled = false;
      }
    }
  }
}


function mostrarToast(mensaje, color) {
  
  const toastExistente = document.getElementById('toast-mensaje');
  if (toastExistente) toastExistente.remove();
  
  
  const toast = document.createElement('div');
  toast.id = 'toast-mensaje';
  toast.className = 'toast-mensaje';
  toast.textContent = mensaje;
  toast.style.backgroundColor = color || '#333';
  
  
  toast.style.position = 'fixed';
  toast.style.bottom = '20px';
  toast.style.right = '20px';
  toast.style.padding = '12px 20px';
  toast.style.borderRadius = '4px';
  toast.style.color = 'white';
  toast.style.zIndex = '9999';
  toast.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
  toast.style.transition = 'opacity 0.5s ease-in-out';
  
  
  document.body.appendChild(toast);
  
 
  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => toast.remove(), 500);
  }, 5000);
}


function agregarBotonExplicacionPorVoz() {
  
  const botonExistente = document.getElementById('btn-explicacion');
  if (botonExistente) {
    botonExistente.remove();
  }
  
 
  const botonExplicacion = document.createElement('button');
  botonExplicacion.id = 'btn-explicacion';
  botonExplicacion.innerHTML = '<i class="fas fa-volume-up"></i> Explicar Dashboard';
  botonExplicacion.title = 'Escuchar explicación detallada del dashboard';
  
 
  botonExplicacion.style.backgroundColor = '#3498db';
  botonExplicacion.style.color = 'white';
  botonExplicacion.style.border = 'none';
  botonExplicacion.style.borderRadius = '4px';
  botonExplicacion.style.padding = '8px 15px';
  botonExplicacion.style.margin = '5px';
  botonExplicacion.style.cursor = 'pointer';
  botonExplicacion.style.fontSize = '14px';
  botonExplicacion.style.fontWeight = 'bold';
  botonExplicacion.style.display = 'flex';
  botonExplicacion.style.alignItems = 'center';
  botonExplicacion.style.justifyContent = 'center';
  botonExplicacion.style.gap = '5px';
  
 
  botonExplicacion.onmouseover = function() {
    this.style.backgroundColor = '#2980b9';
  };
  botonExplicacion.onmouseout = function() {
    this.style.backgroundColor = '#3498db';
  };
  
  botonExplicacion.onclick = explicarDashboardPorVoz;
  
  
  const dashboardHeader = document.querySelector('.dashboard-header');
  if (dashboardHeader) {

    const selectorContainer = document.querySelector('.year-selector-container');
    if (selectorContainer) {
      dashboardHeader.insertBefore(botonExplicacion, selectorContainer.nextSibling);
    } else {
    
      const backButton = dashboardHeader.querySelector('.back-button');
      if (backButton) {
        dashboardHeader.insertBefore(botonExplicacion, backButton);
      } else {
       
        dashboardHeader.appendChild(botonExplicacion);
      }
    }
  } else {
   
    const statsContainer = document.querySelector('.stats-container');
    if (statsContainer) {
      statsContainer.parentNode.insertBefore(botonExplicacion, statsContainer);
    } else {
      
      document.body.appendChild(botonExplicacion);
    }
  }

  if (!document.querySelector('link[href*="font-awesome"]')) {
    const fontAwesome = document.createElement('link');
    fontAwesome.rel = 'stylesheet';
    fontAwesome.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css';
    document.head.appendChild(fontAwesome);
  }
}

function agregarEstilosVoz() {

  const estilosExistentes = document.getElementById('estilos-voz');
  if (estilosExistentes) {
    estilosExistentes.remove();
  }
  
  const estilos = document.createElement('style');
  estilos.id = 'estilos-voz';
  estilos.textContent = `
    .btn-stop {
      background-color: #e74c3c;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 15px;
      margin: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      transition: background-color 0.3s;
    }
    
    .btn-stop:hover {
      background-color: #c0392b;
    }
    
    #btn-explicacion:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }
    
    .toast-mensaje {
      opacity: 1;
      transition: opacity 0.5s ease-in-out;
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  `;
  
  document.head.appendChild(estilos);
}


function verificarYReiniciarSistemaVoz() {
  
  if (window.speechSynthesis) {
    window.speechSynthesis.cancel();
  }
  

  const botonDetener = document.getElementById('detener-explicacion');
  if (botonDetener) {
    botonDetener.remove();
  }
  
 
  const botonExplicacion = document.getElementById('btn-explicacion');
  if (botonExplicacion) {
    botonExplicacion.disabled = false;
  } else {
    
    agregarBotonExplicacionPorVoz();
  }
}

document.addEventListener('DOMContentLoaded', function() {

  setTimeout(function() {
    agregarEstilosVoz();
    agregarBotonExplicacionPorVoz();
    verificarYReiniciarSistemaVoz();
    

    if ('speechSynthesis' in window) {
      window.speechSynthesis.getVoices();
    }
    
    
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        if (window.speechSynthesis) {
          window.speechSynthesis.cancel();
          mostrarToast('Explicación detenida', '#e74c3c');
          verificarYReiniciarSistemaVoz();
        }
      }
    });
  }, 1000);
  
 
  document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible') {
      verificarYReiniciarSistemaVoz();
    }
  });
});
        </script>
</body>
</html>