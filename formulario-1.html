<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Presupuesto Municipal | Municipalidad de Arica</title>
    <script src="dir_formularioapps.js"></script>
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        body {
            background-color: #f5f5f7;
            color: #1d1d1f;
            overflow-x: hidden;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
            /* Header styles */
header {
  background-color: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  transition: all 0.4s ease;
}

.top-header {
  display: flex;
  justify-content: center; /* Centramos horizontalmente */
  align-items: center;
  padding: 15px 5%;
  max-width: 1400px;
  margin: 0 auto;
  text-align: center;
}

.logo {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.logo img {
  height: 40px;
  transition: transform 0.3s ease;
}

.logo:hover img {
  transform: scale(1.05);
}

.logo-text {
  display: flex;
  flex-direction: column;
  align-items: center; /* Centra el texto debajo del logo */
  margin-left: 0;
}

.logo-text h1 {
  font-size: 24px;
  font-weight: 600;
  letter-spacing: -0.5px;
}

.logo-text span {
  font-size: 12px;
  font-weight: 400;
  color: #86868b;
}
        
        /* Transparency links */
        .transparency-container {
            position: relative;
            background-color: rgba(0, 0, 0, 0.03);
            text-align: center;
        }
        
        .transparency-toggle {
            display: none;
            background-color: rgba(0, 0, 0, 0.03);
            border: none;
            color: #06c;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            text-align: center;
            transition: background-color 0.3s ease;
        }
        
        .transparency-toggle:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .toggle-icon {
            display: inline-block;
            margin-left: 8px;
            transition: transform 0.3s ease;
        }
        
        .transparency-links {
            background-color: rgba(0, 0, 0, 0.03);
            display: flex;
            justify-content: center;
            padding: 10px 0;
            overflow-x: auto;
            white-space: nowrap;
            transition: max-height 0.4s ease;
        }
        
        .transparency-links a {
            color: #06c;
            text-decoration: none;
            margin: 0 15px;
            font-size: 14px;
            font-weight: 400;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .transparency-links a:hover {
            opacity: 0.7;
            transform: translateY(-1px);
        }
        
        /* Navigation menu */
        nav {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 1px 0 rgba(0, 0, 0, 0.05);
        }
        
        .main-menu {
            display: flex;
            list-style: none;
            justify-content: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 5%;
            overflow-x: auto;
        }
        
        .main-menu li {
            position: relative;
        }
        
        .main-menu a {
            display: block;
            padding: 15px 20px;
            color: #1d1d1f;
            text-decoration: none;
            font-weight: 400;
            font-size: 14px;
            transition: color 0.3s ease;
            position: relative;
        }
        
        .main-menu a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) scaleX(0);
            width: 20px;
            height: 2px;
            background-color: #06c;
            transition: transform 0.3s ease;
        }
        
        .main-menu a:hover {
            color: #06c;
        }
        
        .main-menu a:hover::after {
            transform: translateX(-50%) scaleX(1);
        }
        
         /* Dashboard container */
         .dashboard-container {
            padding: 40px 5%;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }
        
        .dashboard-title {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: #1d2939;
            position: relative;
        }
        
        .dashboard-title:after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 0;
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, #0066cc, #1a8cff);
            border-radius: 2px;
        }
        
        .back-button {
            display: flex;
            align-items: center;
            background-color: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 100px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            color: #0066cc;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .back-button:hover {
            background-color: #f5f9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.15);
        }
        
        .back-icon {
            margin-right: 8px;
        }
        
        /* Card Grid System */
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
            margin: 40px 0;
        }
        
        .card {
          flex: 0 1 calc(50% - 20px); /* dos tarjetas por fila, restando el gap */
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
            transition: all 0.4s ease;
            position: relative;
            z-index: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #0066cc, #1a8cff);
            z-index: 2;
        }
        
        .card-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #f0f7ff, #e6f2ff);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 25px auto 15px;
            color: #0066cc;
            font-size: 24px;
            transition: all 0.3s ease;
        }
        
        .card:hover .card-icon {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 5px 15px rgba(0, 102, 204, 0.15);
        }
        
        .card-title {
            font-size: 22px;
            font-weight: 600;
            text-align: center;
            margin: 10px 0;
            color: #1d2939;
            padding: 0 20px;
        }
        
        .card-description {
            text-align: center;
            padding: 0 25px;
            color: #64748b;
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 25px;
            flex-grow: 1;
        }
        
        .card-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            background: linear-gradient(135deg, #0066cc, #1a8cff);
            border: none;
            border-radius: 100px;
            text-decoration: none;
            transition: all 0.3s ease;
            margin: 0 auto 25px;
            box-shadow: 0 5px 15px rgba(0, 102, 204, 0.2);
        }
        
        .card-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 102, 204, 0.3);
            background: linear-gradient(135deg, #005cb8, #0080ff);
        }
        
        .card-button .arrow {
            margin-left: 8px;
            transition: transform 0.3s ease;
        }
        
        .card-button:hover .arrow {
            transform: translateX(4px);
        }
        
        /* Stats counter section */
        .stats-section {
            background: linear-gradient(135deg, #ffffff, #f5f9ff);
            border-radius: 16px;
            padding: 40px;
            margin: 50px 0 40px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.04);
        }
        
        .stats-title {
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 30px;
            color: #1d2939;
        }
        
        .stats-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 0 20px;
            min-width: 220px;
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #0066cc, #1a8cff);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-label {
            color: #64748b;
            font-size: 16px;
        }
        
        /* Footer */
        footer {
            background-color: #f5f5f7;
            color: #1d1d1f;
            padding: 60px 5%;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            margin-top: 60px;
        }
        
        .footer-container {
            display: flex;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .footer-column {
            flex: 1;
            padding: 0 20px;
        }
        
        .footer-column h3 {
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }
        
        .footer-column p {
            margin-bottom: 10px;
            color: #86868b;
            font-size: 14px;
        }
        
        .footer-column ul {
            list-style: none;
        }
        
        .footer-column ul li {
            margin-bottom: 12px;
        }
        
        .footer-column a {
            color: #06c;
            text-decoration: none;
            font-size: 14px;
            transition: opacity 0.3s ease;
        }
        
        .footer-column a:hover {
            opacity: 0.7;
        }
        
        .social-icons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .social-icons a {
            background-color: rgba(0, 0, 0, 0.05);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: transform 0.3s ease, background-color 0.3s ease;
        }
        
        .social-icons a:hover {
            transform: translateY(-3px);
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        .footer-bottom {
            max-width: 1400px;
            margin: 40px auto 0;
            padding-top: 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            text-align: center;
            font-size: 12px;
            color: #86868b;
        }
        
        /* Assistant chat button */
        .assistant-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: rgba(6, 12, 204, 0.9);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 100;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .assistant-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        /* Responsive design */
        @media (max-width: 992px) {
            .footer-container {
                flex-direction: column;
            }
            
            .footer-column {
                margin-bottom: 40px;
            }
            
            .dashboard-iframe {
                height: 65vh;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-title {
                font-size: 24px;
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .dashboard-iframe {
                height: 50vh;
            }
            
            .transparency-toggle {
                display: block;
            }
            
            .transparency-toggle.active .toggle-icon {
                transform: rotate(180deg);
            }
            
            .transparency-links {
                max-height: 0;
                padding: 0;
                overflow: hidden;
                flex-direction: column;
            }
            
            .transparency-links.active {
                max-height: 200px;
                padding: 10px 0;
            }
            
            .transparency-links a {
                margin: 8px 0;
                padding: 5px 0;
            }
        }
        .custom-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 12px 28px;
    font-size: 16px;
    font-weight: 600;
    color: #fff;
    background: linear-gradient(135deg, #ff6a00, #ee0979);
    border: none;
    border-radius: 999px;
    box-shadow: 0 8px 20px rgba(255, 105, 135, 0.3);
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .custom-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(255, 105, 135, 0.5);
    background: linear-gradient(135deg, #ee0979, #ff6a00);
  }

  .arrow {
    margin-left: 10px;
    font-size: 18px;
    transition: transform 0.3s ease;
  }

  .custom-btn:hover .arrow {
    transform: translateX(4px);
  }
  /* Estilo para el contenedor de imagen circular */
  .card-icon-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-color: #f5f5f5;
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0 auto 15px; /* A침ade margen autom치tico a los lados */
    overflow: hidden; /* Asegura que la imagen no sobresalga del c칤rculo */
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  /* Estilo para la imagen dentro del c칤rculo */
  .card-icon-circle img {
    width: 80%; /* Un poco menor que el contenedor para dejar margen */
    height: 80%;
    object-fit: cover; /* Cubre el 치rea del c칤rculo */
    border-radius: 50%; /* Hace que la imagen tambi칠n sea circular */
  }
  
  .card-title {
    font-size: 1.5rem;
    color: #333;
    margin-bottom: 10px;
    text-align: center;
  }
  
  .card-description {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 20px;
    text-align: center;
    flex-grow: 1;
  }
  
  .card-button:hover {
    background-color: #0b7dda;
  }
  
  .arrow {
    margin-left: 8px;
    transition: transform 0.3s;
  }
  
  .card-button:hover .arrow {
    transform: translateX(5px);
  }
  
  /* Estilos responsive */
  @media (max-width: 768px) {
    .card {
      max-width: 100%;
    }
  }
  /* Variaci칩n 1: C칤rculo con borde de color */
.card-icon-circle-border {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background-color: white;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 15px;
  overflow: hidden;
  border: 3px solid #2196F3; /* Borde azul que coincide con el bot칩n */
}

/* Variaci칩n 2: C칤rculo con fondo de color */
.card-icon-circle-colored {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background-color: #2196F3; /* Fondo azul que coincide con el bot칩n */
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 15px;
  overflow: hidden;
}

.card-icon-circle-colored img {
  width: 60%;
  height: 60%;
  object-fit: contain;
  filter: brightness(0) invert(1); /* Hace la imagen blanca */
}

/* Variaci칩n 3: C칤rculo con efecto de sombra interna */
.card-icon-circle-shadow {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background-color: #f5f5f5;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 15px;
  overflow: hidden;
  box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
}

/* Variaci칩n 4: C칤rculo con efecto de resplandor */
.card-icon-circle-glow {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background-color: white;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 15px;
  overflow: hidden;
  box-shadow: 0 0 15px rgba(33, 150, 243, 0.5); /* Resplandor azul */
}
/* Estilos para la secci칩n de estad칤sticas */
.stats-section {
      margin-top: 30px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 20px;
    }
    
    .stats-title {
      color: #333;
      margin-bottom: 20px;
      text-align: center;
      font-size: 1.4em;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    
    .stats-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .stat-item {
      text-align: center;
      flex: 1;
      min-width: 150px;
      background-color: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }
    
    .stat-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    
    .stat-number {
      font-size: 2em;
      font-weight: bold;
      color: #2196F3;
      margin-bottom: 5px;
    }
    
    .stat-label {
      color: #555;
      font-size: 0.9em;
    }
    
    /* Estilos para las alertas */
    .alerts-container {
      margin-top: 20px;
    }
    
    .alert {
      padding: 12px 15px;
      margin-bottom: 15px;
      border-left: 5px solid;
      border-radius: 5px;
      font-size: 14px;
      display: flex;
      align-items: center;
    }
    
    .alert-icon {
      margin-right: 15px;
      width: 24px;
      height: 24px;
      flex-shrink: 0;
    }
    
    .alert-danger {
      background-color: #ffebee;
      border-color: #f44336;
      color: #d32f2f;
    }
    
    .alert-warning {
      background-color: #fff8e1;
      border-color: #ffc107;
      color: #ff8f00;
    }
    
    .alert-info {
      background-color: #e3f2fd;
      border-color: #2196F3;
      color: #0d47a1;
    }
    
    .alert-success {
      background-color: #e8f5e9;
      border-color: #4CAF50;
      color: #2e7d32;
    }
    
   /* Mejora responsividad de los gr치ficos */
.charts-container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-top: 30px;
  width: 100%;
}

.chart-container {
  flex: 1;
  min-width: 300px;
  height: 300px;
  background-color: #f9f9f9;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  position: relative;
  overflow: hidden; /* Importante: evita desbordamiento */
}

@media (max-width: 768px) {
  .charts-container {
    flex-direction: column;
  }
  
  .chart-container {
    width: 100%;
    min-width: 0; /* Elimina el min-width en m칩vil */
    height: 250px; /* Altura reducida para m칩vil */
    margin-bottom: 20px;
  }
}
    
    /* Estilos para la tabla de resumen */
    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }
    
    .summary-table th,
    .summary-table td {
      border: 1px solid #ddd;
      padding: 8px 12px;
      text-align: left;
    }
    
    .summary-table th {
      background-color: #f2f2f2;
      color: #333;
    }
    
    .summary-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    .progress-container {
      width: 100%;
      background-color: #e0e0e0;
      border-radius: 4px;
      height: 8px;
      margin-top: 5px;
    }
    
    .progress-bar {
      height: 100%;
      border-radius: 4px;
      background-color: #4CAF50;
    }
    
    .progress-bar-warning {
      background-color: #FFC107;
    }
    
    .progress-bar-danger {
      background-color: #F44336;
    }
    
    /* Responsive */
    @media screen and (max-width: 768px) {
      .stats-container {
        flex-direction: column;
      }
      
      .chart-container {
        min-width: 100%;
      }
    }
    </style>
</head>
<body>
    <!-- Header with logo and search -->
            <div class="top-header">
                <div class="logo">
                    <img src="logo_MUNI.png" alt="Logo Municipalidad de Arica">
                    <div class="logo-text">
                        <h1>ARICA</h1>
                        <span>MUNICIPALIDAD | mejor ciudad</span>
                    </div>
                </div>
            </div>
    


    </section>
     <!-- Dashboard section -->
     <section class="dashboard-container">
        <div class="dashboard-header">
            <h2 class="dashboard-title">Sistema de Gesti칩n de Presupuestos</h2>
            <button class="back-button" onclick="window.location.href='index.html'">
                <span class="back-icon"><i class="fas fa-arrow-left"></i></span> Volver al Inicio
            </button>
        </div>

        <!-- Cards for forms selection -->
        <div class="cards-container">
            <!-- Card 1 -->
            <div class="card">
                <div class="card-icon-circle">
                    <img src="Presupuesto-Ingresos.webp" alt="Icono de Presupuesto">
                  </div>
                <h3 class="card-title">Ingreso de Compras</h3>
                <p class="card-description">
                    Complete el formulario para registrar un nuevo presupuesto anual de compra para su departamento o 치rea municipal.
                </p>
                <a href="Formulario_agregar_compra.html" class="card-button">
                    Acceder <span class="arrow"><i class="fas fa-arrow-right"></i></span>
                </a>
            </div>
            
            <!-- Card 2 -->
            <div class="card">
                <div class="card-icon-circle">
                    <img src="exceeel" alt="Icono de Presupuesto">
                  </div>
                <h3 class="card-title">Explorador de Compras</h3>
                <p class="card-description">
                    Consulte y analice los presupuestos ingresados, con opciones para filtrar por departamento, per칤odo y estado.
                </p>
                <a href="exportador_datos.html" class="card-button">
                    Acceder <span class="arrow"><i class="fas fa-arrow-right"></i></span>
                </a>
            </div>
            
            <!-- Card 3 -->
            <div class="card">
                <div class="card-icon-circle">
                    <img src="imagenpac.jpeg" alt="Icono de Presupuesto">
                  </div>
                <h3 class="card-title">Ingreso de PAC</h3>
                <p class="card-description">
                  Complete el formulario para registrar los Presupuesto Anual de Compras para su departamento o 치rea municipal.
                </p>
                <a href="ingreso_PAC.html" class="card-button">
                    Acceder <span class="arrow"><i class="fas fa-arrow-right"></i></span>
                </a>
            </div>
            <!-- Card 4 -->
            <div class="card">
              <div class="card-icon-circle">
                  <img src="exceeel" alt="Icono de Presupuesto">
                </div>
              <h3 class="card-title">Explorador de PAC</h3>
              <p class="card-description">
                Consulte y analice los Presupuesto Anual de Compras, con opciones para filtrar por departamento, per칤odo y estado.
              </p>
              <a href="exportador_de_datos_PAC.html" class="card-button">
                  Acceder <span class="arrow"><i class="fas fa-arrow-right"></i></span>
              </a>
          </div>
        </div>
        
        <!-- Stats section -->
        <div class="stats-section">
            <h3 class="stats-title">Estad칤sticas del Sistema</h3>
            
            <!-- Indicadores principales -->
            <div class="stats-container">
              <div class="stat-item">
                <div class="stat-number" id="presupuestos-count">0</div>
                <div class="stat-label">Presupuestos Activos</div>
              </div>
              <div class="stat-item">
                <div class="stat-number" id="departments-count">0</div>
                <div class="stat-label">Departamentos</div>
              </div>
              <div class="stat-item">
                <div class="stat-number" id="compras-count">0</div>
                <div class="stat-label">Compras Registradas</div>
              </div>
              <div class="stat-item">
                <div class="stat-number" id="total-year">$0</div>
                <div class="stat-label">Total Comprometido</div>
              </div>
            </div>
            
            <!-- Alertas del sistema -->
            <div class="alerts-container" id="alerts-container">
              <!-- Las alertas se generar치n din치micamente -->
            </div>
            
            <!-- Tabla de resumen por departamento -->
            <h4 class="stats-title">Resumen por Departamento</h4>
            <div style="overflow-x: auto;">
              <table class="summary-table" id="dept-summary-table">
                <thead>
                  <tr>
                    <th>Departamento</th>
                    <th>Presupuesto Anual</th>
                    <th>Comprometido</th>
                    <th>Gastado</th>
                    <th>% Ejecuci칩n</th>
                    <th>Estado</th>
                   
                  </tr>
                </thead>
                <tbody id="dept-summary-body">
                  <!-- Se llenar치 din치micamente -->
                </tbody>
              </table>
            </div>
            
            <!-- Gr치ficos de estad칤sticas -->
            <div class="charts-container">
              <div class="chart-container">
                <h4 class="chart-title">Distribuci칩n de Saldo Comprometido por Departamento</h4>
                <canvas id="departmentChart"></canvas>
              </div>
              <div class="chart-container">
                <h4 class="chart-title">Ejecuci칩n Presupuestaria Mensual</h4>
                <canvas id="monthlyChart"></canvas>
              </div>
            </div>
          </div>
    </section>
    
     <!-- Footer -->
     <footer>
        <div class="footer-container">
            <div class="footer-column">
                <h3>Municipalidad de Arica</h3>
                <p>Renato Rocca , Arica</p>
                <p>Anexo:6959 </p>
                <p>Email:roberto.mamani@municipalidadarica.cl </p>
                <div class="social-icons">
                    <a href="#">游닂</a>
                    <a href="#">游님</a>
                    <a href="#">游냕</a>
                    <a href="#">游닞</a>
                </div>
            </div>
            <div class="footer-column">
                <h3>Colaboraci칩n Interdepartamental</h3>
                <p style="line-height: 1.6;">
                    Este proyecto surge con el prop칩sito de fortalecer la colaboraci칩n entre diversas 치reas municipales, como <strong>iluminaci칩n p칰blica</strong>, <strong>Of. Mantenimiento de Veh칤culos y Maquinaria</strong>, <strong>Aseo y Ornato</strong>, <strong>Asesor칤a Tecnica </strong> y m치s, en un solo sistema integral. 
                    Buscando consolidar la informaci칩n y los procesos en un solo sistema, permitiendo un <strong>mayor control operativo</strong>, <strong>gesti칩n por 치reas</strong> y una visi칩n integral para la <strong>mejora continua de los servicios municipales</strong>.
                </p>
            </div>
            <div class="footer-column licitaciones">
              <h3>Licitaciones</h3>
              <ul class="licitaciones-list">
                  <li><a href="licitacion_agil.html">Licitaci칩n 츼gil</a></li>
                  <li><a href="licitacion_gran_compra.html">Gran Compra</a></li>
                  <li><a href="licitacion_trato_directo.html">Trato Directo</a></li>
                  <li><a href="licitacion_publica.html">Licitaci칩n P칰blica</a></li>
                  <li><a href="licitacion_convenio_marco.html">Convenio Marco</a></li>
              </ul>
          </div>
        </div>
        <div class="footer-bottom">
            <p>춸 2025 Municipalidad de Arica. Todos los derechos reservados.</p
            <p> Desarrollado por Junior Barrera</p
        </div>
    </footer>
    <!-- Assistance button -->
    <div class="assistant-button" onclick="openAssistance()">游눫</div>
    
    <script>
        // Funci칩n para ocultar indicador de carga cuando el iframe se carga
        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }
        
        // Funci칩n para manejar errores de carga del iframe
        function handleIframeError() {
            const iframe = document.getElementById('dashboardIframe');
            
            // Verificar si el iframe se carg칩 correctamente despu칠s de 10 segundos
            setTimeout(function() {
                try {
                    // Intentar acceder al contenido del iframe
                    const iframeContent = iframe.contentWindow || iframe.contentDocument;
                    if (!iframeContent) {
                        // Si no hay contenido, mostrar mensaje de error
                        showFallbackMessage();
                    }
                } catch (e) {
                    // Si hay un error al acceder al contenido, mostrar mensaje
                    showFallbackMessage();
                }
            }, 10000);
        }
        
        // Mostrar mensaje alternativo si el dashboard no carga
        function showFallbackMessage() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <h3 style="margin-bottom: 15px;">No se pudo cargar el dashboard</h3>
                    <p style="margin-bottom: 20px;">Parece que hay un problema al cargar el dashboard. Por favor, intenta:</p>
                    <a href="https://lookerstudio.google.com/reporting/da465897-8e1a-4d06-9f8e-27d84a749431" 
                       target="_blank" 
                       style="display: inline-block; background-color: #06c; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none;">
                        Ver dashboard en Looker Studio
                    </a>
                </div>
            `;
            loadingIndicator.style.display = 'flex';
        }
        
        // Funci칩n para abrir asistencia via WhatsApp
        function openAssistance() {
            // Reemplaza con tu n칰mero real para WhatsApp (formato internacional sin +)
            const phoneNumber = "56959414178"; // Reemplaza con tu n칰mero real
            window.open(`https://wa.me/${phoneNumber}`, '_blank');
        }
        
        // C칩digo para el men칰 de transparencia
        document.addEventListener('DOMContentLoaded', function() {
            const transparencyToggle = document.querySelector('.transparency-toggle');
            const transparencyLinks = document.querySelector('.transparency-links');
            
            if (transparencyToggle && transparencyLinks) {
                transparencyToggle.addEventListener('click', function() {
                    transparencyToggle.classList.toggle('active');
                    transparencyLinks.classList.toggle('active');
                });
                
                // Inicializar estado del men칰 seg칰n ancho de pantalla
                function checkScreenWidth() {
                    if (window.innerWidth <= 768) {
                        transparencyLinks.classList.remove('active');
                    } else {
                        transparencyLinks.classList.add('active');
                    }
                }
                
                // Verificar al cargar y redimensionar
                checkScreenWidth();
                window.addEventListener('resize', checkScreenWidth);
            }
            
            // Efecto de scroll en el header
            const header = document.querySelector('header');
            
            window.addEventListener('scroll', () => {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                if (scrollTop > 100) {
                    header.style.boxShadow = '0 5px 20px rgba(0, 0, 0, 0.1)';
                } else {
                    header.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.05)';
                }
            });
            
            // Iniciar verificaci칩n de carga del iframe
            handleIframeError();
        });
    </script>
  
    <script>// Constante de conexi칩n - misma URL que en exportador_datos.html
      const WEB_APP_URL = dir_pac;
      
      // Variables para almacenar los datos
      let dat_PAC = [];  // Datos de la hoja "PAC"
      let chartInstancesDep = null;
      let chartInstancesMonthly = null;
      let aniosDisponibles = []; // Para almacenar los a침os disponibles en los datos
      let anioSeleccionado = new Date().getFullYear().toString(); // Por defecto, a침o actual
      
      // Funci칩n para formatear n칰meros con puntos como separador de miles
      function formatearNumero(valor) {
        if (valor === null || valor === undefined) return "0";
        // Asegurarse de que valor sea un string para manipularlo
        let valor2 = valor.toString().replace(/\./g, '').replace(/\D/g, '');
        // Convertir a n칰mero y formatear con puntos
        let numeroFormateado = new Intl.NumberFormat('es-ES').format(parseInt(valor2) || 0);
        return numeroFormateado;
      }
      
      // Funci칩n para mostrar mensajes de error en los contadores
      function mostrarErrorEnContadores(mensaje) {
        document.getElementById('presupuestos-count').textContent = 'Error';
        document.getElementById('departments-count').textContent = 'Error';
        document.getElementById('compras-count').textContent = 'Error';
        document.getElementById('total-year').textContent = 'Error';
        
        // Agregar mensaje de error en el contenedor de alertas
        const alertasContainer = document.getElementById('alerts-container');
        alertasContainer.innerHTML = `
          <div class="alert alert-danger">
            <strong>Error:</strong> ${mensaje || 'No se pudieron cargar los datos. Intente recargar la p치gina.'}
          </div>
        `;
        
        console.error(mensaje || 'Error al cargar datos');
      }
      
      // Funci칩n para crear el selector de a침os
      function crearSelectorAnios() {
        // Obtener a침os 칰nicos de los datos
        aniosDisponibles = Array.from(new Set(dat_PAC
          .filter(fila => fila && fila[0]) // Filtrar filas v치lidas
          .map(fila => fila[0].toString()))); // Obtener el a침o (primera columna)
        
        // Ordenar los a침os de m치s reciente a m치s antiguo
        aniosDisponibles.sort((a, b) => b - a);
        
        // Si el a침o actual no est치 en los datos, usar el a침o m치s reciente
        if (!aniosDisponibles.includes(anioSeleccionado) && aniosDisponibles.length > 0) {
          anioSeleccionado = aniosDisponibles[0];
        }
        
        // Crear o actualizar el selector de a침os
        const dashboardHeader = document.querySelector('.dashboard-header');
        let selectorAnios = document.getElementById('selector-anios');
        
        if (!selectorAnios) {
          // Crear el selector si no existe
          const selectorContainer = document.createElement('div');
          selectorContainer.className = 'year-selector-container';
          selectorContainer.innerHTML = `
            <label for="selector-anios">A침o: </label>
            <select id="selector-anios" class="year-selector"></select>
          `;
          
          // Insertar despu칠s del t칤tulo pero antes del bot칩n de volver
          dashboardHeader.insertBefore(selectorContainer, dashboardHeader.querySelector('.back-button'));
          selectorAnios = document.getElementById('selector-anios');
          
          // Agregar event listener para cambios
          selectorAnios.addEventListener('change', function() {
            anioSeleccionado = this.value;
            actualizarEstadisticas();
            generarAlertas();
            actualizarTablaDepartamentos();
            crearGraficos();
          });
        }
        
        // Limpiar y llenar el selector
        selectorAnios.innerHTML = '';
        aniosDisponibles.forEach(anio => {
          const option = document.createElement('option');
          option.value = anio;
          option.textContent = anio;
          option.selected = anio === anioSeleccionado;
          selectorAnios.appendChild(option);
        });
        
        // Actualizar el t칤tulo para mostrar el a침o seleccionado
        const statsTitle = document.querySelector('.stats-title');
        if (statsTitle) {
          statsTitle.textContent = `Estad칤sticas del Sistema (${anioSeleccionado})`;
        }
      }
      
// Funci칩n para cargar los datos desde la API
function cargarDatosEstadisticas() {
  // Mostrar animaci칩n de carga
  document.getElementById('presupuestos-count').innerHTML = '<div class="loading-spinner"></div>';
  document.getElementById('departments-count').innerHTML = '<div class="loading-spinner"></div>';
  document.getElementById('compras-count').innerHTML = '<div class="loading-spinner"></div>';
  document.getElementById('total-year').innerHTML = '<div class="loading-spinner"></div>';
  
  // Obtener los datos con manejo de errores mejorado
  fetch(WEB_APP_URL)
    .then(response => {
      if (!response.ok) {
        throw new Error(`Error de red: ${response.status} ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('Datos recibidos:', data); // Depuraci칩n
      
      // Verificar que los datos tengan la estructura esperada
      if (!data || typeof data !== 'object') {
        throw new Error('Formato de datos inesperado');
      }
      
      // Asignar solo los datos del PAC
      dat_PAC = Array.isArray(data.dat_PAC) ? data.dat_PAC : [];
      
      // Verificar que tenemos al menos los datos del PAC
      if (dat_PAC.length === 0) {
        throw new Error('No se recibieron datos del PAC');
      }
      
      // Actualizar las estad칤sticas
      actualizarEstadisticas();
      
      // Generar alertas del sistema
      generarAlertas();
      
      // Actualizar tabla de resumen por departamento
      actualizarTablaDepartamentos();
      
      // Crear gr치ficos solo si Chart.js est치 disponible
      if (typeof Chart !== 'undefined') {
        crearGraficos();
      } else {
        console.warn('Chart.js no est치 disponible. Los gr치ficos no se mostrar치n.');
      }
    })
    .catch(error => {
      console.error('Error al obtener los datos:', error);
      mostrarErrorEnContadores(error.message);
    });
}
// Funci칩n para actualizar las estad칤sticas principales basadas en el PAC
function actualizarEstadisticas() {
  try {
    const anioActual = new Date().getFullYear().toString();
    
    // Filtrar datos del a침o actual con verificaci칩n
    const datosAnioActual = dat_PAC.filter(fila => 
      fila && Array.isArray(fila) && fila[0] && fila[0].toString() === anioActual
    );
    
    // Contar productos/servicios 칰nicos en el PAC
    const productosUnicos = new Set();
    datosAnioActual.forEach(fila => {
      if (fila && fila[4]) productosUnicos.add(fila[4].toString().trim().toUpperCase());
    });
    
    // Contar departamentos 칰nicos en el PAC
    const departamentosUnicos = new Set();
    datosAnioActual.forEach(fila => {
      if (fila && fila[1]) departamentosUnicos.add(fila[1].toString().trim().toUpperCase());
    });
    
    // Contar 칤tems registrados en el PAC
    const itemsRegistrados = datosAnioActual.length;
    
    // Calcular total del presupuesto anual (columna Total 칈tem - 칤ndice 7, que corresponde a la columna 8)
    let totalPresupuestoAnual = 0;
    datosAnioActual.forEach(fila => {
      if (fila && fila[7]) {  // 칈ndice 7 = columna 8 (Total 칈tem)
        // Convertir el valor a n칰mero
        const valor = fila[7].toString().replace(/\./g, '').replace(/\D/g, '');
        totalPresupuestoAnual += parseInt(valor) || 0;
      }
    });
    
    // Actualizar los elementos HTML
    document.getElementById('presupuestos-count').textContent = productosUnicos.size;
    document.getElementById('departments-count').textContent = departamentosUnicos.size;
    document.getElementById('compras-count').textContent = itemsRegistrados;
    document.getElementById('total-year').textContent = '$' + formatearNumero(totalPresupuestoAnual);
  } catch (error) {
    console.error('Error al actualizar estad칤sticas:', error);
    mostrarErrorEnContadores('Error al procesar estad칤sticas del PAC');
  }
}

// Funci칩n para generar alertas del sistema basadas en el PAC
function generarAlertas() {
  try {
    const alertasContainer = document.getElementById('alerts-container');
    alertasContainer.innerHTML = ''; // Limpiar alertas anteriores
    
    const anioActual = new Date().getFullYear().toString();
    
    // Calcular datos para alertas
    const presupuestoPorDepartamento = {};
    const comprometidoPorDepartamento = {};
    const gastadoPorDepartamento = {};
    
    dat_PAC.forEach(fila => {
      if (fila && fila[0] && fila[0].toString() === anioActual && fila[1]) {
        const departamento = fila[1].toString().trim().toUpperCase();
        
        // Valores por defecto en caso de que falten datos
        const presupuesto = fila[7] ? parseInt(fila[7].toString().replace(/\./g, '').replace(/\D/g, '')) || 0 : 0;  // Columna 8
        const comprometido = fila[17] ? parseInt(fila[17].toString().replace(/\./g, '').replace(/\D/g, '')) || 0 : 0;  // Columna 18
        const gastado = fila[19] ? parseInt(fila[19].toString().replace(/\./g, '').replace(/\D/g, '')) || 0 : 0;  // Columna 20
        
        // Sumar al total del departamento
        presupuestoPorDepartamento[departamento] = (presupuestoPorDepartamento[departamento] || 0) + presupuesto;
        comprometidoPorDepartamento[departamento] = (comprometidoPorDepartamento[departamento] || 0) + comprometido;
        gastadoPorDepartamento[departamento] = (gastadoPorDepartamento[departamento] || 0) + gastado;
      }
    });
    
    // Departamentos con ejecuci칩n baja (menos del 30% gastado respecto al presupuesto)
    const deptosBajaEjecucion = [];
    for (const depto in presupuestoPorDepartamento) {
      if (presupuestoPorDepartamento[depto] > 0) {
        const porcentajeEjecucion = (gastadoPorDepartamento[depto] / presupuestoPorDepartamento[depto]) * 100;
        if (porcentajeEjecucion < 30) {
          deptosBajaEjecucion.push({ nombre: depto, porcentaje: porcentajeEjecucion.toFixed(2) });
        }
      }
    }
    
    // Crear alerta si hay departamentos con baja ejecuci칩n
    if (deptosBajaEjecucion.length > 0) {
      const alertaHtml = `
        <div class="alert alert-warning">
          <strong>춰Atenci칩n!</strong> ${deptosBajaEjecucion.length} departamento(s) con menos del 30% del presupuesto ejecutado.
          <a href="#" onclick="mostrarDetalleAlerta('deptos-baja-ejecucion')">Ver detalles</a>
        </div>
      `;
      alertasContainer.innerHTML += alertaHtml;
    }
    
    // Departamentos con alta ejecuci칩n (m치s del 90% gastado respecto al presupuesto)
    const deptosAltaEjecucion = [];
    for (const depto in presupuestoPorDepartamento) {
      if (presupuestoPorDepartamento[depto] > 0) {
        const porcentajeEjecucion = (gastadoPorDepartamento[depto] / presupuestoPorDepartamento[depto]) * 100;
        if (porcentajeEjecucion > 90) {
          deptosAltaEjecucion.push({ nombre: depto, porcentaje: porcentajeEjecucion.toFixed(2) });
        }
      }
    }
    
    // Crear alerta si hay departamentos con alta ejecuci칩n
    if (deptosAltaEjecucion.length > 0) {
      const alertaHtml = `
        <div class="alert alert-success">
          <strong>춰Excelente!</strong> ${deptosAltaEjecucion.length} departamento(s) han ejecutado m치s del 90% de su presupuesto.
          <a href="#" onclick="mostrarDetalleAlerta('deptos-alta-ejecucion')">Ver detalles</a>
        </div>
      `;
      alertasContainer.innerHTML += alertaHtml;
    }
    
    // Comparaci칩n entre comprometido y gastado (departamentos que han comprometido mucho pero gastado poco)
    const deptosGranDiferencia = [];
    for (const depto in comprometidoPorDepartamento) {
      if (comprometidoPorDepartamento[depto] > 0) {
        const porcentajeGastadoVsComprometido = (gastadoPorDepartamento[depto] / comprometidoPorDepartamento[depto]) * 100;
        if (porcentajeGastadoVsComprometido < 50 && comprometidoPorDepartamento[depto] > presupuestoPorDepartamento[depto] * 0.5) {
          deptosGranDiferencia.push({ 
            nombre: depto, 
            comprometido: formatearNumero(comprometidoPorDepartamento[depto]),
            gastado: formatearNumero(gastadoPorDepartamento[depto]),
            porcentaje: porcentajeGastadoVsComprometido.toFixed(2)
          });
        }
      }
    }
    
    // Crear alerta si hay departamentos con gran diferencia entre comprometido y gastado
    if (deptosGranDiferencia.length > 0) {
      const alertaHtml = `
        <div class="alert alert-info">
          <strong>Informaci칩n:</strong> ${deptosGranDiferencia.length} departamento(s) tienen menos del 50% de ejecuci칩n sobre su presupuesto comprometido.
          <a href="#" onclick="mostrarDetalleAlerta('deptos-diferencia')">Ver detalles</a>
        </div>
      `;
      alertasContainer.innerHTML += alertaHtml;
    }
    
    // Si no hay alertas, mostrar mensaje informativo
    if (alertasContainer.innerHTML === '') {
      alertasContainer.innerHTML = '<div class="alert alert-success">No hay alertas pendientes en el sistema.</div>';
    }
  } catch (error) {
    console.error('Error al generar alertas:', error);
    const alertasContainer = document.getElementById('alerts-container');
    alertasContainer.innerHTML = `
      <div class="alert alert-danger">
        <strong>Error:</strong> No se pudieron generar las alertas del sistema.
      </div>
    `;
  }
}
// Funci칩n para actualizar la tabla de resumen por departamento basada en el PAC
function actualizarTablaDepartamentos() {
  try {
    const tbody = document.getElementById('dept-summary-body');
    tbody.innerHTML = ''; // Limpiar tabla
    
    const anioActual = new Date().getFullYear().toString();
    
    // Agrupar datos por departamento
    const datosPorDepartamento = {};
    
    dat_PAC.forEach(fila => {
      if (fila && fila[0] && fila[0].toString() === anioActual && fila[1]) {
        const departamento = fila[1].toString().trim().toUpperCase();
        // Usar las columnas correctas seg칰n la estructura proporcionada
        const presupuesto = fila[7] ? parseInt(fila[7].toString().replace(/\./g, '').replace(/\D/g, '')) || 0 : 0;  // Columna 8: Total 칈tem
        const comprometido = fila[17] ? parseInt(fila[17].toString().replace(/\./g, '').replace(/\D/g, '')) || 0 : 0;  // Columna 18: Comprometido
        const gastado = fila[19] ? parseInt(fila[19].toString().replace(/\./g, '').replace(/\D/g, '')) || 0 : 0;  // Columna 20: Gastado
        
        if (!datosPorDepartamento[departamento]) {
          datosPorDepartamento[departamento] = {
            presupuesto: 0,
            comprometido: 0,
            gastado: 0
          };
        }
        
        datosPorDepartamento[departamento].presupuesto += presupuesto;
        datosPorDepartamento[departamento].comprometido += comprometido;
        datosPorDepartamento[departamento].gastado += gastado;
      }
    });
    
    // Convertir a array para ordenar por mayor presupuesto
    const departamentosArray = Object.keys(datosPorDepartamento).map(dept => ({
      nombre: dept,
      presupuesto: datosPorDepartamento[dept].presupuesto,
      comprometido: datosPorDepartamento[dept].comprometido,
      gastado: datosPorDepartamento[dept].gastado,
      porcentajeEjecucion: datosPorDepartamento[dept].presupuesto > 0 
        ? (datosPorDepartamento[dept].gastado / datosPorDepartamento[dept].presupuesto * 100).toFixed(2) 
        : 0
    }));
    
    // Ordenar por mayor presupuesto
    departamentosArray.sort((a, b) => b.presupuesto - a.presupuesto);
    
    // Crear filas para la tabla
    departamentosArray.forEach(dept => {
      // Determinar el estado seg칰n el porcentaje de ejecuci칩n (basado en gastado vs presupuestado)
      let estado = '';
      let estadoClase = '';
      
      const porcentaje = parseFloat(dept.porcentajeEjecucion);
      if (porcentaje >= 90) {
        estado = '칍ptimo';
        estadoClase = 'estado-optimo';
      } else if (porcentaje >= 70) {
        estado = 'Avanzado';
        estadoClase = 'estado-avanzado';
      } else if (porcentaje >= 30) {
        estado = 'Normal';
        estadoClase = 'estado-normal';
      } else {
        estado = 'Bajo';
        estadoClase = 'estado-bajo';
      }
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${dept.nombre}</td>
        <td>$${formatearNumero(dept.presupuesto)}</td>
        <td>$${formatearNumero(dept.comprometido)}</td>
        <td>$${formatearNumero(dept.gastado)}</td>
        <td>${dept.porcentajeEjecucion}%</td>
        <td class="${estadoClase}">${estado}</td>
      `;
      
      tbody.appendChild(tr);
    });
  } catch (error) {
    console.error('Error al actualizar tabla:', error);
    const tbody = document.getElementById('dept-summary-body');
    tbody.innerHTML = `
      <tr>
        <td colspan="6" style="text-align:center; color:red;">
          Error al cargar los datos de la tabla. Intente recargar la p치gina.
        </td>
      </tr>
    `;
  }
}
// Funci칩n para crear gr치ficos usando Chart.js basados en el PAC
function crearGraficos() {
  if (typeof Chart === 'undefined') {
    console.error('Chart.js no est치 disponible');
    return;
  }
  
  try {
    // 1. Gr치fico de distribuci칩n por departamento
    crearGraficoDepartamentos();
    
    // 2. Gr치fico de ejecuci칩n mensual
    crearGraficoMensual();
  } catch (error) {
    console.error('Error al crear gr치ficos:', error);
  }
}

// Funci칩n para crear gr치fico de distribuci칩n por departamento basado en el PAC
function crearGraficoDepartamentos() {
  try {
    const canvas = document.getElementById('departmentChart');
    if (!canvas) {
      console.error('Canvas para gr치fico de departamentos no encontrado');
      return;
    }
    
    const ctx = canvas.getContext('2d');
    
    // Obtener datos por departamento del PAC
    const anioActual = new Date().getFullYear().toString();
    const datosPorDepartamento = {};
    
    dat_PAC.forEach(fila => {
      if (fila && fila[0] && fila[0].toString() === anioActual && fila[1]) {
        const departamento = fila[1].toString().trim().toUpperCase();
        const presupuesto = fila[8] ? parseInt(fila[8].toString().replace(/\./g, '').replace(/\D/g, '')) || 0 : 0;
        
        if (!datosPorDepartamento[departamento]) {
          datosPorDepartamento[departamento] = 0;
        }
        
        datosPorDepartamento[departamento] += presupuesto;
      }
    });
    
    // Preparar datos para el gr치fico
    const labels = Object.keys(datosPorDepartamento);
    const data = Object.values(datosPorDepartamento);
    
    // Colores para el gr치fico
    const backgroundColors = [
      '#4CAF50', '#2196F3', '#FFC107', '#FF5722', '#9C27B0',
      '#3F51B5', '#E91E63', '#00BCD4', '#FFEB3B', '#795548'
    ];
    
    // Destruir gr치fico anterior si existe
    if (chartInstancesDep) {
      chartInstancesDep.destroy();
    }
    
    // Crear el gr치fico
    chartInstancesDep = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: backgroundColors.slice(0, labels.length),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
            labels: {
              boxWidth: 15,
              font: {
                size: 10
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.raw;
                return label + ': $' + formatearNumero(value);
              }
            }
          }
        }
      }
    });
  } catch (error) {
    console.error('Error al crear gr치fico de departamentos:', error);
  }
}

// Funci칩n para crear gr치fico de ejecuci칩n mensual basado en el PAC
// Funci칩n para crear gr치fico de distribuci칩n por departamento basado en el PAC
function crearGraficoDepartamentos() {
  try {
    const canvas = document.getElementById('departmentChart');
    if (!canvas) {
      console.error('Canvas para gr치fico de departamentos no encontrado');
      return;
    }
    
    const ctx = canvas.getContext('2d');
    
    // Obtener datos por departamento del PAC
    const anioActual = new Date().getFullYear().toString();
    const datosPorDepartamento = {};
    
    dat_PAC.forEach(fila => {
      if (fila && fila[0] && fila[0].toString() === anioActual && fila[1]) {
        const departamento = fila[1].toString().trim().toUpperCase();
        const presupuesto = fila[7] ? parseInt(fila[7].toString().replace(/\./g, '').replace(/\D/g, '')) || 0 : 0;  // Columna 8: Total 칈tem
        
        if (!datosPorDepartamento[departamento]) {
          datosPorDepartamento[departamento] = 0;
        }
        
        datosPorDepartamento[departamento] += presupuesto;
      }
    });
    
    // Preparar datos para el gr치fico
    const labels = Object.keys(datosPorDepartamento);
    const data = Object.values(datosPorDepartamento);
    
    // Colores para el gr치fico
    const backgroundColors = [
      '#4CAF50', '#2196F3', '#FFC107', '#FF5722', '#9C27B0',
      '#3F51B5', '#E91E63', '#00BCD4', '#FFEB3B', '#795548'
    ];
    
    // Destruir gr치fico anterior si existe
    if (chartInstancesDep) {
      chartInstancesDep.destroy();
    }
    
    // Crear el gr치fico
    chartInstancesDep = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: backgroundColors.slice(0, labels.length),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
            labels: {
              boxWidth: 15,
              font: {
                size: 10
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.raw;
                return label + ': $' + formatearNumero(value);
              }
            }
          }
        }
      }
    });
  } catch (error) {
    console.error('Error al crear gr치fico de departamentos:', error);
  }
}

// Funci칩n para crear gr치fico de ejecuci칩n mensual modificado
function crearGraficoMensual() {
  try {
    const canvas = document.getElementById('monthlyChart');
    if (!canvas) {
      console.error('Canvas para gr치fico mensual no encontrado');
      return;
    }
    
    const ctx = canvas.getContext('2d');
    
    // Obtener datos del PAC del a침o actual
    const anioActual = new Date().getFullYear().toString();
    
    // En lugar de agrupar por mes, vamos a mostrar los departamentos y sus presupuestos/gastos
    const datosPorDepartamento = {};
    
    dat_PAC.forEach(fila => {
      if (fila && fila[0] && fila[0].toString() === anioActual && fila[1]) {
        const departamento = fila[1].toString().trim().toUpperCase();
        
        if (!datosPorDepartamento[departamento]) {
          datosPorDepartamento[departamento] = {
            presupuesto: 0,
            comprometido: 0,
            gastado: 0
          };
        }
        
        // Columna 8: Total 칈tem
        const presupuesto = fila[7] ? parseInt(fila[7].toString().replace(/\./g, '').replace(/\D/g, '')) || 0 : 0;
        // Columna 18: Comprometido
        const comprometido = fila[17] ? parseInt(fila[17].toString().replace(/\./g, '').replace(/\D/g, '')) || 0 : 0;
        // Columna 20: Gastado
        const gastado = fila[19] ? parseInt(fila[19].toString().replace(/\./g, '').replace(/\D/g, '')) || 0 : 0;
        
        datosPorDepartamento[departamento].presupuesto += presupuesto;
        datosPorDepartamento[departamento].comprometido += comprometido;
        datosPorDepartamento[departamento].gastado += gastado;
      }
    });
    
    // Convertir a arrays para el gr치fico
    const departamentos = Object.keys(datosPorDepartamento);
    const presupuestos = [];
    const comprometidos = [];
    const gastados = [];
    
    // Limitar a los 8 departamentos con mayor presupuesto para mejor visualizaci칩n
    const topDepartamentos = departamentos
      .map(dept => ({ 
        nombre: dept, 
        presupuesto: datosPorDepartamento[dept].presupuesto 
      }))
      .sort((a, b) => b.presupuesto - a.presupuesto)
      .slice(0, 8)
      .map(item => item.nombre);
    
    // Crear los arrays de datos para los departamentos seleccionados
    topDepartamentos.forEach(dept => {
      presupuestos.push(datosPorDepartamento[dept].presupuesto);
      comprometidos.push(datosPorDepartamento[dept].comprometido);
      gastados.push(datosPorDepartamento[dept].gastado);
    });
    
    // Destruir gr치fico anterior si existe
    if (chartInstancesMonthly) {
      chartInstancesMonthly.destroy();
    }
    
    // Crear el gr치fico de barras comparativo por departamento
    chartInstancesMonthly = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: topDepartamentos,
        datasets: [
          {
            label: 'Presupuesto Anual',
            data: presupuestos,
            backgroundColor: 'rgba(75, 192, 192, 0.5)',
            borderColor: 'rgb(75, 192, 192)',
            borderWidth: 1
          },
          {
            label: 'Comprometido',
            data: comprometidos,
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgb(54, 162, 235)',
            borderWidth: 1
          },
          {
            label: 'Ejecutado',
            data: gastados,
            backgroundColor: 'rgba(255, 99, 132, 0.5)',
            borderColor: 'rgb(255, 99, 132)',
            borderWidth: 1
          }
        ]
      },
      options: {
        indexAxis: 'y',  // Esto hace que las barras sean horizontales para mejor visualizaci칩n de departamentos
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                if (value >= 1000000) {
                  return '$' + (value / 1000000).toFixed(1) + 'M';
                } else if (value >= 1000) {
                  return '$' + (value / 1000).toFixed(1) + 'K';
                }
                return '$' + value;
              }
            }
          }
        },
        plugins: {
          legend: {
            position: 'top',
          },
          title: {
            display: true,
            text: 'Comparativa Presupuesto-Ejecuci칩n por Departamento'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.dataset.label || '';
                const value = context.raw;
                return label + ': $' + formatearNumero(value);
              }
            }
          }
        }
      }
    });
  } catch (error) {
    console.error('Error al crear gr치fico por departamento:', error);
  }
}

// Funci칩n para inicializar la carga de datos
function inicializarSistema() {
  try {
    // Verificar si Chart.js est치 disponible o cargarlo
    if (typeof Chart === 'undefined') {
      console.log('Cargando Chart.js...');
      
      // Cargar Chart.js primero
      const scriptChartJs = document.createElement('script');
      scriptChartJs.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
      scriptChartJs.integrity = 'sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgMabC3vkumRokgJA==';
      scriptChartJs.crossOrigin = 'anonymous';
      scriptChartJs.referrerPolicy = 'no-referrer';
      
      // Cuando Chart.js se cargue, cargar los datos
      scriptChartJs.onload = function() {
        console.log('Chart.js cargado correctamente');
        setTimeout(cargarDatosEstadisticas, 500); // Peque침o retraso para asegurar la inicializaci칩n
      };
      
      scriptChartJs.onerror = function() {
        console.error('Error al cargar Chart.js');
        cargarDatosEstadisticas(); // Intenta cargar datos de todas formas
      };
      
      document.head.appendChild(scriptChartJs);
    } else {
      // Chart.js ya est치 disponible, cargar datos directamente
      cargarDatosEstadisticas();
    }
    
    // Configurar actualizaci칩n peri칩dica (cada 5 minutos)
    setInterval(cargarDatosEstadisticas, 300000);
    
  } catch (error) {
    console.error('Error al inicializar el sistema:', error);
    mostrarErrorEnContadores('Error al inicializar el sistema');
  }
}

// Agregar estilos CSS para las alertas y estados
function agregarEstilos() {
  const estilosCSS = document.createElement('style');
  estilosCSS.innerHTML = `
    /* Estilos para alertas */
    .alert {
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid transparent;
      border-radius: 4px;
    }
    .alert-success {
      color: #155724;
      background-color: #d4edda;
      border-color: #c3e6cb;
    }
    .alert-info {
      color: #0c5460;
      background-color: #d1ecf1;
      border-color: #bee5eb;
    }
    .alert-warning {
      color: #856404;
      background-color: #fff3cd;
      border-color: #ffeeba;
    }
    .alert-danger {
      color: #721c24;
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }
    .alert a {
      font-weight: bold;
      text-decoration: underline;
      color: inherit;
    }
    
    /* Estilos para estados */
    .estado-critico {
      color: #721c24;
      font-weight: bold;
    }
    .estado-avanzado {
      color: #856404;
      font-weight: bold;
    }
    .estado-normal {
      color: #155724;
    }
    .estado-bajo {
      color: #0c5460;
    }
    
    /* Animaci칩n de carga */
    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: #333;
      animation: spin 1s ease-in-out infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Mejorar responsividad de los gr치ficos */
    .chart-container {
      height: 300px;
      position: relative;
    }
    
    @media (max-width: 768px) {
      .charts-container {
        flex-direction: column;
      }
      .chart-container {
        width: 100%;
        margin-bottom: 20px;
      }
    }
  `;
  document.head.appendChild(estilosCSS);
}

// Inicializar cuando se carga la p치gina
document.addEventListener('DOMContentLoaded', function() {
  console.log('Inicializando sistema de estad칤sticas del PAC...');
  agregarEstilos();
  inicializarSistema();
});
// Funci칩n para explicar el dashboard de estad칤sticas mediante voz
function explicarDashboardPorVoz() {
  // Verificar si el navegador soporta s칤ntesis de voz
  if (!('speechSynthesis' in window)) {
    mostrarToast('Tu navegador no soporta la s칤ntesis de voz', '#e74c3c');
    return;
  }
  
  // Cancelar cualquier s칤ntesis de voz en curso
  window.speechSynthesis.cancel();
  
  // Obtener datos actuales para el an치lisis
  const anioActual = document.getElementById('selector-anios') ? 
    document.getElementById('selector-anios').value : 
    new Date().getFullYear().toString();
    
  // Obtener conteos de los indicadores
  const productosCount = document.getElementById('presupuestos-count').textContent;
  const departamentosCount = document.getElementById('departments-count').textContent;
  const itemsCount = document.getElementById('compras-count').textContent;
  const presupuestoTotal = document.getElementById('total-year').textContent;
  
  // Recopilar informaci칩n de la tabla de departamentos
  const departamentos = [];
  const filasTabla = document.querySelectorAll('#dept-summary-body tr');
  filasTabla.forEach(fila => {
    const celdas = fila.querySelectorAll('td');
    if (celdas.length >= 6) {
      departamentos.push({
        nombre: celdas[0].textContent,
        presupuesto: celdas[1].textContent,
        comprometido: celdas[2].textContent,
        gastado: celdas[3].textContent,
        porcentaje: celdas[4].textContent,
        estado: celdas[5].textContent
      });
    }
  });
  
  // Ordenar departamentos por porcentaje de ejecuci칩n (de mayor a menor)
  departamentos.sort((a, b) => {
    const porcA = parseFloat(a.porcentaje);
    const porcB = parseFloat(b.porcentaje);
    return porcB - porcA;
  });
  
  // Contar alertas
  const alertas = document.querySelectorAll('.alert');
  const cantidadAlertas = alertas.length;
  const tiposAlertas = [];
  
  alertas.forEach(alerta => {
    if (alerta.classList.contains('alert-warning')) {
      tiposAlertas.push('advertencia');
    } else if (alerta.classList.contains('alert-success')) {
      tiposAlertas.push('칠xito');
    } else if (alerta.classList.contains('alert-info')) {
      tiposAlertas.push('informativa');
    } else if (alerta.classList.contains('alert-danger')) {
      tiposAlertas.push('peligro');
    }
  });
  
  // Construir el an치lisis general
  let textoExplicacion = `
    An치lisis del Dashboard de Estad칤sticas del Plan Anual de Compras para el a침o ${anioActual}.
    
    Comenzando con un resumen general, el dashboard muestra que tenemos ${productosCount} productos o servicios 칰nicos
    distribuidos en ${departamentosCount} departamentos, con un total de ${itemsCount} 칤tems registrados en el PAC.
    El presupuesto total asignado es de ${presupuestoTotal} pesos chilenos.
    
    En cuanto a la ejecuci칩n presupuestaria, `;
  
  // An치lisis de ejecuci칩n por departamentos
  const deptosAltaEjecucion = departamentos.filter(d => parseFloat(d.porcentaje) > 80);
  const deptosBajaEjecucion = departamentos.filter(d => parseFloat(d.porcentaje) < 30);
  const deptosEjecucionNormal = departamentos.filter(d => parseFloat(d.porcentaje) >= 30 && parseFloat(d.porcentaje) <= 80);
  
  if (deptosAltaEjecucion.length > 0) {
    textoExplicacion += `
      Destaca positivamente que ${deptosAltaEjecucion.length} departamentos presentan una ejecuci칩n presupuestaria superior al 80%.
      ${deptosAltaEjecucion.length > 0 ? `Entre ellos, ${deptosAltaEjecucion[0].nombre} lidera con un ${deptosAltaEjecucion[0].porcentaje} de ejecuci칩n.` : ''}
    `;
  }
  
  if (deptosBajaEjecucion.length > 0) {
    textoExplicacion += `
      Sin embargo, ${deptosBajaEjecucion.length} departamentos muestran una ejecuci칩n inferior al 30%, lo que representa un punto de atenci칩n.
      ${deptosBajaEjecucion.length > 0 ? `Espec칤ficamente, ${deptosBajaEjecucion[0].nombre} tiene solo un ${deptosBajaEjecucion[0].porcentaje} de ejecuci칩n, siendo el m치s bajo.` : ''}
      Ser칤a recomendable revisar las causas de esta baja ejecuci칩n y proporcionar apoyo en los procesos de compra si fuera necesario.
    `;
  }
  
  // An치lisis de alertas
  if (cantidadAlertas > 0 && !tiposAlertas.includes('peligro')) {
    textoExplicacion += `
      El sistema muestra ${cantidadAlertas} alertas que requieren atenci칩n, principalmente de tipo ${tiposAlertas.join(', ')}.
      ${tiposAlertas.includes('advertencia') ? 'Las alertas de advertencia indican departamentos con baja ejecuci칩n presupuestaria que deben ser monitoreados.' : ''}
      ${tiposAlertas.includes('칠xito') ? 'Las alertas de 칠xito indican departamentos con alta ejecuci칩n, lo que refleja una buena gesti칩n.' : ''}
      ${tiposAlertas.includes('informativa') ? 'Las alertas informativas muestran diferencias entre presupuesto comprometido y ejecutado que deben ser revisadas.' : ''}
    `;
  } else if (tiposAlertas.includes('peligro')) {
    textoExplicacion += `
      Atenci칩n: el sistema muestra alertas de peligro que requieren atenci칩n inmediata. 
      Recomiendo revisar los errores indicados y solucionar los problemas t칠cnicos que puedan estar afectando al sistema.
    `;
  } else {
    textoExplicacion += `
      Es positivo mencionar que no se detectan alertas cr칤ticas en el sistema en este momento.
    `;
  }
  
  // An치lisis de distribuci칩n presupuestaria
  textoExplicacion += `
    Analizando la distribuci칩n del presupuesto, `;
  
  if (departamentos.length > 0) {
    // Ordenar departamentos por presupuesto (mayor a menor)
    const deptosPorPresupuesto = [...departamentos].sort((a, b) => {
      const presA = parseFloat(a.presupuesto.replace(/[^\d]/g, ''));
      const presB = parseFloat(b.presupuesto.replace(/[^\d]/g, ''));
      return presB - presA;
    });
    
    const deptoMayorPresupuesto = deptosPorPresupuesto[0];
    const porcentajePresupuestoMayor = Math.round((parseFloat(deptoMayorPresupuesto.presupuesto.replace(/[^\d]/g, '')) / 
      parseFloat(presupuestoTotal.replace(/[^\d]/g, ''))) * 100);
    
    textoExplicacion += `
      el departamento ${deptoMayorPresupuesto.nombre} concentra aproximadamente el ${porcentajePresupuestoMayor}% del presupuesto total,
      lo que evidencia su relevancia estrat칠gica dentro de la organizaci칩n.
    `;
    
    // An치lisis de brecha entre comprometido y gastado
    const deptosConBrechaAlta = departamentos.filter(d => {
      const comprometido = parseFloat(d.comprometido.replace(/[^\d]/g, ''));
      const gastado = parseFloat(d.gastado.replace(/[^\d]/g, ''));
      return comprometido > 0 && (gastado / comprometido) < 0.5;
    });
    
    if (deptosConBrechaAlta.length > 0) {
      textoExplicacion += `
        Un punto importante a considerar es que ${deptosConBrechaAlta.length} departamentos presentan una brecha significativa
        entre el presupuesto comprometido y el efectivamente gastado. Esto podr칤a indicar procesos de compra en curso
        que deben ser monitoreados para asegurar su finalizaci칩n antes del cierre del per칤odo fiscal.
      `;
    }
  }
  
  // Recomendaciones generales
  textoExplicacion += `
    A modo de recomendaci칩n general, sugiero:
    
    Primero, realizar seguimiento cercano a los departamentos con ejecuci칩n inferior al 30%, identificando barreras 
    en los procesos de compra y ofreciendo apoyo administrativo cuando sea necesario.
    
    Segundo, evaluar la posibilidad de redistribuir recursos desde departamentos con baja ejecuci칩n hacia aquellos 
    que est치n ejecutando eficientemente y podr칤an requerir recursos adicionales.
    
    Tercero, verificar que los compromisos presupuestarios se materialicen en gastos efectivos, especialmente 
    en aquellos departamentos donde existe una brecha importante entre lo comprometido y lo ejecutado.
    
    Y finalmente, felicitar a los departamentos con alta ejecuci칩n, reconociendo su buena gesti칩n administrativa 
    como ejemplo para el resto de la organizaci칩n.
    
    Este dashboard se actualiza autom치ticamente cada 5 minutos, por lo que siempre muestra la informaci칩n m치s reciente 
    disponible en el sistema.
  `;
  
  // Limpiar el texto (eliminar espacios extra y saltos de l칤nea)
  textoExplicacion = textoExplicacion.replace(/\n\s+/g, ' ').trim();
  
  // Crear y configurar el objeto de s칤ntesis de voz
  const utterance = new SpeechSynthesisUtterance(textoExplicacion);
  
  // Obtener voces disponibles
  let voices = window.speechSynthesis.getVoices();
  
  // Si no hay voces disponibles, forzar la carga y esperar un momento
  if (voices.length === 0) {
    window.speechSynthesis.onvoiceschanged = function() {
      voices = window.speechSynthesis.getVoices();
      configurarYReproducirVoz();
    };
    // Forzar la carga de voces
    window.speechSynthesis.getVoices();
  } else {
    configurarYReproducirVoz();
  }
  
  function configurarYReproducirVoz() {
    // Intentar seleccionar una voz en espa침ol
    const spanishVoice = voices.find(voice => 
      voice.lang.includes('es') && 
      (voice.name.toLowerCase().includes('female') || voice.name.toLowerCase().includes('mujer'))
    ) || voices.find(voice => voice.lang.includes('es'));
    
    // Asignar voz si se encontr칩 una apropiada
    if (spanishVoice) {
      utterance.voice = spanishVoice;
    }
    
    // Configurar propiedades de la voz
    utterance.rate = 0.95; // Velocidad ligeramente m치s lenta para mejor comprensi칩n
    utterance.pitch = 1.0; // Tono normal
    
    // Mostrar indicador visual de que se est치 reproduciendo
    mostrarToast('Explicando el dashboard de estad칤sticas...', '#3498db');
    
    // Eliminar bot칩n detener existente si hay alguno
    const botonDetenerExistente = document.getElementById('detener-explicacion');
    if (botonDetenerExistente) {
      botonDetenerExistente.remove();
    }
    
    // Crear bot칩n para detener la explicaci칩n
    const botonDetener = document.createElement('button');
    botonDetener.id = 'detener-explicacion';
    botonDetener.className = 'btn-stop';
    botonDetener.innerHTML = '<i class="fas fa-stop"></i> Detener explicaci칩n';
    botonDetener.onclick = function() {
      // Cancelar la s칤ntesis
      window.speechSynthesis.cancel();
      
      // Eliminar este bot칩n
      this.remove();
      
      // Habilitar el bot칩n de explicaci칩n de nuevo
      const botonExplicacion = document.getElementById('btn-explicacion');
      if (botonExplicacion) {
        botonExplicacion.disabled = false;
      }
      
      mostrarToast('Explicaci칩n detenida', '#e74c3c');
    };
    
    // Agregar bot칩n al documento
    document.querySelector('.dashboard-header') ? 
      document.querySelector('.dashboard-header').appendChild(botonDetener) : 
      document.body.appendChild(botonDetener);
    
    // Eventos para saber cu치ndo inicia y termina la s칤ntesis
    utterance.onstart = () => {
      // Deshabilitar bot칩n de explicaci칩n mientras se est치 hablando
      const botonExplicacion = document.getElementById('btn-explicacion');
      if (botonExplicacion) {
        botonExplicacion.disabled = true;
      }
    };
    
    utterance.onend = () => {
      // Habilitar bot칩n de explicaci칩n cuando termina de hablar
      const botonExplicacion = document.getElementById('btn-explicacion');
      if (botonExplicacion) {
        botonExplicacion.disabled = false;
      }
      
      // Eliminar bot칩n de detener
      const botonDetener = document.getElementById('detener-explicacion');
      if (botonDetener) {
        botonDetener.remove();
      }
      
      mostrarToast('Explicaci칩n completada', '#2ecc71');
    };
    
    // Manejar errores en la reproducci칩n
    utterance.onerror = (event) => {
      console.error('Error en la s칤ntesis de voz:', event);
      
      // Habilitar bot칩n de explicaci칩n si hay error
      const botonExplicacion = document.getElementById('btn-explicacion');
      if (botonExplicacion) {
        botonExplicacion.disabled = false;
      }
      
      // Eliminar bot칩n de detener
      const botonDetener = document.getElementById('detener-explicacion');
      if (botonDetener) {
        botonDetener.remove();
      }
      
      mostrarToast('Error al reproducir la explicaci칩n', '#e74c3c');
    };
    
    // Iniciar la s칤ntesis de voz
    try {
      window.speechSynthesis.speak(utterance);
    } catch (error) {
      console.error('Error al iniciar la s칤ntesis de voz:', error);
      mostrarToast('Error al iniciar la explicaci칩n', '#e74c3c');
      
      // Habilitar bot칩n si hay error
      const botonExplicacion = document.getElementById('btn-explicacion');
      if (botonExplicacion) {
        botonExplicacion.disabled = false;
      }
    }
  }
}

// Funci칩n para mostrar toast (mensaje flotante)
function mostrarToast(mensaje, color) {
  // Verificar si ya existe un toast y eliminarlo
  const toastExistente = document.getElementById('toast-mensaje');
  if (toastExistente) toastExistente.remove();
  
  // Crear nuevo toast
  const toast = document.createElement('div');
  toast.id = 'toast-mensaje';
  toast.className = 'toast-mensaje';
  toast.textContent = mensaje;
  toast.style.backgroundColor = color || '#333';
  
  // Aplicar estilos al toast
  toast.style.position = 'fixed';
  toast.style.bottom = '20px';
  toast.style.right = '20px';
  toast.style.padding = '12px 20px';
  toast.style.borderRadius = '4px';
  toast.style.color = 'white';
  toast.style.zIndex = '9999';
  toast.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
  toast.style.transition = 'opacity 0.5s ease-in-out';
  
  // Agregar al documento
  document.body.appendChild(toast);
  
  // Eliminar el toast despu칠s de 5 segundos
  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => toast.remove(), 500);
  }, 5000);
}

// Funci칩n para agregar el bot칩n de explicaci칩n por voz al dashboard
function agregarBotonExplicacionPorVoz() {
  // Eliminar bot칩n existente si ya existe
  const botonExistente = document.getElementById('btn-explicacion');
  if (botonExistente) {
    botonExistente.remove();
  }
  
  // Crear el bot칩n con estilos
  const botonExplicacion = document.createElement('button');
  botonExplicacion.id = 'btn-explicacion';
  botonExplicacion.innerHTML = '<i class="fas fa-volume-up"></i> Explicar Dashboard';
  botonExplicacion.title = 'Escuchar explicaci칩n detallada del dashboard';
  
  // Estilos para el bot칩n
  botonExplicacion.style.backgroundColor = '#3498db';
  botonExplicacion.style.color = 'white';
  botonExplicacion.style.border = 'none';
  botonExplicacion.style.borderRadius = '4px';
  botonExplicacion.style.padding = '8px 15px';
  botonExplicacion.style.margin = '5px';
  botonExplicacion.style.cursor = 'pointer';
  botonExplicacion.style.fontSize = '14px';
  botonExplicacion.style.fontWeight = 'bold';
  botonExplicacion.style.display = 'flex';
  botonExplicacion.style.alignItems = 'center';
  botonExplicacion.style.justifyContent = 'center';
  botonExplicacion.style.gap = '5px';
  
  // Manejar hover
  botonExplicacion.onmouseover = function() {
    this.style.backgroundColor = '#2980b9';
  };
  botonExplicacion.onmouseout = function() {
    this.style.backgroundColor = '#3498db';
  };
  
  // Agregar evento click para reproducir la explicaci칩n
  botonExplicacion.onclick = explicarDashboardPorVoz;
  
  // Insertar el bot칩n en el DOM
  const dashboardHeader = document.querySelector('.dashboard-header');
  if (dashboardHeader) {
    // Si existe el selector de a침os, colocarlo despu칠s
    const selectorContainer = document.querySelector('.year-selector-container');
    if (selectorContainer) {
      dashboardHeader.insertBefore(botonExplicacion, selectorContainer.nextSibling);
    } else {
      // Si no hay selector, lo colocamos antes del bot칩n de volver
      const backButton = dashboardHeader.querySelector('.back-button');
      if (backButton) {
        dashboardHeader.insertBefore(botonExplicacion, backButton);
      } else {
        // Como 칰ltimo recurso, lo agregamos al final de la cabecera
        dashboardHeader.appendChild(botonExplicacion);
      }
    }
  } else {
    // Si no existe la cabecera del dashboard, lo a침adimos antes del primer contenedor de estad칤sticas
    const statsContainer = document.querySelector('.stats-container');
    if (statsContainer) {
      statsContainer.parentNode.insertBefore(botonExplicacion, statsContainer);
    } else {
      // Como 칰ltimo recurso, lo agregamos al body
      document.body.appendChild(botonExplicacion);
    }
  }
  
  // Cargar Font Awesome si no est치 presente (para el 칤cono del altavoz)
  if (!document.querySelector('link[href*="font-awesome"]')) {
    const fontAwesome = document.createElement('link');
    fontAwesome.rel = 'stylesheet';
    fontAwesome.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css';
    document.head.appendChild(fontAwesome);
  }
}

// A침adir CSS para los botones y mensajes
function agregarEstilosVoz() {
  // Eliminar estilos existentes si ya existen
  const estilosExistentes = document.getElementById('estilos-voz');
  if (estilosExistentes) {
    estilosExistentes.remove();
  }
  
  const estilos = document.createElement('style');
  estilos.id = 'estilos-voz';
  estilos.textContent = `
    .btn-stop {
      background-color: #e74c3c;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 15px;
      margin: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      transition: background-color 0.3s;
    }
    
    .btn-stop:hover {
      background-color: #c0392b;
    }
    
    #btn-explicacion:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }
    
    .toast-mensaje {
      opacity: 1;
      transition: opacity 0.5s ease-in-out;
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  `;
  
  document.head.appendChild(estilos);
}

// Funci칩n para verificar y reiniciar el estado del sistema de voz
function verificarYReiniciarSistemaVoz() {
  // Verificar si hay una s칤ntesis activa y cancelarla
  if (window.speechSynthesis) {
    window.speechSynthesis.cancel();
  }
  
  // Eliminar bot칩n de detener si existe
  const botonDetener = document.getElementById('detener-explicacion');
  if (botonDetener) {
    botonDetener.remove();
  }
  
  // Asegurarse de que el bot칩n de explicaci칩n est칠 habilitado
  const botonExplicacion = document.getElementById('btn-explicacion');
  if (botonExplicacion) {
    botonExplicacion.disabled = false;
  } else {
    // Si no existe el bot칩n, lo agregamos
    agregarBotonExplicacionPorVoz();
  }
}

// Inicializar cuando se carga la p치gina
document.addEventListener('DOMContentLoaded', function() {
  // Peque침o retraso para asegurar que otros componentes est칠n cargados
  setTimeout(function() {
    agregarEstilosVoz();
    agregarBotonExplicacionPorVoz();
    verificarYReiniciarSistemaVoz();
    
    // Pre-cargar voces para evitar demoras en la s칤ntesis
    if ('speechSynthesis' in window) {
      window.speechSynthesis.getVoices();
    }
    
    // Agregar un listener global para tecla ESC para detener la s칤ntesis
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        if (window.speechSynthesis) {
          window.speechSynthesis.cancel();
          mostrarToast('Explicaci칩n detenida', '#e74c3c');
          verificarYReiniciarSistemaVoz();
        }
      }
    });
  }, 1000);
  
  // Reiniciar estado de voz cuando se cambie de pesta침a y se vuelva
  document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible') {
      verificarYReiniciarSistemaVoz();
    }
  });
});
        </script>
</body>
</html>