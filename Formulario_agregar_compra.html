<!DOCTYPE html> <!-- --------- INGRESO DE DOCUMENTOS  --------- -->
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ingreso de Compras | Municipalidad de Arica</title>
  <script src="dir_formularioapps.js"></script>

  <style>
    /* Reset y estilos base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    body {
      background-color: #f5f5f7;
      color: #1d1d1f;
      overflow-x: hidden;
    }

    html {
      scroll-behavior: smooth;
    }

    /* Estilos del Header */
    header {
      background-color: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      transition: all 0.4s ease;
    }

    .top-header {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 15px 5%;
      max-width: 1400px;
      margin: 0 auto;
      text-align: center;
    }

    .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .logo img {
      height: 40px;
      transition: transform 0.3s ease;
    }

    .logo:hover img {
      transform: scale(1.05);
    }

    .logo-text {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-left: 0;
    }

    .logo-text h1 {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: -0.5px;
    }

    .logo-text span {
      font-size: 12px;
      font-weight: 400;
      color: #86868b;
    }

    /* Contenedor del formulario */
    .dashboard-container {
      padding: 40px 5%;
      max-width: 1200px;
      margin: 0 auto;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .dashboard-title {
      font-size: 28px;
      font-weight: 600;
      letter-spacing: -0.5px;
    }

    .back-button {
      display: flex;
      align-items: center;
      background-color: #f5f5f7;
      border: none;
      border-radius: 100px;
      padding: 10px 20px;
      font-size: 16px;
      font-weight: 500;
      color: #06c;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.3s ease;
    }

    .back-button:hover {
      background-color: #e9e9eb;
      transform: translateY(-2px);
    }

    .back-icon {
      margin-right: 8px;
    }

    /* Contenedor del formulario estilo glassmorphism */
    #cont_form {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 20px;
      padding: 30px;
      width: 100%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      animation: fadeIn 1s ease-in-out;
      text-align: center;
      margin: 0 auto;
      overflow-x: hidden;
    }

    /* Animaci√≥n de entrada */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Labels e inputs */
    label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #2c3e50;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 12px 15px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 15px;
      transition: all 0.3s ease;
      background-color: #ffffffc7;
      text-transform: uppercase;
    }

    input[type="checkbox"] {
      width: 24px;
      height: 24px;
      border: 2px solid #ccc;
      border-radius: 4px;
      transition: all 0.3s ease;
      background-color: #ffffffc7;
      cursor: pointer;
      vertical-align: middle;
    }

    /* Centramos la tabla de checkbox */
    #chck1-container {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 15px 0;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: #3498db;
      box-shadow: 0 0 8px rgba(52, 152, 219, 0.4);
      outline: none;
    }

    /* Botones con gradientes */
    .button1,
    .button2,
    .button3 {
      display: inline-block;
      padding: 12px 24px;
      border-radius: 100px;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 5px 10px;
      border: none;
      color: white;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }

    .button1 {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
    }

    .button1:hover {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(46, 204, 113, 0.3);
    }

    .button2 {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
    }

    .button2:hover {
      background: linear-gradient(135deg, #c0392b, #e74c3c);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(231, 76, 60, 0.3);
    }

    .button3 {
      background: linear-gradient(135deg, #3498db, #2980b9);
    }

    .button3:hover {
      background: linear-gradient(135deg, #2980b9, #3498db);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
    }

    /* Colores de texto */
    .negritas {
      font-weight: bold;
    }

    .azul {
      color: #3498db;
    }

    .listo {
      color: #2ecc71;
      font-weight: bold;
    }

    .color_suggestions {
      color: #8e44ad;
    }

    /* Separador con gradiente */
    hr {
      height: 2px;
      border: none;
      background: linear-gradient(to right, #3498db, #8e44ad);
      margin: 25px 0;
    }

    /* Tablas contenedoras */
    .cont_tabla2 {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      display: inline-block;
      width: 100%;
      margin: 15px 0;
      background-color: #ffffff;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    #tabla1 td,
    #tabla1 th {
      text-align: center;
      vertical-align: middle;
      padding: 10px;
    }

    /* Loader - Efecto de carga inicial */
    .loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.8s ease, visibility 0.8s ease;
    }

    .loader.hidden {
      opacity: 0;
      visibility: hidden;
    }

    .loader-animation {
      width: 120px;
      height: 120px;
      position: relative;
    }

    .loader-circle {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 6px solid transparent;
      border-top-color: #27ae60;
      animation: spin 1.2s linear infinite;
    }

    .loader-circle:nth-child(2) {
      border-top-color: transparent;
      border-left-color: #3498db;
      animation-delay: 0.4s;
    }

    .loader-circle:nth-child(3) {
      border-top-color: transparent;
      border-right-color: #e74c3c;
      animation-delay: 0.8s;
      width: 80%;
      height: 80%;
      top: 10%;
      left: 10%;
    }

    .loader-logo {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 50px;
      height: 50px;
      opacity: 0.9;
    }

    .loader-message {
      position: absolute;
      bottom: -40px;
      width: 100%;
      text-align: center;
      font-weight: 500;
      font-size: 16px;
      color: #2c3e50;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    #cargandoOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 20px;
      font-family: sans-serif;
      z-index: 9999;
      display: none;
    }

    /* Footer */
    footer {
      background-color: #f5f5f7;
      color: #1d1d1f;
      padding: 60px 5%;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      margin-top: 60px;
    }

    .footer-container {
      display: flex;
      justify-content: space-between;
      max-width: 1400px;
      margin: 0 auto;
    }

    .footer-column {
      flex: 1;
      padding: 0 20px;
    }

    .footer-column h3 {
      margin-bottom: 20px;
      font-size: 18px;
      font-weight: 600;
    }

    .footer-column p {
      margin-bottom: 10px;
      color: #86868b;
      font-size: 14px;
    }

    .footer-column ul {
      list-style: none;
    }

    .footer-column ul li {
      margin-bottom: 12px;
    }

    .footer-column a {
      color: #06c;
      text-decoration: none;
      font-size: 14px;
      transition: opacity 0.3s ease;
    }

    .footer-column a:hover {
      opacity: 0.7;
    }

    .social-icons {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }

    .social-icons a {
      background-color: rgba(0, 0, 0, 0.05);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: transform 0.3s ease, background-color 0.3s ease;
    }

    .social-icons a:hover {
      transform: translateY(-3px);
      background-color: rgba(0, 0, 0, 0.1);
    }

    .footer-bottom {
      max-width: 1400px;
      margin: 40px auto 0;
      padding-top: 20px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      text-align: center;
      font-size: 12px;
      color: #86868b;
    }

    /* Asistente de chat */
    .assistant-button {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: linear-gradient(135deg, #3356e0, #ee0979);
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      z-index: 100;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .assistant-button:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    /* Media queries */
    @media (max-width: 992px) {
      .footer-container {
        flex-direction: column;
      }

      .footer-column {
        margin-bottom: 40px;
      }
    }

    @media (max-width: 768px) {
      .dashboard-title {
        font-size: 24px;
      }

      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }

      .button1,
      .button2,
      .button3 {
        width: 90% !important;
        margin: 10px auto;
        display: block;
      }

      #cont_form {
        padding: 20px 15px;
      }

      select,
      input[type="text"] {
        width: 100% !important;
      }

      input[type="checkbox"] {
        width: 28px;
        height: 28px;
      }

      .top-header {
        padding: 10px 5%;
      }
    }

    .form-section {
      margin-bottom: 25px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      width: 100%;
      margin-bottom: 15px;
      align-items: flex-start;
    }

    .form-group {
      flex: 1;
      min-width: 200px;
    }

    /* ------- Mensaje de Cargando Datos (INICIAL) ------- */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(155, 155, 158, 0.6);
      /* sombra oscura */
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      /* encima de todo */
      visibility: hidden;
      /* inicialmente oculto */
    }

    .loading-message {
      background: white;
      padding: 20px 30px;
      border-radius: 8px;
      font-size: 1.7em;
      font-weight: bold;
      text-align: center;
      box-shadow: 0 0 10px black;
    }
  </style>
</head>

<body>
  <!-- Loader - Se coloca al inicio del body -->
  <div class="loader">
    <div class="loader-animation">
      <div class="loader-circle"></div>
      <div class="loader-circle"></div>
      <div class="loader-circle"></div>
      <img src="logo_MUNI.png" alt="Logo" class="loader-logo">
      <div class="loader-message">Cargando sistema de compras...</div>
    </div>
  </div>

  <!-- Header con logo -->
  <header>
    <div class="top-header">
      <div class="logo">
        <img src="logo_MUNI.png" alt="Logo Municipalidad de Arica">
        <div class="logo-text">
          <h1>ARICA</h1>
          <span>MUNICIPALIDAD | mejor ciudad</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Contenedor principal -->
  <section class="dashboard-container">
    <div class="dashboard-header">
      <h2 class="dashboard-title">Formulario de Ingreso de Compras</h2>
      <button class="back-button" onclick="window.location.href='formulario-1.html'">
        <span class="back-icon">‚Üê</span> Volver </button>
    </div>

    <div id="loading-overlay">
      <div class="loading-message">Cargando datos...<br>por favor espere</div>
    </div>

    <div id="cont_form">
      <form id="formulario">
        <div id="cargandoOverlay">Cargando archivos...<br>Por favor espere</div>

        <div id="spinner-container">
          <div class="spinner"></div>
        </div> <!--  RUEDA DE ESPERA POR CARGA -->
        <div class="form-row">
          <div class="form-group">
            <label for="numAnio"><b>A√±o</b></label>
            <select id="numAnio" name="numAnio" onchange="continuar_nomUnid()" onclick="borrar_div(0)">
            </select>
          </div>

          <div class="form-group">
            <label for="nomUnid"><b>UNIDAD</b></label>
            <select id="nomUnid" name="nomUnid" onchange="continuar_nomCtas()" onclick="borrar_div(0)">
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="numCtas"><b>N¬∞ CTA</b></label>
          <select id="numCtas" name="numCtas" onchange="continuar_proyect()" onclick="borrar_div(0)">
          </select>
        </div>

        <div class="form-group">
          <label for="nomPryt"><b>Proyecto</b></label>
          <select id="nomPryt" name="nomPryt" onchange="ingresar_datos()" onclick="borrar_div(0)">
          </select>
        </div>

        <div id="tabla-container1"></div> <!--  XXXXXXXXXXXXXXXXX  -->

        <!-- *************** DATOS PARA DEL REGISTRO ******************* -->
        <div id="div_s0" hidden>
          <hr>

          <div id="chck1-container">
            <input class="button1" type="button" id="chck1" value="Haz click aqu√≠ para modificar los registros"
              onclick="modificar_chck()" />
          </div>

          <div class="form-group">
            <label for="ncompra"><b>N¬∞ Compra</b></label>
            <div style="display: flex; gap: 15px; align-items: center;">
              <select id="ncompra" name="ncompra" style="flex: 2;" onchange="ingresar_compra1()"
                onclick="borrar_div(0)">
              </select>
              <input type="text" id="pcompra" name="pcompra" style="flex: 1;" onclick="borrar_div(0)" readonly>
              <b><label id="lcompra" style="flex: 1;"></label></b>
            </div>
          </div>

          <div class="cont_tabla2" id="tabla-container2"></div>
        </div>

        <div id="div_s1" hidden>
          <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 20px;">
            <input class="button1" type="button" value="GUARDAR" onclick="guardarDatos()">
            <input class="button3" type="button" value="LIMPIAR" onclick="limpiarDatos()">
            <input class="button2" id="butt1" type="button" value="CERRAR" onclick="cerrarForm()">
          </div>
        </div>

        <div id="div_s2">
          <input class="button2" id="butt2" type="button" value="CERRAR" onclick="cerrarForm()">
        </div>
      </form>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <div class="footer-container">
      <div class="footer-column">
        <h3>Municipalidad de Arica</h3>
        <p>Renato Rocca, Arica</p>
        <p>Anexo: 6959</p>
        <p>Email: roberto.mamani@municipalidadarica.cl</p>
        <div class="social-icons">
          <a href="#">üìò</a>
          <a href="#">üì±</a>
          <a href="#">üê¶</a>
          <a href="#">üì∏</a>
        </div>
      </div>
      <div class="footer-column">
        <h3>Colaboraci√≥n Interdepartamental</h3>
        <p style="line-height: 1.6;">
          Este proyecto surge con el prop√≥sito de fortalecer la colaboraci√≥n entre diversas √°reas municipales, como
          <strong>iluminaci√≥n p√∫blica</strong>, <strong>Of. Mantenimiento de Veh√≠culos y Maquinaria</strong>,
          <strong>Aseo y Ornato</strong>, <strong>Asesor√≠a Tecnica</strong> y m√°s, en un solo sistema integral.
          Buscando consolidar la informaci√≥n y los procesos en un solo sistema, permitiendo un <strong>mayor control
            operativo</strong>, <strong>gesti√≥n por √°reas</strong> y una visi√≥n integral para la <strong>mejora
            continua de los servicios municipales</strong>.
        </p>
      </div>
      <div class="footer-column licitaciones">
        <h3>Licitaciones</h3>
        <ul class="licitaciones-list">
          <li><a href="licitacion_agil.html">Licitaci√≥n √Ågil</a></li>
          <li><a href="licitacion_gran_compra.html">Gran Compra</a></li>
          <li><a href="licitacion_trato_directo.html">Trato Directo</a></li>
          <li><a href="licitacion_publica.html">Licitaci√≥n P√∫blica</a></li>
          <li><a href="licitacion_convenio_marco.html">Convenio Marco</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-bottom">
      <p>¬© 2025 Municipalidad de Arica. Todos los derechos reservados.</p>
      <p>Desarrollado por Junior Barrera</p>
    </div>
  </footer>

  <!-- Bot√≥n de asistencia -->
  <div class="assistant-button" onclick="openAssistance()">üí¨</div>

  <script>
    // Script para ocultar el loader despu√©s de que la p√°gina cargue completamente
    window.addEventListener('load', function () {
      setTimeout(function () {
        document.querySelector('.loader').classList.add('hidden');
      }, 1500); // Tiempo suficiente para apreciar la animaci√≥n
    });

    // Funci√≥n para abrir asistencia via WhatsApp
    function openAssistance() {
      // Reemplaza con tu n√∫mero real para WhatsApp (formato internacional sin +)
      const phoneNumber = "56959414178";
      window.open(`https://wa.me/${phoneNumber}`, '_blank');
    }

    // Efecto de scroll en el header
    window.addEventListener('scroll', () => {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const header = document.querySelector('header');

      if (scrollTop > 100) {
        header.style.boxShadow = '0 5px 20px rgba(0, 0, 0, 0.1)';
      } else {
        header.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.05)';
      }
    });
  </script>
  </script>
  <!-- Script para el loader -->
  <script>
    // C√≥digo del loader (puedes moverlo a un archivo externo)
    document.addEventListener('DOMContentLoaded', function () {
      // Ocultar el loader cuando la p√°gina termine de cargar
      window.addEventListener('load', function () {
        // A√±adir la clase hidden para activar la transici√≥n
        document.querySelector('.loader').classList.add('hidden');

        // Eliminar completamente despu√©s de la transici√≥n
        setTimeout(function () {
          document.querySelector('.loader').style.display = 'none';
        }, 500);
      });
    });
  </script>
  <script>



    var num_fil = new Array();

    var separa7 = " - ";

    var caractCheck = "‚úì";
    var listCheck = "";
    var ultimoId = "";

    var form_anio = "";
    var form_unid = "";
    var form_ncta = "";
    var form_desc = "";
    var form_pryt = "";
    var form_cmpr = "";

    var cmpr_tt = 0;          // Valor de la columna comprometido (Total de la cta)
    var cmpr_tx = "";         // Valor de la columna comprom-ID (valor de cada uno)
    var gast_tt = 0;          // Valor de la columna Gasto (Total de la cta)
    var gast_tx = "";         // Valor de la columna gasto-ID (valor de cada uno)
    var sald_tt = 0;          // Valor de la columna Saldo (Total de la cta)

    var separa1 = "&nbsp;";
    var separa5 = "/";        // Separador entre datos de los unitarios

    var fila_dt = 0;
    var fila_pac = 0;

    const anioActual = new Date().getFullYear();
    var este_anio = parseInt(anioActual);

    var maxDoc = "";
    var nnleer = 0;
    var nuevas = 0;
    var permiso = new Array();              // Permiso de la oficina (ejemplo: VMQ)
    permiso[0] = "";

    var xcompr = new Array();

    var antigu = new Array();
    var nuevod = new Array();

    var selec0 = "-- INGRESAR --";
    var permisott = "";

    var colmcta = 0;                        // Columna de Anexo donde esta el N¬∞ de cuenta & descripcion

    var chck1 = 0;                          // Check button para modificar registros

    var gast0 = "0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0";      // Valor inicial del Comprometido y del Gastado por cada compra

    var dato_dt = new Array();              // Todos los datos de la hoja DATOS
    var dat_PAC = new Array();              // Todos los datos de la hoja PAC
    var dato_nx = new Array();              // Todos los datos de la hoja Anexo
    var dato_1b = new Array();              // Todos los datos de la hoja Anexo

    var suggest = new Array();
    suggest = ["suggestionsDocument", "suggestionsDescripc", "suggestionsCuentas"];

    var sel_dept = "";                      // Seleccionar el tipo de DEPTO

    const WEB_APP_URL = dir_pac;     // Implementacion
    // const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw9TfE8-orUBNLrpOtchgrknOEoodAbGbutAS49SukUTwMTu6t3m4LWBScCV3MoFnY/exec';

    mostrarCargando_1(1);       // Activar la rueda de LOADING ....

    // ************************************************************************
    // ************************************************************************


    function mostrarToast(tmensaje, tcolor) {
      var toast = document.getElementById('toast1');
      toast.textContent = tmensaje;
      toast.style.backgroundColor = tcolor;
      toast.className = "show";
      setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
    }


    function guardarDatos() {

      select = document.getElementById("ncompra");
      var ncompra = select.value;
      if ((ncompra != "") && (ncompra != selec0)) {
        bauln = parseInt(xcompr[(parseInt(ncompra)) - 1]);       // 1 - NUEVO | 2 - PROCESO | 3 - TERMINADO
        if ((bauln == 3) && (chck1 == 0)) { alert("ESTE PROYECTO YA ESTA TERMINADO"); }
        if ((chck1 == 0) && ((bauln == 1) || (bauln == 2))) {    // Solo para NUEVO PROYECTO o EN PROCESO 
          error = 0;
          var tx_err = new Array();
          baulb = document.getElementById("new_fch").value;
          if (baulb != "") {
            const partes = baulb.split("-");
            // Reordenar: d√≠a / mes / a√±o
            baul1 = `${partes[2]}/${partes[1]}/${partes[0]}`;
          } else { baul1 = selec0; }
          baul2 = (document.getElementById("new_tip").value).toString().toUpperCase();
          baul3 = (document.getElementById("new_doc").value).toString().toUpperCase();
          baul4 = (document.getElementById("new_cmp").value).toString().toUpperCase();
          baul5 = (document.getElementById("new_gst").value).toString().toUpperCase();
          baul6 = (document.getElementById("new_inf").value).toString().toUpperCase();

          if (baul4 == "") { baul4 = "0"; }
          if (baul5 == "") { baul5 = "0"; }

          baul4 = baul4.replace(/\./g, '');   // Elimina los puntos de los valores comprometidos
          baul5 = baul5.replace(/\./g, '');   // Elimina los puntos de los valores gastados

          if ((baul1 == "") || (baul1 == selec0)) { tx_err[error] = "Falta la fecha"; error++; }
          if ((baul2 == "") || (baul2 == selec0)) { tx_err[error] = "Falta el proceso de compra"; error++; }
          if ((baul3 == "") || (baul3 == selec0)) { tx_err[error] = "Falta el documento adjunto"; error++; }
          // if ((baul4 == "") || (baul4 == selec0)) { tx_err[error] = "Falta el $ comprometido"; error++; }
          // if ((baul5 == "") || (baul5 == selec0)) { tx_err[error] = "Falta el $ del pago"; error++; }
          // if ((baul6 == "") || (baul6 == selec0)) { tx_err[error] = "Falta la informaci√≥n"; error++; }
          if ((baul7 == "") || (baul7 == selec0)) { tx_err[error] = "Falta el tipo de compra"; error++; }

          if (((baul4 != "0") && (baul4 != "")) && ((baul5 != "0") && (baul5 != ""))) { error = 20; }

          if (error == 0) {

            document.getElementById("cargandoOverlay").style.display = "flex";     // Mostrar mensaje Cargando ...

            baula = document.getElementById("numAnio").value;       // A√±o
            baulb = document.getElementById("nomUnid").value;       // Unidad
            baulc = document.getElementById("numCtas").value;       // Cuenta
            bauld = form_desc;                                      // Descripcion de la cuenta
            baule = document.getElementById("nomPryt").value;       // Proyecto o Servicio
            baulf = document.getElementById("ncompra").value;       // N¬∞ de Compra

            var envio = new Array();
            envio = [baula, baulb, baulc, bauld, baule, baulf, baul1, baul7, baul2, baul3, baul4, baul5, baul6];
            dato_dt.push(envio);
            enviarDatos("REGISTRO", 0, envio, 1);
            pp = 0;
            if ((baul4 != "0") && (baul4 != "")) { pp++; }
            if ((baul5 != "0") && (baul5 != "")) { pp++; }
            if (pp > 0) { modificar_PAC(); }
            pp = 0;
            // limpiarDatos();

          } else {
            if (error < 20) {
              baul = "";
              for (ii = 0; ii < tx_err.length; ii++) { baul = baul + "\n" + tx_err[ii]; }
              alert("Faltan los siguientes datos por completar:" + baul);
            }
            if (error == 20) {
              baul = "No puedes tener $ Comprometido y $ de Pago en un mismo proceso" + "\n" +
                "Solo puedes tener comprometido en la ELABORACION y el pago final en INFORME DE PAGO";
              alert(baul);
            }
          }
        }

        // ##########################################################################################

        if (chck1 == 1) {          // Guardar los datos MODIFICADOS

          var pp = 0;
          var error = 0;
          var tx_err = new Array();

          for (jj = 0; jj < antigu.length; jj++) {
            pp = 0;
            baul0 = (document.getElementById("infor[" + jj + "][0]").value);
            baul1 = transformarFecha(baul0);
            baul2 = (document.getElementById("infor[" + jj + "][1]").value).toString().toUpperCase();
            baul3 = (document.getElementById("infor[" + jj + "][2]").value).toString().toUpperCase();
            baul4 = (document.getElementById("infor[" + jj + "][3]").value).toString().toUpperCase();
            baula = (document.getElementById("infor[" + jj + "][4]").value).toString().toUpperCase();
            baulb = (document.getElementById("infor[" + jj + "][5]").value).toString().toUpperCase();
            if ((baul1 == "") || (baul1 == selec0)) { tx_err[error] = "Falta la fecha"; error++; }
            if ((baul2 == "") || (baul2 == selec0)) { tx_err[error] = "Falta el proceso de compra"; error++; }
            if ((baul3 == "") || (baul3 == selec0)) { tx_err[error] = "Falta el documento adjunto"; error++; }
            if ((baul4 == "") || (baul4 == selec0)) { tx_err[error] = "Falta el tipo de compra"; error++; }
            if ((baula != "") && (baula != "0")) { pp++; }
            if ((baulb != "") && (baulb != "0")) { pp++; }
            if (pp == 2) { tx_err[0] = "No puedes tener $ comprometido y $ gastado en la misma linea"; error++; }
          }

          if (error == 0) {

            baul_compra = 0;
            for (ii = 0; ii < antigu.length; ii++) {
              baul2 = (antigu[ii][4]).replace(/\./g, '').replace(/\D/g, '');      //Elimina los puntos
              baul3 = (antigu[ii][5]).replace(/\./g, '').replace(/\D/g, '');      //Elimina los puntos
              antigu[ii][4] = baul2;
              antigu[ii][5] = baul3;
              var baulm = new Array();
              baulm[0] = dato_dt[num_fil[ii]][0];     // A√±o
              baulm[1] = dato_dt[num_fil[ii]][1];     // Unidad o Departamento
              baulm[2] = dato_dt[num_fil[ii]][2];     // Cuenta
              baulm[3] = dato_dt[num_fil[ii]][3];     // Descripcion de la cuenta
              baulm[4] = dato_dt[num_fil[ii]][4];     // Proyecto
              baulm[5] = dato_dt[num_fil[ii]][5];     // N¬∞ de la compra
              baul_compra = parseInt(baulm[5]);
              for (jj = 0; jj < antigu[0].length; jj++) {
                baulm[jj + 6] = (document.getElementById("infor[" + ii + "][" + jj + "]").value).toString().toUpperCase();
              }
              baul1 = transformarFecha(baulm[6]);
              baul2 = (baulm[10]).replace(/\./g, '').replace(/\D/g, '');      //Elimina los puntos
              baul3 = (baulm[11]).replace(/\./g, '').replace(/\D/g, '');      //Elimina los puntos
              baulm[6] = baul1;
              baulm[10] = baul2;
              baulm[11] = baul3;
              nuevod.push(baulm);
            }

            var baulfila = 0;
            yy = 0;
            for (ii = 0; ii < antigu.length; ii++) {
              pp = 0;
              baulfila = -1;
              for (jj = 0; jj < antigu[ii].length; jj++) {
                if (antigu[ii][jj] !== nuevod[ii][jj + 6]) {
                  baulfila = num_fil[ii] + 1;
                  pp++;
                  yy++;
                  break;         // Si hay una diferencia se sale
                }
              }

              if (pp > 0) {      //Guarda la fila diferente

                dato_dt[num_fil[ii]] = nuevod[ii];
                dato_dt[num_fil[ii][10]] = formatearNumero2(nuevod[ii][10]);
                dato_dt[num_fil[ii][11]] = formatearNumero2(nuevod[ii][11]);
                enviarDatos("REGISTRO", baulfila, nuevod[ii], 1);

                baulc1 = 0;
                baulg1 = 0;
                for (ww = 0; ww < nuevod.length; ww++) {
                  baulc1 = baulc1 + parseInt((nuevod[ww][10]).replace(/\./g, '').replace(/\D/g, ''));
                  baulg1 = baulg1 + parseInt((nuevod[ww][11]).replace(/\./g, '').replace(/\D/g, ''));
                }

                baulp2 = parseInt((dat_PAC[fila_pac][7]).replace(/\./g, '').replace(/\D/g, ''));      // Presupuesto TOTAL en esta cuenta
                if (baulp2 == "") { baulp2 = 0; } else { baulp2 = parseInt(baulp2); }

                bauls2 = parseInt((dat_PAC[fila_pac][21]).replace(/\./g, '').replace(/\D/g, ''));      // Saldo TOTAL en esta cuenta
                if (bauls2 == "") { bauls2 = 0; } else { bauls2 = parseInt(bauls2); }

                baulc2 = parseInt((dat_PAC[fila_pac][17]).replace(/\./g, '').replace(/\D/g, ''));      // Comprometido TOTAL en esta cuenta
                if (baulc2 == "") { baulc2 = 0; } else { baulc2 = parseInt(baulc2); }
                baulcc = dat_PAC[fila_pac][18];      // Comprometido por cada proyecto
                if (baulcc == "") { baulcc = gast0; }
                var baulc3 = new Array();
                baulc3 = baulcc.split(separa5);
                baulc4 = parseInt(baulc3[baul_compra - 1]);

                baulg2 = parseInt((dat_PAC[fila_pac][19]).replace(/\./g, '').replace(/\D/g, ''));      // Gastado TOTAL en esta cuenta
                if (baulg2 == "") { baulg2 = 0; } else { baulg2 = parseInt(baulg2); }
                baulgg = dat_PAC[fila_pac][20];      // Gastado por cada proyecto
                if (baulgg == "") { baulgg = gast0; }
                var baulg3 = new Array();
                baulg3 = baulgg.split(separa5);
                baulg4 = parseInt(baulg3[baul_compra - 1]);

                pp = 0;

                if (baulg1 > 0) { baulc1 = 0; }

                if (baulc1 != baulc4) { pp++; }
                baulc3[baul_compra - 1] = baulc1;
                baulb1 = "";
                baulc9 = 0;
                for (ww = 0; ww < (baulc3.length - 1); ww++) {
                  baulb1 = baulb1 + (baulc3[ww]).toString() + separa5;
                  baulc9 = baulc9 + parseInt(baulc3[ww]);
                }
                baulb1 = baulb1 + (baulc3[(baulc3.length - 1)]).toString();
                baulc9 = baulc9 + parseInt(baulc3[(baulc3.length - 1)]);
                baulcc = baulb1;
                pp++;


                if (baulg1 != baulg4) { pp++; }
                baulg3[baul_compra - 1] = baulg1;
                baulb1 = "";
                baulg9 = 0;
                for (ww = 0; ww < (baulg3.length - 1); ww++) {
                  baulb1 = baulb1 + (baulg3[ww]).toString() + separa5;
                  baulg9 = baulg9 + parseInt(baulg3[ww]);
                }
                baulb1 = baulb1 + (baulg3[(baulg3.length - 1)]).toString();
                baulg9 = baulg9 + parseInt(baulc3[(baulg3.length - 1)]);
                baulgg = baulb1;
                pp++;

                if ((baulcc != dat_PAC[fila_pac][18]) || (baulgg != dat_PAC[fila_pac][20])) { pp++; }

                if ((baulp2 - (baulc9 + baulg9)) != bauls2) { pp++; }

                bauls3 = baulp2 - (baulc9 + baulg9);

                if (bauls3 != bauls2) { pp++; }

                if (pp > 0) {
                  ff = fila_pac;
                  bauls2 = baulp2 - (baulc2 + baulg2);
                  envio = [dat_PAC[ff][0], dat_PAC[ff][1], dat_PAC[ff][2], dat_PAC[ff][3], dat_PAC[ff][4],
                  dat_PAC[ff][5], dat_PAC[ff][6], dat_PAC[ff][7], dat_PAC[ff][8], dat_PAC[ff][9],
                  dat_PAC[ff][10], dat_PAC[ff][11], dat_PAC[ff][12], dat_PAC[ff][13], dat_PAC[ff][14],
                  dat_PAC[ff][15], dat_PAC[ff][16], (baulc9).toString(), baulcc,
                  (baulg9).toString(), baulgg, (bauls3).toString()];
                  dat_PAC[ff][17] = (baulc9).toString();
                  dat_PAC[ff][18] = (baulcc).toString();
                  dat_PAC[ff][19] = (baulg9).toString();
                  dat_PAC[ff][20] = (baulgg).toString();
                  dat_PAC[ff][21] = (bauls3).toString();
                  enviarDatos("PAC", fila_pac + 1, envio, 1);           // Enviar la modificacion del PAC
                  // alert("Se modifico una linea del PAC");
                }


              }
            }
            if (yy == 0) {
              alert("No hay ningun registro por modificar");
            }
            if (yy > 0) {
              alert("Felicidades, se modificaron " + yy + " registros.");
              chck1 = 0;
              modificar_chck();
            }
            yy = 0;

          } else {
            baul = "";
            for (ii = 0; ii < tx_err.length; ii++) { baul = baul + "\n" + tx_err[ii]; }
            alert("Faltan los siguientes datos por completar:" + baul);
          }

        }
      }

      // --------- Llena la tabla de presupuesto, comprometido, gastos y saldo final de la CTA -----------

      tablaContainer = document.getElementById('tabla-container1');
      tablaContainer.innerHTML = "";
      let table = "";

      table = "<br><center><table id='tabla1' border=1>";
      table += "<tr><td>&nbsp;&nbsp;<b>PRESUPUESTO ANUAL&nbsp;&nbsp;<br>&nbsp;&nbsp;DE LA CUENTA</b>&nbsp;&nbsp;</td>";
      table += "<td>&nbsp;&nbsp;<b>Monto ($)&nbsp;&nbsp;<br>&nbsp;&nbsp;Comprometido</b>&nbsp;&nbsp;</td>";
      table += "<td>&nbsp;&nbsp;<b>Monto real&nbsp;&nbsp;<br>&nbsp;&nbsp;Pagado (Gastado)</b>&nbsp;&nbsp;</td>";
      table += "<td>&nbsp;&nbsp;<b>SALDO EFECTIVO&nbsp;&nbsp;<br>&nbsp;&nbsp;de la Cuenta</b>&nbsp;&nbsp;</td></tr>";

      baul1 = formatearNumero2(dat_PAC[xx][7].replace(/\./g, ""));
      baul2 = formatearNumero2(dat_PAC[xx][17].replace(/\./g, ""));
      baul3 = formatearNumero2(dat_PAC[xx][19].replace(/\./g, ""));
      baul4 = formatearNumero2(dat_PAC[xx][21].replace(/\./g, ""));
      table += "<tr>";
      table += "<td style='color: blue;'><b>" + baul1 + "</b></td>";
      table += "<td style='color: red;' ><b>" + baul2 + "</b></td>";
      table += "<td style='color: red;' ><b>" + baul3 + "</b></td>";
      table += "<td style='color: blue;'><b>" + baul4 + "</b></td></tr>";
      table += "</table></center><p>&nbsp;<br>";
      tablaContainer.innerHTML = table;
    }


    function modificar_PAC() {

      baulf = parseInt(document.getElementById("ncompra").value);       // N¬∞ de Compra

      if ((fila_pac > 0) && (baulf > 0)) {

        jj = fila_pac;
        var modi_PAC = new Array();
        modi_PAC = dat_PAC[jj];

        var compr_PAC = new Array();
        var gasto_PAC = new Array();

        baul5 = (document.getElementById("new_cmp").value).toString().toUpperCase();
        baul5 = baul5.replace(/\./g, '');   // Elimina los puntos de los valores comprometidos
        if (baul5 == "") { baul5 = "0"; }
        baul8 = parseInt(baul5);

        baul6 = (document.getElementById("new_gst").value).toString().toUpperCase();
        baul6 = baul6.replace(/\./g, '');   // Elimina los puntos de los valores gastados
        if (baul6 == "") { baul6 = "0"; }
        baul9 = parseInt(baul6);


        // --------- Modificar lo COMPROMETIDO
        if ((baul5 != "0") || (baul6 != "0")) {
          if (baul6 != "0") { baul5 = "0"; }
          compr_PAC = (modi_PAC[18]).split(separa5);
          compr_PAC[baulf - 1] = baul5;
          bauls = "";
          bauln = 0;
          for (ii = 0; ii < (compr_PAC.length - 1); ii++) {
            bauls = bauls + (compr_PAC[ii]).replace(/\./g, "") + separa5;
            bauln = bauln + parseInt(compr_PAC[ii]);
          }
          bauls = bauls + compr_PAC[compr_PAC.length - 1];
          modi_PAC[17] = (bauln).toString().toUpperCase();
          modi_PAC[18] = bauls;
        }

        // --------- Modificar los PAGOS (GASTOS)
        if (baul6 != "0") {
          gasto_PAC = (modi_PAC[18]).split(separa5);
          gasto_PAC[baulf - 1] = baul6;
          bauls = "";
          bauln = 0;
          for (ii = 0; ii < (gasto_PAC.length - 1); ii++) {
            bauls = bauls + (gasto_PAC[ii]).replace(/\./g, "") + separa5;
            bauln = bauln + parseInt(gasto_PAC[ii]);
          }
          bauls = bauls + gasto_PAC[gasto_PAC.length - 1];
          modi_PAC[19] = (bauln).toString().toUpperCase();
          modi_PAC[20] = bauls;
        }


        baula = parseInt(modi_PAC[7].replace(/\./g, ""));
        baulb = parseInt(modi_PAC[17].replace(/\./g, ""));
        baulc = parseInt(modi_PAC[19].replace(/\./g, ""));
        bauld = baula - (baulb + baulc);
        modi_PAC[21] = (bauld).toString().toUpperCase();

        enviarDatos("PAC", fila_pac + 1, modi_PAC, 1);           // Enviar la modificacion del PAC

      }

    }



    function enviarDatos(pagina, fila, datos, tipo) {

      fetch(WEB_APP_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pagina, fila, datos, tipo })
      })
        .then(() => {
          // mostrarToast('Datos enviados exitosamente üéâ', '#27ae60');
          // alert('Datos enviados exitosamente');
          document.getElementById("cargandoOverlay").style.display = "none";     // Ocultar mensaje Cargando ...
          ingresar_compra1();
          window.scrollTo({ top: 0, behavior: 'smooth' });                       // Scroll al inicio con animacion                                            // Scroll sin animaci√≥n
        })
        .catch(error => {
          // console.error('Error al enviar datos:', error);
          // mostrarToast('Error al enviar los datos.', '#e74c3c');
          alert('Error al enviar los datos');
        })
        .finally(() => {
        });

    }



    function limpiarDatos() { location.reload(); }



    function borrar_div(nn) {
      if (nn > 0) {
        for (jj = 0; jj < suggest.length; jj++) {
          if ((jj + 1) != nn) { document.getElementById(suggest[jj]).innerHTML = ""; }
        }
      }
      if (nn == 0) {
        for (jj = 0; jj < suggest.length; jj++) { document.getElementById(suggest[jj]).innerHTML = ""; }
      }
    }



    function cargando_icon(nn) {        // Rueda de carga (LOADING ...)
      const spinner = document.getElementById('spinner-container');
      if (nn === 1) {
        spinner.style.display = 'block';
      } else {
        spinner.style.display = 'none';
      }
    }


    // ************************************************************************
    // ************************************************************************


    var select = document.getElementById("numAnio");
    select.innerHTML = "";
    var delta = 0;
    for (jj = 0; jj < 4; jj++) {
      if (jj == 0) {
        let option = document.createElement('option');
        option.value = "0";
        option.text = selec0;
        select.appendChild(option);
      }
      baul = ((este_anio + delta) - jj);
      let option = document.createElement('option');
      option.value = (baul).toString();
      option.text = (baul).toString();
      select.appendChild(option);
    }
    form_anio = (este_anio).toString();
    select.value = form_anio;
    continuar_nomUnid();




    fetch(WEB_APP_URL + "?h=PRA")           // Lee las hojas PAC, REGISTRO y Anexo
      .then(response => response.json())
      .then(data => {
        // Asigna los datos recibidos a las variables bidimensionales
        dat_PAC = data.dat_PAC;    // Datos de la hoja "PAC"
        dato_dt = data.dato_dt;    // Datos de la hoja "Registro"
        dato_nx = data.dato_nx;    // Datos de la hoja "Anexo"
        mostrarCargando_1(0);

        if (dat_PAC.length > 0) {
          nnleer++;
          if (nnleer == 2) { cargando_icon(0); }
          if ((form_anio != "") && (form_anio != "0")) { llenar_select_unid(); }
        }
        if (dato_nx.length > 0) {
          nnleer++;
          if (nnleer == 2) { cargando_icon(0); }
        }
      })
      .catch(error => {
        console.error('Error al obtener los datos:', error);
      });


    // *****************************************************************
    // *****************************************************************



    function continuar_nomUnid() {       // Lee el a√±o y va a rellenar el select de la UNIDAD
      form_anio = document.getElementById("numAnio").value;
      baul = parseInt(form_anio);
      if ((baul > 2020) && (baul < (este_anio + 1))) {
        tablaContainer = document.getElementById('tabla-container2');
        tablaContainer.innerHTML = "";
        document.getElementById("ncompra").innerHTML = "";
        if (dat_PAC.length > 0) { llenar_select_unid(); }
      }
    }

    function continuar_nomCtas() {       // Lee la unidad y va a rellenar el select de la CUENTAS
      form_unid = document.getElementById("nomUnid").value;
      if ((form_unid != "") && (form_unid != selec0)) {
        tablaContainer = document.getElementById('tabla-container2');
        tablaContainer.innerHTML = "";
        document.getElementById("ncompra").innerHTML = "";
        llenar_select_ctas();
      }
    }

    function continuar_proyect() {       // Lee la cuenta y va a rellenar el select de los Proyectos
      form_ncta = document.getElementById("numCtas").value;
      if ((form_ncta != "") && (form_ncta != selec0)) {
        tablaContainer = document.getElementById('tabla-container2');
        tablaContainer.innerHTML = "";
        document.getElementById("ncompra").innerHTML = "";
        llenar_select_pryt();
      }
    }

    function ingresar_datos() {          // YA PUEDE LLENAR LOS DATOS DEL PROYECTO
      form_pryt = document.getElementById("nomPryt").value;
      if ((form_pryt != "") && (form_pryt != selec0)) {
        document.getElementById("div_s0").removeAttribute("hidden");
        document.getElementById("div_s2").setAttribute("hidden", "");
        document.getElementById("div_s1").removeAttribute("hidden");
        tablaContainer = document.getElementById('tabla-container2');
        tablaContainer.innerHTML = "";
        document.getElementById("ncompra").innerHTML = "";
        llenar_informacion();
      }
    }



    if (nnleer == 2) {
      if (document.getElementById("area").value != "0") {
        tablaContainer = document.getElementById('tabla-container2');
        tablaContainer.innerHTML = "";
        document.getElementById("ncompra").innerHTML = "";
        llenar_select();
      }
    }


    // **************** SELECT PARA ELEGIR EL PROYECTO **************************


    function llenar_select_unid() {          // Llenar los select de las UNIDADES
      // Suponiendo que dat_PAC[fila][1] contiene los nombres de las √°reas
      const nomUnidSet = new Set();

      // Recorremos dat_PAC para llenar el set con los valores √∫nicos de la columna 1 (A√±o)
      nomUnidSet.add(selec0);
      for (ii = 1; ii < dat_PAC.length; ii++) {
        var unidTx1 = (dat_PAC[ii][1]).toUpperCase();
        var baul1 = (dat_PAC[ii][0]).toString();
        if ((baul1 == form_anio) && (unidTx1 != "")) { nomUnidSet.add(unidTx1.trim().toUpperCase()); }
      }

      // Convertimos el set en un array y lo ordenamos alfab√©ticamente de A - Z
      const nomUnidOrdenadas = Array.from(nomUnidSet).sort((a, b) => a.localeCompare(b));

      // Obtenemos el select del DOM
      const select = document.getElementById("nomUnid");
      select.innerHTML = "";

      // Creamos y a√±adimos las opciones al select
      nomUnidOrdenadas.forEach(unidTx2 => {
        const option = document.createElement("option");
        option.value = unidTx2;
        option.textContent = unidTx2;
        select.appendChild(option);
      });
      select.value = selec0;
    }


    function llenar_select_ctas() {          // Llenar los select de las Cuentas
      // Suponiendo que dat_PAC[fila][1] contiene los nombres de las √°reas
      const nomCtasSet = new Set();

      // Recorremos dat_PAC para llenar el set con los valores √∫nicos de la columna 2 (Cuentas)
      nomCtasSet.add(selec0);
      for (ii = 1; ii < dat_PAC.length; ii++) {
        var unidTx1 = dat_PAC[ii][2] + separa7 + dat_PAC[ii][3];
        var baul1 = (dat_PAC[ii][0]).toString();
        var baul2 = (dat_PAC[ii][1]).toString().toUpperCase();
        if ((baul1 == form_anio) && (baul2 == form_unid) && (dat_PAC[ii][2] != "")) {
          nomCtasSet.add(unidTx1.trim().toUpperCase());
        }
      }

      // Convertimos el set en un array y lo ordenamos alfab√©ticamente de A - Z
      const nomCtasOrdenadas = Array.from(nomCtasSet).sort((a, b) => a.localeCompare(b));

      // Obtenemos el select del DOM
      const select = document.getElementById("numCtas");
      select.innerHTML = "";

      // Creamos y a√±adimos las opciones al select
      nomCtasOrdenadas.forEach(unidTx2 => {
        var unidTx7 = new Array();
        unidTx7 = (unidTx2).split(separa7);
        const option = document.createElement("option");
        option.value = unidTx7[0];
        option.textContent = unidTx2;
        select.appendChild(option);
      });
      select.value = selec0;
    }


    function llenar_select_pryt() {          // Llenar los select de los Proyectos

      // Suponiendo que dat_PAC[fila][1] contiene los nombres de las √°reas
      const nomPrytSet = new Set();

      // Recorremos dat_PAC para llenar el set con los valores √∫nicos de la columna 2 (Cuentas)
      nomPrytSet.add(selec0);
      for (ii = 1; ii < dat_PAC.length; ii++) {
        var unidTx1 = dat_PAC[ii][4];
        var baul1 = (dat_PAC[ii][0]).toString();
        var baul2 = (dat_PAC[ii][1]).toString().toUpperCase();
        var baul3 = (dat_PAC[ii][2]).toString().toUpperCase();
        if ((baul1 == form_anio) && (baul2 == form_unid) && (baul3 == form_ncta) && (unidTx1 != "")) {
          form_desc = (dat_PAC[ii][3]).toString().toUpperCase();
          nomPrytSet.add(unidTx1.trim().toUpperCase());
        }
      }

      // Convertimos el set en un array y lo ordenamos alfab√©ticamente de A - Z
      const nomPrytOrdenadas = Array.from(nomPrytSet).sort((a, b) => a.localeCompare(b));

      // Obtenemos el select del DOM
      const select = document.getElementById("nomPryt");
      select.innerHTML = "";

      // Creamos y a√±adimos las opciones al select
      nomPrytOrdenadas.forEach(unidTx2 => {
        const option = document.createElement("option");
        option.value = unidTx2;
        option.textContent = unidTx2;
        select.appendChild(option);
      });
      select.value = selec0;

    }


    // **************** LLENADO DE INFORMACION DEL PROYECTO **************************


    function llenar_informacion() {         // Llenar todos los select normales

      form_anio = document.getElementById("numAnio").value;
      form_unid = document.getElementById("nomUnid").value;
      form_ncta = document.getElementById("numCtas").value;
      form_pryt = document.getElementById("nomPryt").value;

      fila_pac = 0;
      for (ii = 1; ii < dat_PAC.length; ii++) {
        var unidTx1 = dat_PAC[ii][0];
        if (unidTx1 != "") {
          var baul0 = (dat_PAC[ii][0]).toString();
          var baul1 = (dat_PAC[ii][1]).toString().toUpperCase();
          var baul2 = (dat_PAC[ii][2]).toString().toUpperCase();
          var baul3 = (dat_PAC[ii][4]).toString().toUpperCase();
          if ((baul0 == form_anio) && (baul1 == form_unid) && (baul2 == form_ncta) && (baul3 == form_pryt)) {
            form_desc = (dat_PAC[ii][3]).toString().toUpperCase();
            fila_pac = ii;
          }
        } else {
          break;
        }
      }


      if (fila_pac > 0) {

        xx = fila_pac;
        num_oc = parseInt(dat_PAC[xx][8]);       // Numero de compras en ese Proyecto o Servicio
        tip_oc = parseInt(dat_PAC[xx][14]);      // Tipo de compra permitida

        cmpr_tt = dat_PAC[xx][17];               // Total comprometido en ese proyecto
        cmpr_tx = dat_PAC[xx][18];               // Comprometio en cada compra de ese Proyecto
        if (cmpr_tx == "") {
          cmpr_tx = gast0;
          dat_PAC[xx][18] = cmpr_tx;
          dat_PAC[xx][17] = "0";
        }

        gast_tt = dat_PAC[xx][19];               // Total gastado en este Proyecto o Servicio
        gast_tx = dat_PAC[xx][20];               // Gastado en cada compra de este proyecto
        if (gast_tx == "") {
          gast_tx = gast0;
          dat_PAC[xx][20] = gast_tx;
          dat_PAC[xx][19] = "0";
        }

        sald_tt = dat_PAC[xx][21];
        if (sald_tt == "") {
          baul = parseInt(dat_PAC[xx][7].replace(/\./g, ""));
          baul = baul - parseInt(dat_PAC[xx][17].replace(/\./g, ""));
          baul = baul - parseInt(dat_PAC[xx][19].replace(/\./g, ""));
          dat_PAC[xx][21] = (baul).toString().toUpperCase();
        }

        var cmpr_id = new Array();
        cmpr_id = cmpr_tx.split(separa5);

        var gast_id = new Array();
        gast_id = gast_tx.split(separa5);


        tablaContainer = document.getElementById('tabla-container1');
        tablaContainer.innerHTML = "";
        let table = "";

        table = "<br><center><table id='tabla1' border=1>";
        table += "<tr><td>&nbsp;&nbsp;<b>PRESUPUESTO ANUAL&nbsp;&nbsp;<br>&nbsp;&nbsp;DE LA CUENTA</b>&nbsp;&nbsp;</td>";
        table += "<td>&nbsp;&nbsp;<b>Monto ($)&nbsp;&nbsp;<br>&nbsp;&nbsp;Comprometido</b>&nbsp;&nbsp;</td>";
        table += "<td>&nbsp;&nbsp;<b>Monto real&nbsp;&nbsp;<br>&nbsp;&nbsp;Pagado (Gastado)</b>&nbsp;&nbsp;</td>";
        table += "<td>&nbsp;&nbsp;<b>SALDO EFECTIVO&nbsp;&nbsp;<br>&nbsp;&nbsp;de la Cuenta</b>&nbsp;&nbsp;</td></tr>";

        baul1 = formatearNumero2(dat_PAC[xx][7].replace(/\./g, ""));
        baul2 = formatearNumero2(dat_PAC[xx][17].replace(/\./g, ""));
        baul3 = formatearNumero2(dat_PAC[xx][19].replace(/\./g, ""));
        baul4 = formatearNumero2(dat_PAC[xx][21].replace(/\./g, ""));
        table += "<tr>";
        table += "<td style='color: blue;'><b>" + baul1 + "</b></td>";
        table += "<td style='color: red;' ><b>" + baul2 + "</b></td>";
        table += "<td style='color: red;' ><b>" + baul3 + "</b></td>";
        table += "<td style='color: blue;'><b>" + baul4 + "</b></td></tr>";
        table += "</table></center><p>&nbsp;<br>";

        tablaContainer.innerHTML = table;

        baul7 = "NN";
        if (tip_oc == 4) { baul7 = "concursal"; }
        if (tip_oc == 5) { baul7 = "TD"; }
        if (tip_oc == 6) { baul7 = "especial"; }

        // Obtenemos el select del DOM
        const select = document.getElementById("ncompra");
        select.innerHTML = "";

        pp = 0;
        qq = 0;

        for (ii = 0; ii < num_oc; ii++) {

          baul = "ERROR";
          if ((cmpr_id[ii] != "0") && (gast_id[ii] == "0")) { qq = 2; baul = "(EN PROCESO)"; }
          if ((cmpr_id[ii] == "0") && (gast_id[ii] == "0")) { qq = 1; baul = "(NUEVO)"; pp++; }
          if ((cmpr_id[ii] == "0") && (gast_id[ii] != "0")) { qq = 3; baul = "(TERMINADO)"; }

          baul1 = (ii + 1).toString();
          baul2 = (ii + 1).toString() + " " + baul;
          xcompr[ii] = qq;
          if (pp < 2) {

            if (ii == 0) {
              baulh = "";
              if (parseInt(num_oc) > 1) { baulh = "s"; }
              document.getElementById("pcompra").value = baul7;
              document.getElementById("lcompra").innerHTML = "(De " + num_oc + " compra" + baulh + ")";
              const option = document.createElement("option");
              option.value = selec0;
              option.textContent = selec0;
              select.appendChild(option);
            }

            const option = document.createElement("option");
            option.value = baul1;
            option.textContent = baul2;
            select.appendChild(option);
          }
        }
        select.value = selec0;
      }
    }


    function ingresar_compra1() {         // Llenar el select de los tipos de compras
      select = document.getElementById("ncompra");
      var ncompra = select.value;
      bauls = xcompr[parseInt(ncompra) - 1];
      if ((ncompra != "") && (ncompra != selec0) && (bauls != "ERROR")) {
        bauln = parseInt(xcompr[parseInt(ncompra) - 1]);       // 1 - Nuevo | 2 - Proceso | 3 - Terminado
        rellenar_cuadro(bauln);
      }
      if (bauls == "ERROR") {
        baulx = "Tienes un problema en la compra N¬∞ " + (ii + 1) + ":" + "\n" +
          "Tienes un $ comprometido y un $ de pago en la misma compra.";
        alert(baulx);
      }
    }



    function rellenar_cuadro(nn) {

      form_anio = document.getElementById("numAnio").value;
      form_unid = document.getElementById("nomUnid").value;
      form_ncta = document.getElementById("numCtas").value;
      form_pryt = document.getElementById("nomPryt").value;
      form_cmpr = document.getElementById("ncompra").value;

      tablaContainer = document.getElementById('tabla-container2');
      tablaContainer.innerHTML = "";         // Limpia la tabla de datos

      antigu.length = 0;                     // Limpia la variable antigu

      let table = "";
      pp = 0;


      if (nn == 1) {                                 // 1 - NUEVO

        table = "<table border=1>";
        table += "<tr><td><b>&nbsp;Fecha&nbsp;</b></td><td><b>&nbsp;Compra&nbsp;</b></td>";
        table += "<td><b>&nbsp;Proceso&nbsp;</b></td><td><b>&nbsp;Documento&nbsp;</b></td>";
        table += "<td><b>&nbsp;$ Compromet&nbsp;</b></td><td><b>&nbsp;$ Gastado&nbsp;</b></td>";
        table += "<td><b>&nbsp;Informacion&nbsp;</b></td>";
        table += "</tr>";

        table += "<tr><td><input type='date' id='new_fch' ></td>";
        table += "<td><select id='new_cot' onchange='rellenar_tipo_compra()'></select></td>";
        table += "<td><select id='new_tip'></select></td>";
        table += "<td><input type='text' id='new_doc'></td>";
        table += "<td><input type='text' id='new_cmp' oninput='formatearNumero(this)' value='0'></td>";
        table += "<td><input type='text' id='new_gst' oninput='formatearNumero(this)' value='0'></td>";
        table += "<td><input type='text' id='new_inf'></td></tr>";
        table += "</table>";
        tablaContainer.innerHTML = table;

        const select = document.getElementById("new_cot");
        select.innerHTML = "";

        for (ii = 0; ii < dato_nx[0].length; ii++) {
          baul22 = (dato_nx[0][ii]).toString().toUpperCase();
          if (baul22 == "") { break; }
          if (ii == 0) {
            const option = document.createElement("option");
            option.value = selec0;
            option.textContent = selec0;
            select.appendChild(option);
          }
          if (baul22 != "") {
            const option = document.createElement("option");
            option.value = baul22;
            option.textContent = baul22;
            select.appendChild(option);
          }
        }
        select.value = selec0;
      }


      if ((nn == 2) || (nn == 3)) {                  // 2 - Proceso | 3 - Terminado

        num_fil.length = 0;        // Limpia la variable num_fil
        var yy = 0;

        for (ii = 0; ii < dato_dt.length; ii++) {
          baul1 = (dato_dt[ii][0]).toString().toUpperCase();    // A√±o
          baul2 = (dato_dt[ii][1]).toString().toUpperCase();    // Unidad
          baul3 = (dato_dt[ii][2]).toString().toUpperCase();    // Cuenta
          baul4 = (dato_dt[ii][4]).toString().toUpperCase();    // Producto o Servicios
          baul5 = (dato_dt[ii][5]).toString().toUpperCase();    // N¬∞ de compra
          if ((form_anio == baul1) && (form_unid == baul2) && (form_ncta == baul3) && (form_pryt == baul4) && (form_cmpr == baul5)) {
            fila_dt = ii;
            if (pp == 0) {

              table = "<table border=1>";
              table += "<tr><td><b>&nbsp;Fecha&nbsp;</b></td><td><b>&nbsp;Compra&nbsp;</b></td>";
              table += "<td><b>&nbsp;Proceso&nbsp;</b></td><td><b>&nbsp;Documento&nbsp;</b></td>";
              table += "<td><b>&nbsp;$ Compromet&nbsp;</b></td><td><b>&nbsp;$ Gastado&nbsp;</b></td>";
              table += "<td><b>&nbsp;Informacion&nbsp;</b></td>";
              table += "</tr>";
            }

            var baulp = new Array();
            baulp[0] = separa1 + dato_dt[ii][6];
            baulp[1] = separa1 + dato_dt[ii][7];
            baulp[2] = separa1 + dato_dt[ii][8];
            baulp[3] = separa1 + dato_dt[ii][9];
            baulp[4] = separa1 + formatearNumero2(dato_dt[ii][10]);
            baulp[5] = separa1 + formatearNumero2(dato_dt[ii][11]);
            baulp[6] = separa1 + dato_dt[ii][12];
            if (chck1 == 1) {
              var filnn = 0;
              baulq = oficesarFechaTexto(dato_dt[ii][6]);
              baulp[0] = "<input type='date' id='infor[" + pp + "][0]' value='" + baulq + "'>";

              baulq = "<select id='infor[" + pp + "][1]'>";
              for (rr = 0; rr < dato_nx[0].length; rr++) {
                opcion9 = "";
                if (dato_nx[0][rr] == "") { break; }
                if (dato_nx[0][rr] == dato_dt[ii][7]) { opcion9 = "selected"; filnn = rr + 1; }
                baulq = baulq + "<option value = '" + dato_nx[0][rr] + "' " + opcion9 + ">" + dato_nx[0][rr] + "</option>";
              }
              baulq = baulq + "</select>";
              baulp[1] = baulq;

              baulq = "<select id='infor[" + pp + "][2]'>";
              if (filnn > 0) {
                filnn = filnn - 1;
                for (rr = 1; rr < dato_nx.length; rr++) {
                  opcion9 = "";
                  if (dato_nx[rr][filnn] == "") { break; }
                  if (dato_nx[rr][filnn] == dato_dt[ii][8]) { opcion9 = "selected"; filn = ii + 1; }
                  baulq = baulq + "<option value = '" + dato_nx[rr][filnn] + "' " + opcion9 + ">" + dato_nx[rr][filnn] + "</option>";
                }
                baulq = baulq + "</select>";
                baulp[2] = baulq;
              }

              baulp[3] = "<input type='text' id='infor[" + pp + "][3]' value='" + dato_dt[ii][9] + "'>";
              baulp[4] = "<input type='text' id='infor[" + pp + "][4]' value='" + dato_dt[ii][10] + "' oninput='formatearNumero(this)'>";
              baulp[5] = "<input type='text' id='infor[" + pp + "][5]' value='" + dato_dt[ii][11] + "' oninput='formatearNumero(this)'>";
              baulp[6] = "<input type='text' id='infor[" + pp + "][6]' value='" + dato_dt[ii][12] + "'>";

            }

            // baul6 = oficesarFechaTexto(dato_dt[ii][6]);
            baul7 = dato_dt[ii][7];
            table += "<tr><td>" + baulp[0] + "</td>";            // Fecha
            table += "<td>" + baulp[1] + "</td>";                // Tipo de Compra
            table += "<td>" + baulp[2] + "</td>";                // Proceso de la compra
            table += "<td>" + baulp[3] + "</td>";                // Documento
            table += "<td>" + baulp[4] + "</td>";                // Comprometido
            table += "<td>" + baulp[5] + "</td>";                // Gastado
            table += "<td>" + baulp[6] + "</td></tr>";           // Informacion
            pp++;
            num_fil[yy] = ii;          // Guarda la fila en la que se leyo este dato
            antigu.push([dato_dt[ii][6], dato_dt[ii][7], dato_dt[ii][8], dato_dt[ii][9], dato_dt[ii][10], dato_dt[ii][11], dato_dt[ii][12]]);
            yy++;
          }
        }

        if ((nn == 2) && (chck1 == 0)) {                   // En PROCESO

          if (pp > 0) {
            table += "<tr><td><input type='date' id='new_fch' ></td>";
            table += "<td>" + separa1 + baul7 + "</td>";
            table += "<td><select id='new_tip'></select></td>";
            table += "<td><input type='text' id='new_doc'></td>";
            table += "<td><input type='text' id='new_cmp' oninput='formatearNumero(this)' value='0'></td>";
            table += "<td><input type='text' id='new_gst' oninput='formatearNumero(this)' value='0'></td>";
            table += "<td><input type='text' id='new_inf'></td></tr>";
            table += "</table>";
            tablaContainer.innerHTML = table;
          }

          baul = -1;
          for (ii = 0; ii < 5; ii++) {
            if (baul7 == dato_nx[0][ii]) {
              baul = ii;
            }
          }
          if (baul > -1) {
            const select = document.getElementById("new_tip");
            select.innerHTML = "";
            for (ii = 1; ii < dato_nx.length; ii++) {
              baul22 = dato_nx[ii][baul];
              if (baul22 == "") { break; }
              if (ii == 1) {
                const option = document.createElement("option");
                option.value = selec0;
                option.textContent = selec0;
                select.appendChild(option);
              }
              const option = document.createElement("option");
              option.value = baul22;
              option.textContent = baul22;
              select.appendChild(option);
            }
            select.value = selec0;
          }
        }

        if (((nn == 2) && (chck1 == 1)) || (nn == 3)) {
          baul7 = "0";
          table += "</table>";
          tablaContainer.innerHTML = table;
          // var contenedor_tabla2 = document.getElementById("cont_tabla2");
          // contenedor_tabla2.scrollTop = contenedor_tabla2.scrollHeight;
        }    // TERMINADO

      }
    }


    // ************************************************************************
    // ************************************************************************


    function rellenar_tipo_compra() {

      baul7 = (document.getElementById("new_cot").value).toString().toUpperCase();
      column = -5;
      for (ii = 0; ii < dato_nx[0].length; ii++) {
        baul2 = (dato_nx[0][ii]).toString().toUpperCase();
        if (baul7 == baul2) { column = ii; }
      }
      if (column > -1) {
        const select = document.getElementById("new_tip");
        select.innerHTML = "";

        for (ii = 1; ii < dato_nx.length; ii++) {
          baul22 = dato_nx[ii][column];
          if (baul22 == "") { break; }
          if (ii == 1) {
            const option = document.createElement("option");
            option.value = selec0;
            option.textContent = selec0;
            select.appendChild(option);
          }
          const option = document.createElement("option");
          option.value = baul22;
          option.textContent = baul22;
          select.appendChild(option);
        }
        select.value = selec0;
      }
    }


    // ************************************************************************
    // ************************************************************************
    // ************************************************************************
    // ************************************************************************


    function cerrarForm() {
      // window.close();
      // window.history.back();
      location.href = "formulario-1.html";
    }


    // ************************************************************************


    function formatearNumero(input) {
      // Eliminar puntos y caracteres no num√©ricos
      let valor = input.value.replace(/\./g, '').replace(/\D/g, '');
      // Convertir a n√∫mero y formatear con puntos
      let numeroFormateado = new Intl.NumberFormat('es-ES').format(valor);
      // Actualizar el valor del input con el formato correcto
      input.value = numeroFormateado;
    }


    function formatearNumero2(valor1) {
      // Eliminar puntos y caracteres no num√©ricos
      let valor2 = valor1.replace(/\./g, '').replace(/\D/g, '');
      // Convertir a n√∫mero y formatear con puntos
      let numeroFormateado = new Intl.NumberFormat('es-ES').format(valor2);
      // Actualizar el valor del input con el formato correcto
      return numeroFormateado;
    }


    // ###############################################################################


    // Pasar la fecha de TEXTO DD/MM/YYYY a una FECHA YYYY-MM-DD (DATE)
    function oficesarFechaTexto(fechaTexto) {
      const partes = fechaTexto.split('/');
      if (partes.length !== 3) return null; // Verifica que el formato sea correcto

      const dia2 = partes[0].padStart(2, '0');  // Asegura 2 d√≠gitos para el d√≠a
      const mes2 = partes[1].padStart(2, '0');  // Asegura 2 d√≠gitos para el mes
      const ano2 = partes[2].padStart(4, '0');  // Asegura 4 d√≠gitos para el a√±o

      // Devuelve la fecha en formato YYYY-MM-DD
      return `${ano2}-${mes2}-${dia2}`;
    }

    // *******************************************************************************

    // Pasar la fecha de un DATE YYY-MM-DD a un texto en formato DD/MM/YYYY
    function transformarFecha(fechaInput) {
      if (!fechaInput) {
        console.log("No se seleccion√≥ una fecha.");
        return null;
      }

      // Crear un objeto de fecha a partir del valor del input (YYYY-MM-DD)
      const fecha1 = new Date(fechaInput);
      fecha1.setHours(fecha1.getHours() + 12);

      // Extraer d√≠a, mes y a√±o, asegurando 2 d√≠gitos para d√≠a y mes y 4 digitos para el a√±o
      const dia1 = String(fecha1.getDate()).padStart(2, '0');
      const mes1 = String(fecha1.getMonth() + 1).padStart(2, '0');   // Los meses empiezan en 0
      const ano1 = String(fecha1.getFullYear());

      // Formatear la fecha como DD/MM/YYYY
      const fechaTexto = `${dia1}/${mes1}/${ano1}`;
      return fechaTexto;
    }


    function borrar_div(nn) { }


    function modificar_chck() {

      chck1 = (chck1 + 1) % 2;
      select = document.getElementById("ncompra");
      var ncompra = select.value;
      bauls = xcompr[parseInt(ncompra) - 1];
      if ((ncompra == selec0) || (bauls == 1)) {
        chck1 = 0;
      }
      if (chck1 == 1) {
        select = document.getElementById("ncompra");
        var ncompra = select.value;
        var userStr = localStorage.getItem('currentUser');
        if (userStr) {
          var user = JSON.parse(userStr);
          var username = (user.username).toString().toUpperCase();
          var nombre = prompt("Para modificar los datos, por favor ingresa tu nombre de usuario");
          var nombre = nombre.toString().toUpperCase();
          if (username != nombre) {
            alert("Acceso Denegado");
            chck1 = 0;
          }
          if (nombre === null) {
            chck1 = 0;
          }
        } else {
          alert("Acceso Denegado");
          chck1 = 0;
        }
      }
      select = document.getElementById("ncompra");
      var ncompra = select.value;
      bauls = xcompr[parseInt(ncompra) - 1];
      if ((ncompra != "") && (ncompra != selec0) && (bauls != "ERROR")) {
        bauln = parseInt(xcompr[parseInt(ncompra) - 1]);         // 1 - Nuevo | 2 - Proceso | 3 - Terminado
        rellenar_cuadro(bauln);
      }
    }


    function mostrarCargando_1(nn) {
      var overlay = document.getElementById('loading-overlay');
      if (nn == 1) { overlay.style.visibility = 'visible'; }
      if (nn == 0) { overlay.style.visibility = 'hidden'; }
    }



  </script>

</body>

</html>