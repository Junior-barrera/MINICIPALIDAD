<!DOCTYPE html>        <!-- --------- INGRESO DE DOCUMENTOS  --------- -->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Documentos</title>

    <style>
/* Reset bÃ¡sico */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

/* Fondo con degradado */
body {
  font-family: 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #c2e9fb, #a1c4fd);
  /* display: flex; */
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  padding: 40px;
  color: #333;
}

/* Contenedor del formulario estilo glassmorphism */
#cont_form {
  background: rgba(255, 255, 255, 0.25);
  border-radius: 20px;
  padding: 30px 40px;
  width: 100%;
  max-width: 800px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
  backdrop-filter: blur(8px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  animation: fadeIn 1s ease-in-out;
  text-align: center; /* Centra texto e inline-blocks */
}

/* AnimaciÃ³n de entrada */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Labels e inputs */
label {
  /* display: block; */
  font-weight: 600;
  margin-bottom: 8px;
  color: #2c3e50;
}

input, select, textarea {
  width: 100%;
  padding: 10px 12px;
  margin-bottom: 20px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 15px;
  transition: all 0.3s ease;
  background-color: #ffffffc7;
  text-transform: uppercase;
}

input:focus, select:focus, textarea:focus {
  border-color: #3498db;
  box-shadow: 0 0 8px rgba(52, 152, 219, 0.4);
  outline: none;
}

/* Botones */
.button1, .button2, .button3 {
  display: inline-block;
  padding: 10px 24px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 14px;
  text-transform: uppercase;
  cursor: pointer;
  transition: background-color 0.3s ease;
  margin-right: 10px;
  border: none;
}

.button1 {
  background-color: #27ae60;
  color: white;
}
.button1:hover {
  background-color: #1e8449;
}

.button2 {
  background-color: #e74c3c;
  color: white;
}
.button2:hover {
  background-color: #c0392b;
}

.button3 {
  background-color: #2980b9;
  color: white;
}
.button3:hover {
  background-color: #21618c;
}

/* Colores de texto */
.negritas {
  font-weight: bold;
}

.azul {
  color: #ffffff;
}

.listo {
  color: #2ecc71;
  font-weight: bold;
}

.color_suggestions {
  color: #8e44ad;
}

/* Separador */
hr {
  height: 2px;
  border: none;
  background: linear-gradient(to right, #3498db, #8e44ad);
  margin: 20px 0;
}


#spinner-container {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 9999;
}

.spinner {
  border: 6px solid #e38f8f;
  border-top: 6px solid #3fdb34;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

    </style>

</head>
<body>

  <div id="cont_form">

  <form id="formulario">

  <H2>FORMULARIO DE INGRESO DE COMPRAS</H2>
  
  <br>
  
  <b>AÃ±o </b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  <select id="numAnio" name="numAnio" style="width: 140px;" onchange="continuar_nomUnid()"  onclick="borrar_div(0)">
  </select>

  &nbsp;&nbsp;&nbsp;
  &nbsp;&nbsp;&nbsp;

  <!--
  <label class="listo" id="listoChck" name="listoChck" onclick="borrar_div(0)"></label>
  -->

  <div id="spinner-container"><div class="spinner"></div></div>       <!--  RUEDA DE ESPERA POR CARGA -->

  <br>

  <b>Unidad</b>&nbsp;&nbsp;&nbsp;&nbsp;
  <select id="nomUnid" name="nomUnid" style="width: 450px;" onchange="continuar_nomCtas()"  onclick="borrar_div(0)">
  </select>

  <br>

  <b>NÂ° CTA </b>&nbsp;&nbsp;&nbsp;
  <select id="numCtas" name="numCtas" style="width: 450px;" onchange="continuar_proyect()"  onclick="borrar_div(0)">
  </select>

  <br>

  <b>Proyecto</b>&nbsp;
  <select id="nomPryt" name="nomPryt" style="width: 450px;" onchange="ingresar_datos()"  onclick="borrar_div(0)">
  </select>

  <p>     <!-- *************** DATOS PARA DEL REGISTRO ******************* -->

  <div id="div_s0" hidden>
  
  <hr>&nbsp;<br> 
  
  <b>NÂ° Compra</b>&nbsp;
  <select id="ncompra" name="ncompra" style="width: 190px;" onchange="ingresar_compra1()"  onclick="borrar_div(0)">
  </select>
  &nbsp;&nbsp;&nbsp;
  <input type="txt" id="pcompra" name="pcompra" style="width: 100px;" onclick="borrar_div(0)" readonly>
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  <b><label id="lcompra"></label></b>


  <br>

  <div id="tabla-container"></div>      <!--  XXXXXXXXXXXXXXXXX  -->

  <br>


  <br>&nbsp;<br>

  <center>

  <div id="div_s1" hidden>
  <input class="button1" type="button" value="GUARDAR" onclick="guardarDatos()" style="width: 100px;">
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  <input class="button3" type="button" value="LIMPIAR" onclick="limpiarDatos()" style="width: 100px;">
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  <input class="button2" id="butt1" type="button" value="CERRAR" style="width: 100px;" onclick="cerrarForm()">
  </div>

  <div id="div_s2">
  <input class="button2" id="butt2" type="button" value="CERRAR" style="width: 100px;" onclick="cerrarForm()">
  </div>
  </center>


  <a style="display: none;">
    <input type="text" id="fanio"  name="fanio"  value="">
    <input type="text" id="fech1"  name="fech1"  value="">
    <input type="text" id="numCta" name="numCta" value="">
    <input type="text" id="nomCta" name="nomCta" value="">
    <input type="text" id="desembo2"  name="desembo2"  value="">
    
  </a>

  </form>

  </div>


  <script>
    

    // Sets para almacenar valores Ãºnicos
    var tipDocumentSet = new Set();
    var tipDescripcSet = new Set();
    var tipComentarSet = new Set();
    var tipNumeDocuSet = new Set();
    var permiSet = new Set();

    var tipDocument = new Array();        // Array con los Documentos
    var tipDescripc = new Array();        // Array con las Descripciones
    var tipComentar = new Array();        // Array con los Comentarios
    var tipNumeDocu = new Array();        // Array con los NÂ° de otros Documentos
    var tipNomCuent = new Array();        // Array con los Nombre de las Cuentas

    var separa7 = " - ";

    var caractCheck = "âœ“";
    var listCheck = "";
    var ultimoId = "";

    var form_anio = "";
    var form_unid = "";
    var form_ncta = "";
    var form_desc = "";
    var form_pryt = "";
    var form_cmpr = "";

    var cmpr_tt = 0;          // Valor de la columna comprometido (Total de la cta)
    var cmpr_tx = "";         // Valor de la columna comprom-ID (valor de cada uno)
    var gast_tt = 0;          // Valor de la columna Gasto (Total de la cta)
    var gast_tx = "";         // Valor de la columna gasto-ID (valor de cada uno)
    var sald_tt = 0;          // Valor de la columna Saldo (Total de la cta)

    var separa5 = "/";        // Separador entre datos de los unitarios

    var fila_dt  = 0;
    var fila_pac = 0;

    const anioActual = new Date().getFullYear();
    var este_anio = parseInt(anioActual);

    var maxDoc = "";
    var nnleer = 0;
    var nuevas = 0;
    var permiso = new Array();              // Permiso de la oficina (ejemplo: VMQ)
    permiso[0] = "";

    var xcompr = new Array();

    var selec0 = "-- INGRESAR --";
    var permisott = "";

    var colmcta = 0;                        // Columna de Anex 1a donde esta el NÂ° de cuenta & descripcion

    var dato_dt = new Array();              // Todos los datos de la hoja DATOS
    var dat_PAC = new Array();              // Todos los datos de la hoja PAC
    var dato_1a = new Array();              // Todos los datos de la hoja ANEX 1a
    var dato_1b = new Array();              // Todos los datos de la hoja ANEX 1b

    var suggest = new Array();
    suggest = [ "suggestionsDocument", "suggestionsDescripc", "suggestionsCuentas" ];

    var sel_dept = "";                      // Seleccionar el tipo de DEPTO


    const API_KEY = 'AIzaSyBM9AcgPgM6MzM04Rij1xuti1Uf-n2QUuI';                 // Clave de API
    const SPREADSHEET_ID = '1GEFe7QHsqxV2TX8CKxW4Awq0coKIw8Nq5xATl15ZoOE';     // DirecciÃ³n libro de Google Sheets

    
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzbw52YehlSlHxa4PyG9fYHBmoJon9kxCoSB0r26uLpXyjr-PUuXUWlgCfo0ZPyekw/exec';     // Implementacion

    cargando_icon(1);       // Activar la rueda de LOADING ....

    // ************************************************************************
    // ************************************************************************

    
    function mostrarToast(tmensaje, tcolor) {
      var toast = document.getElementById('toast1');
      toast.textContent = tmensaje;
      toast.style.backgroundColor = tcolor;
      toast.className = "show";
      setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
    }


    function guardarDatos() {
      
      select = document.getElementById("ncompra");
      var ncompra = select.value;
      if ((ncompra != "") && (ncompra != selec0)) {
        bauln = parseInt(xcompr[(parseInt(ncompra)) - 1]);      // 1 - NUEVO | 2 - PROCESO | 3 - TERMINADO
        if (bauln == 3) { alert("ESTE PROYECTO YA ESTA TERMINADO"); }
        if ((bauln == 1) || (bauln == 2)) {                     // Solo para NUEVO PROYECTO o EN PROCESO 
          error = 0;
          var tx_err = new Array();
          baulb = document.getElementById("new_fch").value;
          if (baulb != "") {
            const partes = baulb.split("-");
            // Reordenar: dÃ­a / mes / aÃ±o
            baul1 = `${partes[2]}/${partes[1]}/${partes[0]}`;
          } else { baul1 = selec0; }
          baul2 = (document.getElementById("new_tip").value).toString().toUpperCase();
          baul3 = (document.getElementById("new_doc").value).toString().toUpperCase();
          baul4 = (document.getElementById("new_cmp").value).toString().toUpperCase();
          baul5 = (document.getElementById("new_gst").value).toString().toUpperCase();
          baul6 = (document.getElementById("new_inf").value).toString().toUpperCase();

          baul5 = baul5.replace(/\./g, '');   // Elimina los puntos de los valores comprometidos
          baul6 = baul6.replace(/\./g, '');   // Elimina los puntos de los valores gastados

          if ((baul1 == "") || (baul1 == selec0)) { tx_err[error] = "Falta la fecha"; error++; }
          if ((baul2 == "") || (baul2 == selec0)) { tx_err[error] = "Falta el proceso de compra"; error++; }
          if ((baul3 == "") || (baul3 == selec0)) { tx_err[error] = "Falta el documento adjunto"; error++; }
          // if ((baul4 == "") || (baul4 == selec0)) { tx_err[error] = "Falta el $ comprometido"; error++; }
          // if ((baul5 == "") || (baul5 == selec0)) { tx_err[error] = "Falta el $ del pago"; error++; }
          // if ((baul6 == "") || (baul6 == selec0)) { tx_err[error] = "Falta la informaciÃ³n"; error++; }
          if ((baul7 == "") || (baul7 == selec0)) { tx_err[error] = "Falta el tipo de compra"; error++; }

          if (((baul4 != "0") && (baul4 != "")) && ((baul5 != "0") && (baul5 != ""))) {
            tx_err[error] = "Ya tienes un $ comprometido"; error++;
            tx_err[error] = "Ya tienes un $ del pago"; error++; 
          }
        
          if (error == 0) {

            baula = document.getElementById("numAnio").value;       // AÃ±o
            baulb = document.getElementById("nomUnid").value;       // Unidad
            baulc = document.getElementById("numCtas").value;       // Cuenta
            bauld = form_desc;                                      // Descripcion de la cuenta
            baule = document.getElementById("nomPryt").value;       // Proyecto o Servicio
            baulf = document.getElementById("ncompra").value;       // NÂ° de Compra

            var envio = new Array();
            envio = [ baula, baulb, baulc, bauld, baule, baulf, baul1, baul7, baul2, baul3, baul4, baul5, baul6 ];
            enviarDatos("REGISTRO", 0, envio);
            pp = 0;
            if ((baul5 != "0")  && (baul5 != "")) { pp++; }
            if ((baul6 != "0")  && (baul6 != "")) { pp++; }
            if (pp > 0) { modificar_PAC(); }
            pp = 0;

          } else {
            baul = "";
            for (ii = 0; ii < tx_err.length; ii++) { baul = baul + "\n" + tx_err[ii]; }
            alert("Faltan los siguientes datos por completar:" + baul);
          }
        }
      }
    }


    function modificar_PAC() {
      
      baulf = parseInt(document.getElementById("ncompra").value);       // NÂ° de Compra

      if ((fila_pac > 0) && (baulf > 0)) {

        jj = fila_pac;
        var modi_PAC = new Array();
        modi_PAC = dat_PAC[jj];
        
        var compr_PAC = new Array();
        var gasto_PAC = new Array();

        baul5 = (document.getElementById("new_cmp").value).toString().toUpperCase();
        baul5 = baul5.replace(/\./g, '');   // Elimina los puntos de los valores comprometidos

        baul6 = (document.getElementById("new_gst").value).toString().toUpperCase();
        baul6 = baul6.replace(/\./g, '');   // Elimina los puntos de los valores gastados

        if ((baul5 != "0")  && (baul5 != "")) {
          compr_PAC = (modi_PAC[19]).split(separa5);
          compr_PAC[baulf - 1] = baul5;
          bauls = "";
          bauln = 0;
          for (ii = 0; ii < (compr_PAC.length - 1); ii++) {
            bauls = bauls + compr_PAC[ii] + separa5;
            bauln = bauln + parseInt(compr_PAC[ii]);
          }
          bauls = bauls + compr_PAC[compr_PAC.length - 1];
          modi_PAC[18] = (bauln).toString().toUpperCase();
          modi_PAC[19] = bauls;
        }

        if ((baul6 != "0")  && (baul6 != "")) {
          gasto_PAC = (modi_PAC[19]).split(separa5);
          gasto_PAC[baulf - 1] = baul6;
          bauls = "";
          bauln = 0;
          for (ii = 0; ii < (gasto_PAC.length - 1); ii++) {
            bauls = bauls + gasto_PAC[ii] + separa5;
            bauln = bauln + parseInt(gasto_PAC[ii]);
          }
          bauls = bauls + gasto_PAC[gasto_PAC.length - 1];
          modi_PAC[20] = (bauln).toString().toUpperCase();
          modi_PAC[21] = bauls;
        }

        bauls = parseInt(modi_PAC[7]) - (parseInt(modi_PAC[18]) + parseInt(modi_PAC[20]));
        modi_PAC[22] = (bauls).toString().toUpperCase();

        enviarDatos("PAC", fila_pac + 1, modi_PAC);           // Enviar la modificacion del PAC

      }
      
    }



    function enviarDatos(pagina, fila, datos) {
 
      fetch(WEB_APP_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pagina, fila, datos })
      })
      .then(() => {
        // mostrarToast('Datos enviados exitosamente ðŸŽ‰', '#27ae60');
        alert('Datos enviados exitosamente');
      })
      .catch(error => {
        // console.error('Error al enviar datos:', error);
        // mostrarToast('Error al enviar los datos.', '#e74c3c');
        alert('Error al enviar los datos');
      })
      .finally(() => {
      });

    }



    function limpiarDatos() { location.reload(); }
    


    function borrar_div(nn) {
      if (nn > 0) {
        for (jj = 0; jj < suggest.length; jj++) {
          if ((jj + 1) != nn) { document.getElementById(suggest[jj]).innerHTML = ""; }
        }
      }
      if (nn == 0) {
        for (jj = 0; jj < suggest.length; jj++) { document.getElementById(suggest[jj]).innerHTML = ""; }
      }
    }



    function cargando_icon(nn) {        // Rueda de carga (LOADING ...)
      const spinner = document.getElementById('spinner-container');
      if (nn === 1) {
        spinner.style.display = 'block';
      } else {
        spinner.style.display = 'none';
      }
    }


    // ************************************************************************
    // ************************************************************************


    var select = document.getElementById("numAnio");
    select.innerHTML = "";
    var delta = 0;
    for (jj = 0; jj < 4; jj++) {
      if (jj == 0) {
        let option = document.createElement('option');
        option.value = "0";
        option.text  = selec0;
        select.appendChild(option);
      }
      baul = ((este_anio + delta) - jj);
      let option = document.createElement('option');
      option.value = (baul).toString();
      option.text  = (baul).toString();
      select.appendChild(option);
    }
    form_anio = (este_anio).toString();
    select.value = form_anio;
    continuar_nomUnid();


    

    fetch(WEB_APP_URL)
      .then(response => response.json())
      .then(data => {
        // Asigna los datos recibidos a las variables bidimensionales
        dat_PAC = data.dat_PAC;    // Datos de la hoja "PAC"
        dato_dt = data.dato_dt;    // Datos de la hoja "Registro"
        dato_1a = data.dato_1a;    // Datos de la hoja "Anex 1a"
        dato_1b = data.dato_1b;    // Datos de la hoja "Anex 1b"

        if (dat_PAC.length > 0) {
          nnleer++;
          listCheck = listCheck + caractCheck;
          if (nnleer == 2) { cargando_icon(0); }
          // document.getElementById("listoChck").innerHTML = listCheck;
          if ((form_anio != "") && (form_anio != "0")) { llenar_select_unid(); }
        }
        if (dato_1a.length > 0) {
          nnleer++;
          listCheck = listCheck + caractCheck;
          if (nnleer == 2) { cargando_icon(0); }
          // document.getElementById("listoChck").innerHTML = listCheck;
        }
      })
      .catch(error => {
        console.error('Error al obtener los datos:', error);
    });


    // *****************************************************************
    // *****************************************************************



    function continuar_nomUnid() {       // Lee el aÃ±o y va a rellenar el select de la UNIDAD
      form_anio = document.getElementById("numAnio").value;
      baul = parseInt(form_anio);
      if ((baul > 2020) && (baul < (este_anio + 1))) { 
        if (dat_PAC.length > 0) { llenar_select_unid(); }
      }
    }

    function continuar_nomCtas() {       // Lee la unidad y va a rellenar el select de la CUENTAS
      form_unid = document.getElementById("nomUnid").value;
      if ((form_unid != "") && (form_unid != selec0)) { llenar_select_ctas(); }
    }

    function continuar_proyect() {       // Lee la cuenta y va a rellenar el select de los Proyectos
      form_ncta = document.getElementById("numCtas").value;
      if ((form_ncta != "") && (form_ncta != selec0)) { llenar_select_pryt(); }
    }

    function ingresar_datos() {          // YA PUEDE LLENAR LOS DATOS DEL PROYECTO
      form_pryt = document.getElementById("nomPryt").value;
      if ((form_pryt != "") && (form_pryt != selec0)) {
        document.getElementById("div_s0").removeAttribute("hidden");
        document.getElementById("div_s2").setAttribute("hidden", "");
        document.getElementById("div_s1").removeAttribute("hidden");
        llenar_informacion(); 
      }
    }


    
    if (nnleer == 2) {
      if (document.getElementById("area").value != "0") { llenar_select(); }
    }
    
    
    // **************** SELECT PARA ELEGIR EL PROYECTO **************************


    function llenar_select_unid() {          // Llenar los select de las UNIDADES
      // Suponiendo que dat_PAC[fila][1] contiene los nombres de las Ã¡reas
      const nomUnidSet = new Set();

      // Recorremos dat_PAC para llenar el set con los valores Ãºnicos de la columna 1 (AÃ±o)
      nomUnidSet.add(selec0);
      for (ii = 1; ii < dat_PAC.length; ii++) {
        var unidTx1 = (dat_PAC[ii][1]).toUpperCase();
        var baul1 = (dat_PAC[ii][0]).toString();
        if ((baul1 == form_anio) && (unidTx1 != "")) { nomUnidSet.add(unidTx1.trim().toUpperCase()); }
      }

      // Convertimos el set en un array y lo ordenamos alfabÃ©ticamente de A - Z
      const nomUnidOrdenadas = Array.from(nomUnidSet).sort((a, b) => a.localeCompare(b));

      // Obtenemos el select del DOM
      const select = document.getElementById("nomUnid");
      select.innerHTML = "";

      // Creamos y aÃ±adimos las opciones al select
      nomUnidOrdenadas.forEach(unidTx2 => {
        const option = document.createElement("option");
        option.value = unidTx2;
        option.textContent = unidTx2;
        select.appendChild(option);
      });
      select.value = selec0;
    }


    function llenar_select_ctas() {          // Llenar los select de las Cuentas
      // Suponiendo que dat_PAC[fila][1] contiene los nombres de las Ã¡reas
      const nomCtasSet = new Set();
      
      // Recorremos dat_PAC para llenar el set con los valores Ãºnicos de la columna 2 (Cuentas)
      nomCtasSet.add(selec0);
      for (ii = 1; ii < dat_PAC.length; ii++) {
        var unidTx1 = dat_PAC[ii][2] + separa7 + dat_PAC[ii][3];
        var baul1 = (dat_PAC[ii][0]).toString();
        var baul2 = (dat_PAC[ii][1]).toString().toUpperCase();
        if ((baul1 == form_anio) && (baul2 == form_unid) && (dat_PAC[ii][2] != "")) { 
          nomCtasSet.add(unidTx1.trim().toUpperCase());
        }
      }

      // Convertimos el set en un array y lo ordenamos alfabÃ©ticamente de A - Z
      const nomCtasOrdenadas = Array.from(nomCtasSet).sort((a, b) => a.localeCompare(b));

      // Obtenemos el select del DOM
      const select = document.getElementById("numCtas");
      select.innerHTML = "";

      // Creamos y aÃ±adimos las opciones al select
      nomCtasOrdenadas.forEach(unidTx2 => {
        var unidTx7 = new Array();
        unidTx7 = (unidTx2).split(separa7);
        const option = document.createElement("option");
        option.value = unidTx7[0];
        option.textContent = unidTx2;
        select.appendChild(option);
      });
      select.value = selec0;
    }

    
    function llenar_select_pryt() {          // Llenar los select de los Proyectos
      
      // Suponiendo que dat_PAC[fila][1] contiene los nombres de las Ã¡reas
      const nomPrytSet = new Set();

      // Recorremos dat_PAC para llenar el set con los valores Ãºnicos de la columna 2 (Cuentas)
      nomPrytSet.add(selec0);
      for (ii = 1; ii < dat_PAC.length; ii++) {
        var unidTx1 = dat_PAC[ii][4];
        var baul1 = (dat_PAC[ii][0]).toString();
        var baul2 = (dat_PAC[ii][1]).toString().toUpperCase();
        var baul3 = (dat_PAC[ii][2]).toString().toUpperCase();
        if ((baul1 == form_anio) && (baul2 == form_unid) && (baul3 == form_ncta) && (unidTx1 != "")) {
          form_desc = (dat_PAC[ii][3]).toString().toUpperCase();
          nomPrytSet.add(unidTx1.trim().toUpperCase());
        }
      }

      // Convertimos el set en un array y lo ordenamos alfabÃ©ticamente de A - Z
      const nomPrytOrdenadas = Array.from(nomPrytSet).sort((a, b) => a.localeCompare(b));

      // Obtenemos el select del DOM
      const select = document.getElementById("nomPryt");
      select.innerHTML = "";

      // Creamos y aÃ±adimos las opciones al select
      nomPrytOrdenadas.forEach(unidTx2 => {
        const option = document.createElement("option");
        option.value = unidTx2;
        option.textContent = unidTx2;
        select.appendChild(option);
      });
      select.value = selec0;

    }


    // **************** LLENADO DE INFORMACION DEL PROYECTO **************************


    function llenar_informacion() {         // Llenar todos los select normales

      form_anio = document.getElementById("numAnio").value;
      form_unid = document.getElementById("nomUnid").value;
      form_ncta = document.getElementById("numCtas").value;
      form_pryt = document.getElementById("nomPryt").value;

      fila_pac = 0;
      for (ii = 1; ii < dat_PAC.length; ii++) {
        var unidTx1 = dat_PAC[ii][0];
        if (unidTx1 != "") {
          var baul0 = (dat_PAC[ii][0]).toString();
          var baul1 = (dat_PAC[ii][1]).toString().toUpperCase();
          var baul2 = (dat_PAC[ii][2]).toString().toUpperCase();
          var baul3 = (dat_PAC[ii][4]).toString().toUpperCase();
          if ((baul0 == form_anio) && (baul1 == form_unid) && (baul2 == form_ncta) && (baul3 == form_pryt)) {
            form_desc = (dat_PAC[ii][3]).toString().toUpperCase(); 
            fila_pac = ii;
          }
        } else {
          break;
        }
      }


      if (fila_pac > 0) {

        xx = fila_pac;
        num_oc = parseInt(dat_PAC[xx][9 ]);      // Numero de compras en ese Proyeceto o Servicio
        tip_oc = parseInt(dat_PAC[xx][15]);      // Tipo de compra permitida

        cmpr_tt = dat_PAC[xx][18];               // Total comprometido en ese proyecto
        cmpr_tx = dat_PAC[xx][19];               // Comprometio en cada compra de ese Proyecto
        if (cmpr_tx == "") {
          baul = "";
          for (ii=0; ii<(num_oc - 1); ii++) { baul = baul + "0" + separa5; }
          cmpr_tx = baul + "0";
          dat_PAC[xx][19] = cmpr_tx;
        }

        gast_tt = dat_PAC[xx][20];             // Total gastado en este Proyecto o Servicio
        gast_tx = dat_PAC[xx][21];             // Gastado en cada compra de este proyecto
        if (gast_tx == "") {
          baul = "";
          for (ii=0; ii<(num_oc - 1); ii++) { baul = baul + "0" + separa5; }
          gast_tx = baul + "0";
          dat_PAC[xx][21] = gast_tx;
        }

        sald_tt = dat_PAC[xx][22];

        var cmpr_id = new Array();
        cmpr_id = cmpr_tx.split(separa5);

        var gast_id = new Array();
        gast_id = gast_tx.split(separa5);


        baul7 = "NN";
        if (tip_oc == 4) { baul7 = "concursal"; }
        if (tip_oc == 5) { baul7 = "TD"; }
        if (tip_oc == 6) { baul7 = "especial"; }
        
        // Obtenemos el select del DOM
        const select = document.getElementById("ncompra");
        select.innerHTML = "";

        pp = 0;
        qq = 0;

        for (ii = 0; ii < num_oc; ii++) {

          baul = "";
          if ((cmpr_id[ii] != "0") && (gast_id[ii] == "0")) { qq = 2; baul = "(EN PROCESO)";  }
          if ((cmpr_id[ii] == "0") && (gast_id[ii] == "0")) { qq = 1; baul = "(NUEVO)"; pp++; }
          if ((cmpr_id[ii] == "0") && (gast_id[ii] != "0")) { qq = 3; baul = "(TERMINADO)";   }
          baul1 = (ii + 1).toString();
          baul2 = (ii + 1).toString() + " " + baul;
          xcompr[ii] = qq;
          if (pp < 2) {

            if (ii == 0) {
              document.getElementById("pcompra").value = baul7;
              document.getElementById("lcompra").innerHTML = "(De " + num_oc + ")";
              const option = document.createElement("option");
              option.value = selec0;
              option.textContent = selec0;
              select.appendChild(option);
            }

            const option = document.createElement("option");
            option.value = baul1;
            option.textContent = baul2;
            select.appendChild(option);
          }
        }
        select.value = selec0;
      }
    }


    function ingresar_compra1() {         // Llenar el select de los tipos de compras
      select = document.getElementById("ncompra");
      var ncompra = select.value;
      if ((ncompra != "") && (ncompra != selec0)) {
        bauln = parseInt(xcompr[parseInt(ncompra) - 1]);       // 1 - Nuevo | 2 - Proceso | 3 - Terminado
        rellenar_cuadro(bauln);
      }
    }



    function rellenar_cuadro(nn) {

      form_anio = document.getElementById("numAnio").value;
      form_unid = document.getElementById("nomUnid").value;
      form_ncta = document.getElementById("numCtas").value;
      form_pryt = document.getElementById("nomPryt").value;
      form_cmpr = document.getElementById("ncompra").value;

      tablaContainer = document.getElementById('tabla-container');
      tablaContainer.innerHTML = "";
      let table = "";
      pp = 0;

      if (nn == 1) {                                 // 1 - NUEVO

        table = "<table border=1>";
        table += "<tr><td><b>&nbsp;Fecha&nbsp;</b></td><td><b>&nbsp;Tipo&nbsp;</b></td><td><b>&nbsp;Proceso&nbsp;</b></td><td><b>&nbsp;Documento&nbsp;</b></td>";
        table += "<td><b>&nbsp;$ Compromet&nbsp;</b></td><td><b>&nbsp;$ Gastado&nbsp;</b></td><td><b>&nbsp;Informacion&nbsp;</b></td>";
        table += "</tr>";

        table += "<tr><td><input type='date' id='new_fch' ></td>";
        table += "<td><select id='new_cot' onchange='rellenar_tipo_compra()'></select></td>";
        table += "<td><select id='new_tip'></select></td>";
        table += "<td><input type='text' id='new_doc'></td>";
        table += "<td><input type='text' id='new_cmp' oninput='formatearNumero(this)' value='0'></td>";
        table += "<td><input type='text' id='new_gst' oninput='formatearNumero(this)' value='0'></td>";
        table += "<td><input type='text' id='new_inf'></td></tr>";
        table += "</table>";
        tablaContainer.innerHTML = table;

        const select = document.getElementById("new_cot");
        select.innerHTML = "";

        for (ii = 0; ii < dato_1a[0].length; ii++) {
          baul2 = (dato_1a[0][ii]).toString().toUpperCase();
          if (ii == 0) {
            const option = document.createElement("option");
            option.value = selec0;
            option.textContent = selec0;
            select.appendChild(option);
          }
          if (baul2 != "") {
            const option = document.createElement("option");
            option.value = baul2;
            option.textContent = baul2;
            select.appendChild(option);
          }
        }
        select.value = selec0;
      }


      if ((nn == 2) || (nn == 3)) {                  // 2 - Proceso | 3 - Terminado

        for (ii = 0; ii < dato_dt.length; ii++) {
          baul1 = (dato_dt[ii][0 ]).toString().toUpperCase();    // AÃ±o
          baul2 = (dato_dt[ii][1 ]).toString().toUpperCase();    // Unidad
          baul3 = (dato_dt[ii][2 ]).toString().toUpperCase();    // Cuenta
          baul4 = (dato_dt[ii][4 ]).toString().toUpperCase();    // Producto o Servicios
          baul5 = (dato_dt[ii][5 ]).toString().toUpperCase();    // NÂ° de compra
          if ((form_anio == baul1) && (form_unid == baul2) && (form_ncta == baul3) && (form_pryt == baul4) && (form_cmpr == baul5)) {
            fila_dt = ii;
            if (pp == 0) {
              table = "<table border=1>";
              table += "<tr><td><b>&nbsp;Fecha&nbsp;</b></td><td><b>&nbsp;Tipo&nbsp;</b></td><td><b>&nbsp;Proceso&nbsp;</b></td><td><b>&nbsp;Documento&nbsp;</b></td>";
              table += "<td><b>&nbsp;$ Compromet&nbsp;</b></td><td><b>&nbsp;$ Gastado&nbsp;</b></td><td><b>&nbsp;Informacion&nbsp;</b></td>";
              table += "</tr>";
            }
            baul7 = dato_dt[ii][7 ];
            table += "<tr><td>" + dato_dt[ii][6 ] + "</td>";                   // Fecha
            table += "<td>" + dato_dt[ii][7 ] + "</td>";                       // Tipo de Compra
            table += "<td>" + dato_dt[ii][8 ] + "</td>";                       // Proceso de la compra
            table += "<td>" + dato_dt[ii][9 ] + "</td>";                       // Documento
            table += "<td>" + formatearNumero2(dato_dt[ii][10]) + "</td>";     // Comprometido
            table += "<td>" + formatearNumero2(dato_dt[ii][11]) + "</td>";     // Gastado
            table += "<td>" + dato_dt[ii][12] + "</td></tr>";                  // Informacion
            pp++;
          }
        }

        if (nn == 2) {                   // En PROCESO

          if (pp > 0) {
            table += "<tr><td><input type='date' id='new_fch' ></td>";
            table += "<td>" + baul7 + "</td>";
            table += "<td><select id='new_tip'></select></td>";
            table += "<td><input type='text' id='new_doc'></td>";
            table += "<td><input type='text' id='new_cmp' oninput='formatearNumero(this)' value='0'></td>";
            table += "<td><input type='text' id='new_gst' oninput='formatearNumero(this)' value='0'></td>";
            table += "<td><input type='text' id='new_inf'></td></tr>";
            table += "</table>";
            tablaContainer.innerHTML = table;
          }

          baul = -1;
          for (ii = 0; ii < 5; ii++) {
            if (baul7 == dato_1a[0][ii]) {
              baul = ii;
            }
          }
          if (baul > -1) {
            const select = document.getElementById("new_tip");
            select.innerHTML = "";
            for (ii = 0; ii < dato_1a.length; ii++) {
              if (ii == 0) {
                const option = document.createElement("option");
                option.value = selec0;
                option.textContent = selec0;
                select.appendChild(option);
              }
              const option = document.createElement("option");
              option.value = dato_1a[ii][baul];
              option.textContent = dato_1a[ii][baul];
              select.appendChild(option);
            }
            select.value = selec0;
          }
        }

        if (nn == 3) { 
          baul7 = "0"; 
          table += "</table>";
          tablaContainer.innerHTML = table;
        }    // TERMINADO

      }
    }


    // ************************************************************************
    // ************************************************************************


    function rellenar_tipo_compra() {

      baul7 = (document.getElementById("new_cot").value).toString().toUpperCase();
      column = -5;
      for (ii = 0; ii < dato_1a[0].length; ii++) {
        baul2 = (dato_1a[0][ii]).toString().toUpperCase();
        if (baul7 == baul2) { column = ii; }
      }
      if (column > -1) {
        const select = document.getElementById("new_tip");
        select.innerHTML = "";
        
        for (ii = 1; ii < dato_1a.length; ii++) {
          if (ii == 1) {
            const option = document.createElement("option");
            option.value = selec0;
            option.textContent = selec0;
            select.appendChild(option);
          }
          const option = document.createElement("option");
          option.value = dato_1a[ii][column];
          option.textContent = dato_1a[ii][column];
          select.appendChild(option);
        }
        select.value = selec0;
      }
    }


    // ************************************************************************


    function cerrarForm() {
      window.close();
    }


    // ************************************************************************
    

    function formatearNumero(input) {
      // Eliminar puntos y caracteres no numÃ©ricos
      let valor = input.value.replace(/\./g, '').replace(/\D/g, '');
      // Convertir a nÃºmero y formatear con puntos
      let numeroFormateado = new Intl.NumberFormat('es-ES').format(valor);
      // Actualizar el valor del input con el formato correcto
      input.value = numeroFormateado;
    }


    function formatearNumero2(valor1) {
      // Eliminar puntos y caracteres no numÃ©ricos
      let valor2 = valor1.replace(/\./g, '').replace(/\D/g, '');
      // Convertir a nÃºmero y formatear con puntos
      let numeroFormateado = new Intl.NumberFormat('es-ES').format(valor2);
      // Actualizar el valor del input con el formato correcto
      return numeroFormateado;
    }
    

    // ###############################################################################


    // Pasar la fecha de TEXTO DD/MM/YYYY a una FECHA YYYY-MM-DD (DATE)
    function oficesarFechaTexto(fechaTexto) {
      const partes = fechaTexto.split('/');
      if (partes.length !== 3) return null; // Verifica que el formato sea correcto

      const dia2 = partes[0].padStart(2, '0');  // Asegura 2 dÃ­gitos para el dÃ­a
      const mes2 = partes[1].padStart(2, '0');  // Asegura 2 dÃ­gitos para el mes
      const ano2 = partes[2].padStart(4, '0');  // Asegura 4 dÃ­gitos para el aÃ±o

      // Devuelve la fecha en formato YYYY-MM-DD
      return `${ano2}-${mes2}-${dia2}`;
    }

    // *******************************************************************************

    // Pasar la fecha de un DATE YYY-MM-DD a un texto en formato DD/MM/YYYY
    function transformarFecha(fechaInput) {
      if (!fechaInput) {
        console.log("No se seleccionÃ³ una fecha.");
        return null;
      }

      // Crear un objeto de fecha a partir del valor del input (YYYY-MM-DD)
      const fecha1 = new Date(fechaInput);
      fecha1.setHours(fecha.getHours() + 12);

      // Extraer dÃ­a, mes y aÃ±o, asegurando 2 dÃ­gitos para dÃ­a y mes y 4 digitos para el aÃ±o
      const dia1 = String(fecha1.getDate()).padStart(2, '0');
      const mes1 = String(fecha1.getMonth() + 1).padStart(2, '0');   // Los meses empiezan en 0
      const ano1 = String(fecha1.getFullYear());

      // Formatear la fecha como DD/MM/YYYY
      const fechaTexto = `${dia1}/${mes1}/${ano1}`;
      return fechaTexto;
    }


    function borrar_div(nn) {  }

  

  </script>

</body>
</html>