<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Licitaci√≥n √Ågil | Municipalidad de Arica</title>
    <link rel="stylesheet" href="styles_licitacion.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <!-- Header with logo -->
    <header>
        <div class="top-header">
            <div class="logo">
                <img src="logo_MUNI.png" alt="Logo Municipalidad de Arica">
                <div class="logo-text">
                    <h1>ARICA</h1>
                    <span>MUNICIPALIDAD | mejor ciudad</span>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main content section -->
    <section class="dashboard-container">
        <div class="dashboard-header">
            <h2 class="dashboard-title">Licitaci√≥n √Ågil</h2>
            <button class="back-button" onclick="window.location.href='index.html'">
                <span class="back-icon">‚Üê</span> Volver 
            </button>
        </div>
        
        <!-- Cuadro para n√∫mero de ordinario -->
        <div class="ordinario-container">
            <h3>N√∫mero de Ordinario para Licitaci√≥n</h3>
            <input type="text" id="ordinarioInput" class="ordinario-input" placeholder="Ingrese el n√∫mero de ordinario...">
            
            <!-- Botones de navegaci√≥n para ordinarios -->
            <div class="ordinario-navigation">
                <button id="prevOrdinarioBtn" class="nav-button" disabled>
                    <span class="back-icon">‚Üê</span> Anterior
                </button>
                <button id="nextOrdinarioBtn" class="nav-button" disabled>
                    Siguiente <span class="forward-icon">‚Üí</span>
                </button>
                <button id="eliminarOrdinarioBtn" class="nav-button" style="background-color: #f5365c;" disabled>
                    Eliminar
                </button>
            </div>
            
            <!-- Selector de ordinarios guardados -->
            <div class="ordinario-selector-container">
                <select id="ordinarioSelector" class="ordinario-selector">
                    <option value="">-- Seleccionar ordinario guardado --</option>
                </select>
                <button id="guardarOrdinarioBtn" class="selector-button">Guardar</button>
            </div>
        </div>
        
        <!-- Instrucciones con casillas de verificaci√≥n -->
        <div id="instructionsContainer" class="instructions-container">
            <h3>Flujo Operativo de la Licitaci√≥n √Ågil</h3>
            <ol class="instructions-list">
                <li class="instruction-item">
                  <div class="checkbox-container">
                    <input type="checkbox" id="check1" class="custom-checkbox">
                  </div>
                  <div class="instruction-text">
                    Verifique si su requerimiento cumple con los criterios para Licitaci√≥n √Ågil (monto menor a 30 UTM, compra no disponible en Convenio Marco).
                  </div>
                </li>
              
                <li class="instruction-item">
                  <div class="checkbox-container">
                    <input type="checkbox" id="check2" class="custom-checkbox">
                  </div>
                  <div class="instruction-text">
                    Prepare el documento t√©cnico: especificaciones claras del bien o servicio, cantidad, lugar de entrega y plazo requerido.
                  </div>
                </li>
              
                <li class="instruction-item">
                  <div class="checkbox-container">
                    <input type="checkbox" id="check3" class="custom-checkbox">
                  </div>
                  <div class="instruction-text">
                    Complete el formulario de licitaci√≥n en el sistema ChileCompra Express o el portal interno si est√° integrado.
                  </div>
                </li>
              
                <li class="instruction-item">
                  <div class="checkbox-container">
                    <input type="checkbox" id="check4" class="custom-checkbox">
                  </div>
                  <div class="instruction-text">
                    Adjunte los documentos requeridos (requerimiento firmado, cotizaci√≥n referencial si aplica).
                  </div>
                </li>
              
                <li class="instruction-item">
                  <div class="checkbox-container">
                    <input type="checkbox" id="check5" class="custom-checkbox">
                  </div>
                  <div class="instruction-text">
                    Env√≠e la solicitud para revisi√≥n interna (si aplica: Secretar√≠a Comunal, Finanzas u otra unidad t√©cnica).
                  </div>
                </li>
              
                <li class="instruction-item">
                  <div class="checkbox-container">
                    <input type="checkbox" id="check6" class="custom-checkbox">
                  </div>
                  <div class="instruction-text">
                    Una vez aprobada internamente, publique la licitaci√≥n en el portal ChileCompra.
                  </div>
                </li>
              
                <li class="instruction-item">
                  <div class="checkbox-container">
                    <input type="checkbox" id="check7" class="custom-checkbox">
                  </div>
                  <div class="instruction-text">
                    Espere la recepci√≥n de ofertas (plazo m√≠nimo: 48 horas h√°biles). Luego eval√∫e y adjudique.
                  </div>
                </li>
              
                <li class="instruction-item">
                  <div class="checkbox-container">
                    <input type="checkbox" id="check8" class="custom-checkbox">
                  </div>
                  <div class="instruction-text">
                    Genere la orden de compra y notif√≠quela al proveedor.
                  </div>
                </li>
              </ol>
            
              <div class="note">
                <strong>Nota:</strong> La licitaci√≥n √°gil est√° pensada para compras r√°pidas con montos bajos. No requiere bases extensas, pero s√≠ debe cumplir con los principios de transparencia y trazabilidad del gasto p√∫blico.
              </div>
        </div>
        
        <!-- Botones de acci√≥n (solo se mantiene el bot√≥n de generar PDF) -->
        <div class="action-buttons">
            <button id="readAloudBtn" class="action-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
                Leer en Voz Alta
            </button>
            <button id="generatePdfBtn" class="action-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="12" y1="18" x2="12" y2="12"></line>
                    <line x1="9" y1="15" x2="15" y2="15"></line>
                </svg>
                Generar PDF
            
        </div>
    </section>
    
    <!-- Footer -->
    <footer>
        <div class="footer-container">
            <div class="footer-column">
                <h3>Municipalidad de Arica</h3>
                <p>Renato Rocca, Arica</p>
                <p>Anexo: 6959</p>
                <p>Email: roberto.mamani@municipalidadarica.cl</p>
                <div class="social-icons">
                    <a href="#">üìò</a>
                    <a href="#">üì±</a>
                    <a href="#">üê¶</a>
                    <a href="#">üì∏</a>
                </div>
            </div>
            <div class="footer-column">
                <h3>Colaboraci√≥n Interdepartamental</h3>
                <p style="line-height: 1.6;">
                    Este proyecto surge con el prop√≥sito de fortalecer la colaboraci√≥n entre diversas √°reas municipales, como <strong>iluminaci√≥n p√∫blica</strong>, <strong>Of. Mantenimiento de Veh√≠culos y Maquinaria</strong>, <strong>Aseo y Ornato</strong>, <strong>Asesor√≠a Tecnica</strong> y m√°s, en un solo sistema integral. 
                    Buscando consolidar la informaci√≥n y los procesos en un solo sistema, permitiendo un <strong>mayor control operativo</strong>, <strong>gesti√≥n por √°reas</strong> y una visi√≥n integral para la <strong>mejora continua de los servicios municipales</strong>.
                </p>
            </div>
            <div class="footer-column licitaciones">
                <h3>Licitaciones</h3>
                <ul class="licitaciones-list">
                    <li><a href="licitacion_agil.html">Licitaci√≥n √Ågil</a></li>
                    <li><a href="licitacion_gran_compra.html">Gran Compra</a></li>
                    <li><a href="licitacion_trato_directo.html">Trato Directo</a></li>
                    <li><a href="licitacion_publica.html">Licitaci√≥n P√∫blica</a></li>
                    <li><a href="licitacion_convenio_marco.html">Convenio Marco</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>¬© 2025 Municipalidad de Arica. Todos los derechos reservados.</p>
            <p>Desarrollado por Junior Barrera</p>
        </div>
    </footer>
    
    <!-- Asistente -->
    <div class="assistant-button" onclick="openAssistance()">üí¨</div>
    
    <!-- Toast de notificaci√≥n -->
    <div id="toast">Mensaje de notificaci√≥n</div>
   <script>
   // Variables globales
let ordinarioData = {};
let ordinarioList = [];
let currentOrdinarioIndex = -1;

// URL del despliegue web de Google Apps Script - REEMPLAZAR CON TU URL DESPU√âS DE DESPLEGAR
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwP0DdpbRqWS-ZITRWWmYj9UYQ3EQwtbHSJTZ7dporMa9kjboJclGAQQCRgIOjZ8VTSgg/exec';

// Inicializar al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Configurar botones
    document.getElementById('generatePdfBtn').addEventListener('click', generatePDF);
    document.getElementById('guardarOrdinarioBtn').addEventListener('click', guardarOrdinario);
    document.getElementById('ordinarioSelector').addEventListener('change', cargarOrdinarioSeleccionado);
    document.getElementById('prevOrdinarioBtn').addEventListener('click', cargarOrdinarioAnterior);
    document.getElementById('nextOrdinarioBtn').addEventListener('click', cargarOrdinarioSiguiente);
    document.getElementById('eliminarOrdinarioBtn').addEventListener('click', eliminarOrdinarioActual);
    
    // A√±adir event listeners a los checkboxes para guardar estado
    const checkboxes = document.querySelectorAll('.custom-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', saveCheckboxState);
    });
    
    // A√±adir eventos para el campo de ordinario con funcionalidad de autocompletado
    const ordinarioInput = document.getElementById('ordinarioInput');
    ordinarioInput.addEventListener('input', function() {
        actualizarBotones();
        mostrarSugerencias(this.value);
    });
    
    // Cargar ordinarios desde Google Sheets
    cargarOrdinarios();
    
    // Crear contenedor para sugerencias si no existe
    if (!document.getElementById('sugerenciasContainer')) {
        crearContenedorSugerencias();
    }
});

// Funci√≥n para crear el contenedor de sugerencias
function crearContenedorSugerencias() {
    const ordinarioContainer = document.querySelector('.ordinario-container');
    const ordinarioInput = document.getElementById('ordinarioInput');
    
    // Crear el contenedor de sugerencias
    const sugerenciasContainer = document.createElement('div');
    sugerenciasContainer.id = 'sugerenciasContainer';
    sugerenciasContainer.style.cssText = `
        position: absolute;
        width: ${ordinarioInput.offsetWidth}px;
        max-height: 200px;
        overflow-y: auto;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        z-index: 10;
        display: none;
    `;
    
    // Posicionar el contenedor debajo del input
    const inputRect = ordinarioInput.getBoundingClientRect();
    sugerenciasContainer.style.top = `${inputRect.bottom}px`;
    sugerenciasContainer.style.left = `${inputRect.left}px`;
    
    // A√±adir al DOM
    document.body.appendChild(sugerenciasContainer);
    
    // Actualizar posici√≥n cuando se haga scroll o se redimensione la ventana
    window.addEventListener('resize', actualizarPosicionSugerencias);
    window.addEventListener('scroll', actualizarPosicionSugerencias);
}

// Funci√≥n para actualizar la posici√≥n del contenedor de sugerencias
function actualizarPosicionSugerencias() {
    const sugerenciasContainer = document.getElementById('sugerenciasContainer');
    const ordinarioInput = document.getElementById('ordinarioInput');
    
    if (sugerenciasContainer && ordinarioInput) {
        const inputRect = ordinarioInput.getBoundingClientRect();
        sugerenciasContainer.style.top = `${inputRect.bottom + window.scrollY}px`;
        sugerenciasContainer.style.left = `${inputRect.left + window.scrollX}px`;
        sugerenciasContainer.style.width = `${ordinarioInput.offsetWidth}px`;
    }
}

// Funci√≥n para mostrar sugerencias basadas en la entrada del usuario
function mostrarSugerencias(texto) {
    const sugerenciasContainer = document.getElementById('sugerenciasContainer');
    
    if (!sugerenciasContainer) return;
    
    // Limpiar contenedor
    sugerenciasContainer.innerHTML = '';
    
    if (!texto.trim()) {
        sugerenciasContainer.style.display = 'none';
        return;
    }
    
    // Filtrar ordinarios que coincidan con el texto
    const coincidencias = ordinarioList.filter(ord => 
        ord.toLowerCase().includes(texto.toLowerCase()));
    
    if (coincidencias.length === 0) {
        sugerenciasContainer.style.display = 'none';
        return;
    }
    
    // Mostrar sugerencias
    coincidencias.forEach(ordinario => {
        const item = document.createElement('div');
        item.textContent = ordinario;
        item.style.cssText = `
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        `;
        
        // Resaltar texto coincidente
        const textoResaltado = ordinario.replace(
            new RegExp(texto, 'i'),
            match => `<strong>${match}</strong>`
        );
        item.innerHTML = textoResaltado;
        
        // Evento al hacer clic
        item.addEventListener('mouseover', function() {
            this.style.backgroundColor = '#f0f0f0';
        });
        
        item.addEventListener('mouseout', function() {
            this.style.backgroundColor = 'transparent';
        });
        
        item.addEventListener('click', function() {
            document.getElementById('ordinarioInput').value = ordinario;
            sugerenciasContainer.style.display = 'none';
            
            // Cargar autom√°ticamente el ordinario seleccionado
            cargarOrdinarioPorNombre(ordinario);
        });
        
        sugerenciasContainer.appendChild(item);
    });
    
    // Mostrar contenedor
    actualizarPosicionSugerencias();
    sugerenciasContainer.style.display = 'block';
}

// Funci√≥n para cargar un ordinario espec√≠fico por su nombre
function cargarOrdinarioPorNombre(nombreOrdinario) {
    if (ordinarioData[nombreOrdinario]) {
        // Actualizar selector de ordinarios
        document.getElementById('ordinarioSelector').value = nombreOrdinario;
        
        // Cargar estado de checkboxes
        const checkboxState = ordinarioData[nombreOrdinario];
        const checkboxes = document.querySelectorAll('.custom-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = checkboxState[checkbox.id] || false;
        });
        
        // Actualizar √≠ndice actual
        currentOrdinarioIndex = ordinarioList.indexOf(nombreOrdinario);
        
        // Actualizar botones de navegaci√≥n
        actualizarBotones();
        
        // Mostrar notificaci√≥n
        mostrarToast('Ordinario cargado: ' + nombreOrdinario, '#4CAF50');
    }
}

// Funci√≥n para cargar todos los ordinarios desde Google Sheets
async function cargarOrdinarios() {
    try {
        mostrarToast('Cargando datos...', '#3498db');
        
        const response = await fetch(`${SCRIPT_URL}?action=getAll`);
        const data = await response.json();
        
        if (data.success) {
            ordinarioData = data.data || {};
            actualizarListaOrdinarios();
            mostrarToast('Datos cargados correctamente', '#4CAF50');
        } else {
            mostrarToast('Error al cargar datos: ' + data.error, '#e74c3c');
        }
    } catch (error) {
        console.error('Error al cargar ordinarios:', error);
        mostrarToast('Error de conexi√≥n. Verifique su conexi√≥n a internet.', '#e74c3c');
    }
}

// Funci√≥n para actualizar la lista de ordinarios en el selector
function actualizarListaOrdinarios() {
    const selector = document.getElementById('ordinarioSelector');
    // Limpiar opciones existentes excepto la primera
    while (selector.options.length > 1) {
        selector.remove(1);
    }
    
    // Crear lista de ordinarios
    ordinarioList = Object.keys(ordinarioData);
    
    // A√±adir opciones al selector
    ordinarioList.forEach(ordinario => {
        const option = document.createElement('option');
        option.value = ordinario;
        option.textContent = ordinario;
        selector.appendChild(option);
    });
    
    // Actualizar botones de navegaci√≥n
    actualizarBotones();
}

// Funci√≥n para guardar un nuevo ordinario o actualizar uno existente en Google Sheets
async function guardarOrdinario() {
    const ordinarioInput = document.getElementById('ordinarioInput').value.trim();
    
    if (ordinarioInput === '') {
        mostrarToast('Por favor ingrese un n√∫mero de ordinario', '#e74c3c');
        return;
    }
    
    // Guardar estado actual de checkboxes
    const checkboxes = document.querySelectorAll('.custom-checkbox');
    const checkboxState = {};
    
    checkboxes.forEach(checkbox => {
        checkboxState[checkbox.id] = checkbox.checked;
    });
    
    try {
        mostrarToast('Guardando...', '#3498db');
        
        // Preparar datos para enviar
        const dataToSend = {
            action: 'save',
            ordinario: ordinarioInput,
            estado: JSON.stringify(checkboxState)
        };
        
        // Configurar la solicitud
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(dataToSend).toString()
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Actualizar datos locales
            ordinarioData[ordinarioInput] = checkboxState;
            actualizarListaOrdinarios();
            currentOrdinarioIndex = ordinarioList.indexOf(ordinarioInput);
            mostrarToast('Ordinario guardado correctamente', '#4CAF50');
        } else {
            mostrarToast('Error al guardar: ' + data.error, '#e74c3c');
        }
    } catch (error) {
        console.error('Error al guardar ordinario:', error);
        mostrarToast('Error de conexi√≥n al guardar', '#e74c3c');
    }
}

// Funci√≥n para cargar un ordinario seleccionado
function cargarOrdinarioSeleccionado() {
    const selector = document.getElementById('ordinarioSelector');
    const selectedOrdinario = selector.value;
    
    if (selectedOrdinario === '') {
        return;
    }
    
    // Actualizar campo de ordinario
    document.getElementById('ordinarioInput').value = selectedOrdinario;
    
    // Cargar estado de checkboxes
    const checkboxState = ordinarioData[selectedOrdinario];
    
    if (checkboxState) {
        const checkboxes = document.querySelectorAll('.custom-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = checkboxState[checkbox.id] || false;
        });
    }
    
    // Actualizar √≠ndice actual
    currentOrdinarioIndex = ordinarioList.indexOf(selectedOrdinario);
    
    // Actualizar botones de navegaci√≥n
    actualizarBotones();
}

// Funci√≥n para cargar ordinario anterior
function cargarOrdinarioAnterior() {
    if (currentOrdinarioIndex > 0) {
        currentOrdinarioIndex--;
        const ordinario = ordinarioList[currentOrdinarioIndex];
        document.getElementById('ordinarioInput').value = ordinario;
        document.getElementById('ordinarioSelector').value = ordinario;
        cargarOrdinarioSeleccionado();
    }
}

// Funci√≥n para cargar ordinario siguiente
function cargarOrdinarioSiguiente() {
    if (currentOrdinarioIndex < ordinarioList.length - 1) {
        currentOrdinarioIndex++;
        const ordinario = ordinarioList[currentOrdinarioIndex];
        document.getElementById('ordinarioInput').value = ordinario;
        document.getElementById('ordinarioSelector').value = ordinario;
        cargarOrdinarioSeleccionado();
    }
}

// Funci√≥n para eliminar ordinario actual
async function eliminarOrdinarioActual() {
    const ordinarioInput = document.getElementById('ordinarioInput').value.trim();
    
    if (ordinarioInput === '') {
        mostrarToast('Por favor ingrese un n√∫mero de ordinario', '#e74c3c');
        return;
    }
    
    // Verificar si el ordinario existe en los datos locales
    if (!ordinarioData[ordinarioInput]) {
        mostrarToast('El ordinario no existe en la base de datos', '#e74c3c');
        return;
    }
    
    // Confirmar eliminaci√≥n
    if (!confirm('¬øEst√° seguro que desea eliminar el ordinario ' + ordinarioInput + '?')) {
        return;
    }
    // Solicitar contrase√±a
    const password = prompt('Ingrese la contrase√±a para confirmar la eliminaci√≥n:');
    const contrase√±aCorrecta = 'DIMAO_2025x'; // Puedes cambiarla o gestionarla de forma m√°s segura si deseas

    if (password !== contrase√±aCorrecta) {
        mostrarToast('Contrase√±a incorrecta. No se elimin√≥ el ordinario.', '#e74c3c');
        return;
    }

    try {
        mostrarToast('Eliminando...', '#3498db');
        
        // Preparar datos para enviar
        const dataToSend = {
            action: 'delete',
            ordinario: ordinarioInput
        };
        
        // Configurar la solicitud
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(dataToSend).toString()
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Eliminar del objeto local
            delete ordinarioData[ordinarioInput];
            
            // Limpiar campo
            document.getElementById('ordinarioInput').value = '';
            
            // Actualizar lista y botones
            actualizarListaOrdinarios();
            
            // Reiniciar √≠ndice actual
            currentOrdinarioIndex = -1;
            
            // Reiniciar checkboxes
            const checkboxes = document.querySelectorAll('.custom-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Ocultar sugerencias si est√°n visibles
            const sugerenciasContainer = document.getElementById('sugerenciasContainer');
            if (sugerenciasContainer) {
                sugerenciasContainer.style.display = 'none';
            }
            
            mostrarToast('Ordinario eliminado correctamente', '#4CAF50');
        } else {
            console.error('Error del servidor:', data.error);
            mostrarToast('Error al eliminar: ' + data.error, '#e74c3c');
            
            // Si hay error, recargamos los datos para asegurar sincronizaci√≥n
            cargarOrdinarios();
        }
    } catch (error) {
        console.error('Error al eliminar ordinario:', error);
        mostrarToast('Error de conexi√≥n al eliminar. Intente nuevamente.', '#e74c3c');
    }
}

// Funci√≥n para actualizar botones de navegaci√≥n
function actualizarBotones() {
    const ordinarioInput = document.getElementById('ordinarioInput').value.trim();
    const prevBtn = document.getElementById('prevOrdinarioBtn');
    const nextBtn = document.getElementById('nextOrdinarioBtn');
    const eliminarBtn = document.getElementById('eliminarOrdinarioBtn');
    
    // Habilitar/deshabilitar bot√≥n de eliminar
    eliminarBtn.disabled = ordinarioInput === '' || !ordinarioData[ordinarioInput];
    
    // Habilitar/deshabilitar botones de navegaci√≥n
    prevBtn.disabled = currentOrdinarioIndex <= 0;
    nextBtn.disabled = currentOrdinarioIndex === -1 || currentOrdinarioIndex >= ordinarioList.length - 1;
}

// Funci√≥n para guardar el estado de los checkboxes
async function saveCheckboxState() {
    const ordinarioInput = document.getElementById('ordinarioInput').value.trim();
    
    // Si hay un ordinario seleccionado, guardamos estado
    if (ordinarioInput !== '' && ordinarioData[ordinarioInput]) {
        const checkboxes = document.querySelectorAll('.custom-checkbox');
        const checkboxState = {};
        
        checkboxes.forEach(checkbox => {
            checkboxState[checkbox.id] = checkbox.checked;
        });
        
        // Actualizar estado en estructura de datos local
        ordinarioData[ordinarioInput] = checkboxState;
        
        try {
            // Preparar datos para enviar
            const dataToSend = {
                action: 'save',
                ordinario: ordinarioInput,
                estado: JSON.stringify(checkboxState)
            };
            
            // Configurar la solicitud
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(dataToSend).toString()
            });
            
            const data = await response.json();
            
            if (!data.success) {
                console.error('Error al guardar estado:', data.error);
            }
        } catch (error) {
            console.error('Error al guardar estado de checkboxes:', error);
        }
    }
}
// A√±adir eventos para el campo de ordinario con funcionalidad de autocompletado
const ordinarioInput = document.getElementById('ordinarioInput');
    ordinarioInput.addEventListener('input', function() {
        actualizarBotones();
        mostrarSugerencias(this.value);
        
        const valorActual = this.value.trim();
        
        // Si el campo est√° vac√≠o o el valor no existe en la lista de ordinarios guardados,
        // desmarcar todas las casillas
        if (valorActual === '' || !ordinarioData[valorActual]) {
            const checkboxes = document.querySelectorAll('.custom-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }
    });
// Funci√≥n para generar PDF
function generatePDF() {
    const { jsPDF } = window.jspdf;
    const ordinarioInput = document.getElementById('ordinarioInput').value.trim();
    
    if (ordinarioInput === '') {
        mostrarToast('Por favor ingrese un n√∫mero de ordinario', '#e74c3c');
        return;
    }
    
    // Preparar contenido para PDF
    const instructionsContainer = document.getElementById('instructionsContainer');
    
    // Mostrar notificaci√≥n
    mostrarToast('Generando PDF, por favor espere...', '#3498db');
    
    // Usar html2canvas para capturar el contenido
    html2canvas(instructionsContainer).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const imgWidth = canvas.width;
        const imgHeight = canvas.height;
        const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
        const imgX = (pdfWidth - imgWidth * ratio) / 2;
        const imgY = 30;
        
        // A√±adir encabezado
        pdf.setFontSize(18);
        pdf.setTextColor(0, 102, 204);
        pdf.text('DIMAO', pdfWidth / 2, 15, { align: 'center' });
        pdf.setFontSize(14);
        pdf.setTextColor(0, 0, 0);
        pdf.text('Licitaci√≥n √Ågil - Ordinario N¬∞ ' + ordinarioInput, pdfWidth / 2, 25, { align: 'center' });
        
        // A√±adir imagen del contenido
        pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
        
        // A√±adir pie de p√°gina
        pdf.setFontSize(10);
        pdf.setTextColor(100, 100, 100);
        const today = new Date();
        pdf.text('Documento generado el ' + today.toLocaleDateString(), pdfWidth / 2, pdfHeight - 10, { align: 'center' });
        
        // Guardar PDF
        pdf.save('Licitaci√≥n_√Ågil_' + ordinarioInput + '.pdf');
        
        // Mostrar notificaci√≥n de √©xito
        mostrarToast('PDF generado correctamente', '#4CAF50');
    });
}

// Funci√≥n para mostrar mensajes toast
function mostrarToast(mensaje, color = '#333') {
    const toast = document.getElementById('toast');
    toast.textContent = mensaje;
    toast.style.backgroundColor = color;
    toast.style.visibility = 'visible';
    toast.style.opacity = '1';
    
    // Ocultar despu√©s de 3 segundos
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
            toast.style.visibility = 'hidden';
        }, 300);
    }, 3000);
}

// Funci√≥n para cerrar las sugerencias cuando se hace clic fuera de ellas
document.addEventListener('click', function(event) {
    const sugerenciasContainer = document.getElementById('sugerenciasContainer');
    const ordinarioInput = document.getElementById('ordinarioInput');
    
    if (sugerenciasContainer && 
        event.target !== sugerenciasContainer && 
        event.target !== ordinarioInput && 
        !sugerenciasContainer.contains(event.target)) {
        sugerenciasContainer.style.display = 'none';
    }
});

// Funci√≥n para abrir asistente (placeholder)
function openAssistance() {
    mostrarToast('Asistente virtual no disponible en este momento', '#3498db');
}
// Funci√≥n para leer el texto en voz alta
function readAloud() {
    // Obtener el texto a leer
    const instructionsContainer = document.getElementById('instructionsContainer');
    const title = instructionsContainer.querySelector('h3').textContent;
    const instructions = Array.from(instructionsContainer.querySelectorAll('.instruction-text')).map(el => el.textContent.trim());
    const note = instructionsContainer.querySelector('.note').textContent.trim();
    
    // Combinar todo el texto
    const fullText = [title, ...instructions, note].join('. ');
    
    // Verificar si el navegador soporta speech synthesis
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(fullText);
        
        // Configurar voz femenina (si est√° disponible)
        const voices = speechSynthesis.getVoices();
        const femaleVoice = voices.find(voice => 
            voice.lang.includes('es') && voice.name.toLowerCase().includes('female'));
        
        if (femaleVoice) {
            utterance.voice = femaleVoice;
        } else if (voices.length > 0) {
            // Usar cualquier voz en espa√±ol si no hay femenina espec√≠fica
            const spanishVoice = voices.find(voice => voice.lang.includes('es'));
            if (spanishVoice) utterance.voice = spanishVoice;
        }
        
        // Configurar propiedades de la voz
        utterance.rate = 0.9; // Velocidad ligeramente m√°s lenta
        utterance.pitch = 1.2; // Tono un poco m√°s alto para sonido femenino
        
        // Evento cuando comienza a hablar
        utterance.onstart = () => {
            document.getElementById('readAloudBtn').disabled = true;
            mostrarToast('Leyendo instrucciones...', '#3498db');
        };
        
        // Evento cuando termina de hablar
        utterance.onend = () => {
            document.getElementById('readAloudBtn').disabled = false;
        };
        
        // Iniciar la lectura
        speechSynthesis.speak(utterance);
    } else {
        mostrarToast('Tu navegador no soporta lectura de voz', '#e74c3c');
    }
}

// Asegurarnos de cargar las voces disponibles
speechSynthesis.onvoiceschanged = function() {
    // Voces ya est√°n cargadas
};

// En el DOMContentLoaded, agregar el event listener para el nuevo bot√≥n
document.getElementById('readAloudBtn').addEventListener('click', readAloud);
    </script>
</body>
</html>