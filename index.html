<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Municipalidad de Arica | mejor ciudad</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <script src="auth.js"></script>
    <!-- Loader de carga inicial -->
<div class="loader">
    <div class="loader-animation">
        <div class="loader-circle"></div>
        <img src="images.png" alt="Logo" class="loader-logo">
    </div>
</div>

    <!-- Header with logo and search -->
    <header>
        <!-- Transparency links as collapsible menu -->
        <div class="transparency-container">
        </div>
</div>
</header>
 
                <div class="top-header">
                    <div class="logo">
                        <img src="logo_MUNI.png" alt="Logo Municipalidad de Arica">
                        <div class="logo-text">
                            <h1>ARICA</h1>
                            <span>MUNICIPALIDAD | mejor ciudad</span>
                        </div>
                    </div>
                </div>
    
    
    <!-- Main navigation -->
    <nav>
        <ul class="main-menu">
            <li><a href="index.html">INICIO</a></li>
            <li><a href="dashboard-gps.html">GPS DIMAO</a></li>
            <li><a href="dashboard-presupuesto.html">PRESUPUESTO ANUAL</a></li>
            <li><a href="dashboard-abastecimiento.html">ABASTECIMIENTO</a></li>
            <li><a href="dashboard-bodega.html">BODEGA</a></li>
        </ul>
    </nav>
    
    <!-- Hero section -->
    <section class="hero">
        <img src="fondo.jpg" alt="JUNIOR BARRERA" class="hero-image">
        <div class="hero-content">
            <h2>DIMAO</h2>
            <p>"Mejoremos Juntos"</p>
        </div>
    </section>
   
    <!-- Regular modules -->
   <!-- Secci√≥n de formularios modernizada -->
<section class="modules">
    <h2 class="fade-in">Sistema Integral de Gesti√≥n DIMAO</h2>
    <div class="module-grid">
        <div class="module fade-in">
            <div class="module-icon">üìÑ</div>
            
            <h3>Sistema de Gesti√≥n de Presupuesto Anual de Compra</h3>
            <p>Este formulario permite planificar, registrar y gestionar el Presupuesto Anual de Compra (PAC) de materiales y servicios necesarios para el funcionamiento de DIMAO. Facilita la proyecci√≥n de necesidades, el control del gasto y la programaci√≥n de adquisiciones, asegurando una correcta administraci√≥n de los recursos financieros durante el a√±o.</p>
            <button class="module-button" onclick="redirectToDashboard('formulario')">
                Acceder <span class="ml-2">‚Üí</span>
                
            </button>
        </div>
        
        <div class="module fade-in">
            <div class="module-icon">üöó</div>
            <h3>Sistema de Gesti√≥n de Mantenimiento de Veh√≠culos y Maquinaria </h3>
            <p>Este formulario est√° dise√±ado para registrar solicitudes de mantenimiento preventivo y correctivo de veh√≠culos y maquinaria pertenecientes a la instituci√≥n. Por favor, aseg√∫rese de llenar todos los campos requeridos con informaci√≥n clara y precisa para facilitar una atenci√≥n eficiente y oportuna por parte de la Oficina de Mantenimiento.</p>
            <button class="module-button" onclick="redirectToDashboard('formulario2')">
                Acceder <span class="ml-2">‚Üí</span>
            </button>
        </div>
        
        <div class="module fade-in">
            <div class="module-icon">üí°</div>
            <h3>Sistema de Control y Mantenimiento de Iluminaci√≥n P√∫blica</h3>
            <p>Este formulario est√° destinado a registrar, actualizar y gestionar informaci√≥n relacionada con las solicitudes, reportes, y gestiones internas de la Oficina de Iluminaci√≥n P√∫blica. Permite sistematizar datos sobre mantenimiento, instalaci√≥n, stock de materiales, y atenci√≥n de requerimientos ciudadanos, contribuyendo a una administraci√≥n m√°s eficiente y organizada de los recursos de iluminaci√≥n urbana.</p>
            <button class="module-button" onclick="redirectToDashboard('formulario3')">
                Acceder <span class="ml-2">‚Üí</span>
            </button>
        </div>
        <div class="module fade-in">
            <div class="module-icon">üìÑ</div>
            
            <h3>Sistema de Reclamos</h3>
            <p>Plataforma para reportar y dar seguimiento a problemas relacionados con iluminaci√≥n p√∫blica, √°reas verdes y espacios p√∫blicos en la comunidad.</p>
            <button class="module-button" onclick="redirectToDashboard('formulario4')">
                Acceder <span class="ml-2">‚Üí</span> 
            </button>
        </div>

    </div>
</section>
<div class="container">
    <!-- Header del Foro -->
    <div class="forum-header">
        <h1 class="forum-title">üåê DIMAO Conecta</h1>
        <p class="forum-subtitle">Foro de Comunicaci√≥n Interdepartamental</p>
    </div>

    <!-- Contenedor del Chat -->
    <div class="chat-container">
        <div class="messages-area" id="messagesArea">
            <div class="welcome-message">
                <strong>¬°Bienvenido al foro DIMAO Conecta!</strong><br>
                Este es un espacio para la comunicaci√≥n entre todos los departamentos.
            </div>
        </div>
        
        <div class="input-area">
            <div class="input-container">
                <textarea 
                    id="messageInput" 
                    class="message-input" 
                    placeholder="Escribe tu mensaje aqu√≠..."
                    rows="1"></textarea>
                <button id="sendButton" class="send-button">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Usuarios en l√≠nea -->
    <div class="online-users">
        <h3>
            <span class="online-indicator"></span>
            Usuarios Conectados
        </h3>
        <div class="user-list" id="userList">
            <!-- Los usuarios se cargar√°n din√°micamente -->
        </div>
    </div>
</div>
<!-- Secci√≥n DIMAO 360¬∞ Modernizada -->
<section class="modules">
    <h2 class="fade-in">DIMAO 360¬∞</h2>
    <h4>Supervisi√≥n integral operativa, t√°ctica y estrat√©gica en tiempo real</h4>
  
    <div class="module-grid">
  
      <div class="module fade-in">
        <div class="module-icon">üìä</div>
        <h3>Centro de Mando DIMAO</h3>
        <p>Panel estrat√©gico que consolida los indicadores clave de gesti√≥n de todas las √°reas de DIMAO: iluminaci√≥n, veh√≠culos, √°reas verdes, aseo, reclamos ciudadanos y PAC. Facilita la toma de decisiones r√°pidas y efectivas mediante visualizaci√≥n de datos en tiempo real y proyecciones inteligentes.</p>
        <button class="module-button" onclick="redirectToDashboard('centroMando')">
          Acceder <span class="ml-2">‚Üí</span>
        </button>
      </div>
  
      <div class="module fade-in">
        <div class="module-icon">üö®</div>
        <h3>Panel de Alertas Cr√≠ticas</h3>
        <p>Herramienta de monitoreo proactivo que detecta, clasifica y notifica situaciones urgentes en los servicios municipales. Desde fallas en iluminaci√≥n hasta veh√≠culos fuera de servicio, el sistema prioriza incidentes y ayuda a coordinar una respuesta r√°pida con las unidades responsables.</p>
        <button class="module-button" onclick="redirectToDashboard('alertasCriticas')">
          Acceder <span class="ml-2">‚Üí</span>
        </button>
      </div>
    </div>
</section>
<section class="dashboard-modules">
    <h2 class="animated-title">Visualizaci√≥n de M√≥dulos</h2>
    <p class="animated-subtitle">Accede a nuestros paneles de datos para conocer el funcionamiento de DIMAO</p>

    <!-- Contenedor principal -->
    <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align: center; margin-top: 40px;">

        <!-- T√≠tulo Asesor√≠a T√©cnica -->
        <h2>Asesor√≠a T√©cnica</h2>
        <div style="height: 5px; width: 100%; background: linear-gradient(270deg, #ff0000, #ff7300, #fffb00, #00ff00, #00aaff, #a200ff, #ff00ff); background-size: 600% 600%; animation: moveGradient 10s ease infinite; margin-bottom: 40px;"></div>

        <div class="dashboard-grid">
            <!-- GPS DIMAO -->
            <div class="dashboard-card fade-in">
                <div class="dashboard-card-image" style="background-image: url('GPS.jpg')">
                    <div class="image-overlay">
                        <span class="card-badge">GPS</span>
                    </div>
                </div>
                <div class="dashboard-card-content">
                    <h3 class="animated-heading">GPS DIMAO</h3>
                    <p>Este m√≥dulo permite el seguimiento en tiempo real de los veh√≠culos recolectores, analizando rutas, tiempos de operaci√≥n y eficiencia del servicio para optimizar la gesti√≥n.</p>
                    <a href="dashboard-gps.html" class="view-dashboard">
                        <span>Ver Dashboard</span>
                        <i class="dashboard-icon">‚Üí</i>
                    </a>
                </div>
            </div>

            <!-- Cuentas de Presupuesto Anual -->
            <div class="dashboard-card fade-in">
                <div class="dashboard-card-image" style="background-image: url('presupuesto.webp')">
                    <div class="image-overlay">
                        <span class="card-badge">PAC & F1</span>
                    </div>
                </div>
                <div class="dashboard-card-content">
                    <h3 class="animated-heading">Cuentas de Presupuesto Anual</h3>
                    <p>Este m√≥dulo permite el seguimiento y control del presupuesto anual, analizando ingresos, egresos y su distribuci√≥n para una planificaci√≥n eficiente de los recursos.</p>
                    <a href="dashboard-presupuesto.html" class="view-dashboard">
                        <span>Ver Dashboard</span>
                        <i class="dashboard-icon">‚Üí</i>
                    </a>
                </div>
            </div>

            <!-- Abastecimiento de Combustible -->
            <div class="dashboard-card fade-in">
                <div class="dashboard-card-image" style="background-image: url('abastecimiento.jpg')">
                    <div class="image-overlay">
                        <span class="card-badge">Combustible</span>
                    </div>
                </div>
                <div class="dashboard-card-content">
                    <h3 class="animated-heading">Abastecimiento de Combustible</h3>
                    <p>Este m√≥dulo proporciona informaci√≥n clave sobre el abastecimiento de combustible, incluyendo consumo, tr√°mites realizados y tiempos de respuesta. Permite analizar tendencias y optimizar la gesti√≥n del suministro.</p>
                    <a href="dashboard-abastecimiento.html" class="view-dashboard">
                        <span>Ver Dashboard</span>
                        <i class="dashboard-icon">‚Üí</i>
                    </a>
                </div>
            </div>
        </div>

        <!-- T√≠tulo Oficina de Mantenimiento de Veh√≠culos y Maquinaria -->
        <h2 style="margin-top: 60px;">Oficina de Mantenimiento de Veh√≠culos y Maquinaria</h2>
        <div style="height: 5px; width: 100%; background: linear-gradient(270deg, #ff7300, #fffb00, #00ff00, #00aaff, #a200ff); background-size: 600% 600%; animation: moveGradient 10s ease infinite; margin-bottom: 40px;"></div>

        <div class="dashboard-grid">
            <!-- Stock de Bodega Mec√°nica -->
            <div class="dashboard-card fade-in">
                <div class="dashboard-card-image" style="background-image: url('bodega.avif')">
                    <div class="image-overlay">
                        <span class="card-badge">Stock de Bodega Mec√°nica</span>
                    </div>
                </div>
                <div class="dashboard-card-content">
                    <h3 class="animated-heading">Stock de Bodega Mec√°nica</h3>
                    <p>Este m√≥dulo permite el control de inventario en la bodega mec√°nica, facilitando la gesti√≥n de repuestos, insumos y herramientas para un mantenimiento eficiente.</p>
                    <a href="dashboard-bodega.html" class="view-dashboard">
                        <span>Ver Dashboard</span>
                        <i class="dashboard-icon">‚Üí</i>
                    </a>
                </div>
            </div>

            <!-- Veh√≠culos y Maquinaria -->
            <div class="dashboard-card fade-in">
                <div class="dashboard-card-image" style="background-image: url('vehiculo y maquinaria .jpeg')">
                    <div class="image-overlay">
                        <span class="card-badge">Veh√≠culos y Maquinaria</span>
                    </div>
                </div>
                <div class="dashboard-card-content">
                    <h3 class="animated-heading">Veh√≠culos y Maquinaria</h3>
                    <p>Este m√≥dulo proporciona informaci√≥n clave sobre el abastecimiento de combustible, incluyendo consumo, tr√°mites realizados y tiempos de respuesta. Permite analizar tendencias y optimizar la gesti√≥n del suministro.</p>
                    <a href="dashboard-vehiculosymaquinaria.html" class="view-dashboard">
                        <span>Ver Dashboard</span>
                        <i class="dashboard-icon">‚Üí</i>
                    </a>
                </div>
            </div>
        </div>

        <!-- T√≠tulo Iluminaci√≥n P√∫blica -->
        <h2 style="margin-top: 60px;">Iluminaci√≥n P√∫blica</h2>
        <div style="height: 5px; width: 100%; background: linear-gradient(270deg, #00c3ff, #ffff1c, #ff3c00); background-size: 600% 600%; animation: moveGradient 10s ease infinite; margin-bottom: 40px;"></div>

        <div class="dashboard-grid">
            <!-- Iluminaci√≥n P√∫blica -->
            <div class="dashboard-card fade-in">
                <div class="dashboard-card-image" style="background-image: url('CEMAFORO.jpeg')">
                    <div class="image-overlay">
                        <span class="card-badge">Iluminaci√≥n P√∫blica</span>
                    </div>
                </div>
                <div class="dashboard-card-content">
                    <h3 class="animated-heading">Iluminaci√≥n P√∫blica</h3>
                    <p>Este m√≥dulo proporciona informaci√≥n clave sobre la gesti√≥n de solicitudes de iluminaci√≥n p√∫blica, incluyendo mantenimiento de luminarias, tiempos de atenci√≥n, resoluci√≥n de trabajos y localizaci√≥n geogr√°fica. Permite visualizar las incidencias en un mapa de calor, analizar tendencias de fallas, optimizar la asignaci√≥n de recursos y mejorar la eficiencia en la atenci√≥n ciudadana.</p>
                    <a href="dashboard-iluminacion.html" class="view-dashboard">
                        <span>Ver Dashboard</span>
                        <i class="dashboard-icon">‚Üí</i>
                    </a>
                </div>
            </div>

            <!-- √ìrdenes de Trabajo de Iluminaci√≥n -->
            <div class="dashboard-card fade-in">
                <div class="dashboard-card-image" style="background-image: url('bombillas-electricas-aisladas_23-2151045845')">
                    <div class="image-overlay">
                        <span class="card-badge">√ìrdenes de Trabajo</span>
                    </div>
                </div>
                <div class="dashboard-card-content">
                    <h3 class="animated-heading">√ìrdenes de Trabajo de Iluminaci√≥n</h3>
                    <p>Este m√≥dulo proporciona informaci√≥n clave sobre las √≥rdenes de trabajo de iluminaci√≥n p√∫blica, incluyendo mantenimiento de luminarias, tiempos de atenci√≥n, estado de ejecuci√≥n y ubicaci√≥n geogr√°fica de las solicitudes. Permite visualizar las intervenciones mediante mapas de calor, identificar patrones de fallas, optimizar la planificaci√≥n de trabajos y mejorar la eficiencia operativa.</p>
                    <a href="dashboard-ordenes-trabajo-iluminacion.html" class="view-dashboard">
                        <span>Ver Dashboard</span>
                        <i class="dashboard-icon">‚Üí</i>
                    </a>
                </div>
            </div>

            <!-- Stock Bodega de Iluminaci√≥n -->
            <div class="dashboard-card fade-in">
                <div class="dashboard-card-image" style="background-image: url('iluminacion-en-bodegas.1.2.jpg')">
                    <div class="image-overlay">
                        <span class="card-badge">Stock Bodega Iluminaci√≥n</span>
                    </div>
                </div>
                <div class="dashboard-card-content">
                    <h3 class="animated-heading">Stock Bodega de Iluminaci√≥n</h3>
                    <p>El m√≥dulo "Stock bodega de iluminaci√≥n" permite gestionar y visualizar en tiempo real la cantidad, tipo y estado de los productos de iluminaci√≥n almacenados en la bodega. Incluye el control de entradas, salidas, stock disponible, y alertas de reposici√≥n para asegurar una adecuada disponibilidad de insumos como ampolletas, tubos, reflectores, cables, entre otros art√≠culos relacionados.</p>
                    <a href="dashboard-stock-iluminacion.html" class="view-dashboard">
                        <span>Ver Dashboard</span>
                        <i class="dashboard-icon">‚Üí</i>
                    </a>
                </div>
            </div>
        </div>

        <!-- T√≠tulo Reclamos -->
        <h2 style="margin-top: 60px;">Reclamos</h2>
        <div style="height: 5px; width: 100%; background: linear-gradient(270deg, #f00000, #f4d03f, #16a085); background-size: 600% 600%; animation: moveGradient 10s ease infinite; margin-bottom: 40px;"></div>

        <div class="dashboard-grid">
            <!-- Reclamos Ciudadanos -->
            <div class="dashboard-card fade-in">
                <div class="dashboard-card-image" style="background-image: url('reclamociudadano.jpeg')">
                    <div class="image-overlay">
                        <span class="card-badge">Reclamos Ciudadanos</span>
                    </div>
                </div>
                <div class="dashboard-card-content">
                    <h3 class="animated-heading">Reclamos Ciudadanos</h3>
                    <p>Este m√≥dulo proporciona informaci√≥n clave sobre la gesti√≥n de solicitudes de iluminaci√≥n p√∫blica, incluyendo mantenimiento de luminarias, tiempos de atenci√≥n, resoluci√≥n de trabajos y localizaci√≥n geogr√°fica. Permite visualizar las incidencias en un mapa de calor, analizar tendencias de fallas, optimizar la asignaci√≥n de recursos y mejorar la eficiencia en la atenci√≥n ciudadana.</p>
                    <a href="dashboard-reclamos.html" class="view-dashboard">
                        <span>Ver Dashboard</span>
                        <i class="dashboard-icon">‚Üí</i>
                    </a>
                </div>
            </div>
        </div>

    </div>
</section>

<footer>
    <div class="footer-container">
        <div class="footer-column">
            <h3>Municipalidad de Arica</h3>
            <p>Renato Rocca , Arica</p>
            <p>Anexo: 6959</p>
            <p>Email: roberto.mamani@municipalidadarica.cl</p>
            <div class="social-icons">
                <a href="#">üìò</a>
                <a href="#">üì±</a>
                <a href="#">üê¶</a>
                <a href="#">üì∏</a>
            </div>
        </div>
        
        <div class="footer-column">
            <h3>Colaboraci√≥n Interdepartamental</h3>
            <p style="line-height: 1.6;">
                Este proyecto surge con el prop√≥sito de fortalecer la colaboraci√≥n entre diversas √°reas municipales, como <strong>iluminaci√≥n p√∫blica</strong>, <strong>Of. Mantenimiento de Veh√≠culos y Maquinaria</strong>, <strong>Aseo y Ornato</strong>, <strong>Asesor√≠a T√©cnica</strong> y m√°s, en un solo sistema integral. 
                Buscando consolidar la informaci√≥n y los procesos en un solo sistema, permitiendo un <strong>mayor control operativo</strong>, <strong>gesti√≥n por √°reas</strong> y una visi√≥n integral para la <strong>mejora continua de los servicios municipales</strong>.
            </p>
        </div>
        <div class="footer-column licitaciones">
            <h3>Licitaciones</h3>
            <ul class="licitaciones-list">
                <li><a href="licitacion_agil.html">Licitaci√≥n √Ågil</a></li>
                <li><a href="licitacion_gran_compra.html">Gran Compra</a></li>
                <li><a href="licitacion_trato_directo.html">Trato Directo</a></li>
                <li><a href="licitacion_publica.html">Licitaci√≥n P√∫blica</a></li>
                <li><a href="licitacion_convenio_marco.html">Convenio Marco</a></li>
            </ul>
        </div>
    </div>

    <div class="footer-bottom">
        <p>¬© 2025 Municipalidad de Arica. Todos los derechos reservados.</p>
        <p>Desarrollado por Junior Barrera</p>
    </div>
</footer>


    <!-- Assistance button -->
    <div class="assistant-button" onclick="openAssistance()">üí¨</div>
    
    
    
    <script>
        // Funci√≥n para redirigir a dashboards o formularios con verificaci√≥n estricta de permisos
function redirectToDashboard(dashboardType) {
    // Primero verificamos si el usuario est√° autenticado
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    
    if (!currentUser) {
        window.location.href = 'login.html';
        return;
    }
    
    // Mapeo exacto de tipos de dashboard a p√°ginas y permisos requeridos
    const dashboardMappings = {
        'presupuesto': {
            page: 'dashboard-gps.html',
            permission: 'dashboard-gps'
        },
        'obras': {
            page: 'dashboard-presupuesto.html',
            permission: 'dashboard-presupuesto'
        },
        'servicios': {
            page: 'dashboard-abastecimiento.html',
            permission: 'dashboard-abastecimiento'
        },
        'seguridad': {
            page: 'dashboard-seguridad.html',
            permission: 'dashboard-seguridad'
        },
        'formulario': {
            page: 'formulario-1.html',
            permission: 'formulario-1'
        },
        'formulario2': {
            page: 'formulario-2.html',
            permission: 'formulario-2'
        },
        'formulario3': {
            page: 'formulario-3.html',
            permission: 'formulario-3'
        },
        'formulario4': {
            page: 'formulario-4.html',
            permission: 'formulario-4' 
        },
        // A√±adir mapeos directos para cada tipo de dashboard
        'dashboard-gps': {
            page: 'dashboard-gps.html',
            permission: 'dashboard-gps'
        },
        'dashboard-presupuesto': {
            page: 'dashboard-presupuesto.html',
            permission: 'dashboard-presupuesto'
        },
        'dashboard-abastecimiento': {
            page: 'dashboard-abastecimiento.html',
            permission: 'dashboard-abastecimiento'
        },
        'dashboard-bodega': {
            page: 'dashboard-bodega.html',
            permission: 'dashboard-bodega'
        },
        'dashboard-reclamos': {
            page: 'dashboard-reclamos.html',
            permission: 'dashboard-reclamos'
        },
        'dashboard-vehiculosymaquinaria': {
            page: 'dashboard-vehiculosymaquinaria.html',
            permission: 'dashboard-vehiculosymaquinaria'
        },
        'dashboard-iluminacion': {
            page: 'dashboard-iluminacion.html',
            permission: 'dashboard-iluminacion'
        },
        'dashboard-ordenes-trabajo-iluminacion': {
            page: 'dashboard-ordenes-trabajo-iluminacion',
            permission: 'dashboard-ordenes-trabajo-iluminacion'
        },
        'dashboard-stock-iluminacion': {
            page: 'dashboard-stock-iluminacion.html',
            permission: 'dashboard-stock-iluminacion'
        }
    };
    
    // Obtener la configuraci√≥n para este tipo de dashboard
    const dashboardConfig = dashboardMappings[dashboardType];
    
    // Si no se identific√≥ una configuraci√≥n v√°lida, no hacer nada
    if (!dashboardConfig) {
        console.error('Tipo de dashboard no reconocido:', dashboardType);
        return;
    }
    
    // Verificar permisos de manera estricta
    if (hasStrictPermission(currentUser, dashboardConfig.permission)) {
        window.location.href = dashboardConfig.page;
    } else {
        // Mostrar mensaje de acceso denegado
        showAccessDeniedMessage();
    }
}

// Funci√≥n mejorada para verificar permisos de manera estricta
function hasStrictPermission(user, requiredPermission) {
    // Director y admin tienen acceso completo
    if (user.role === 'director' || user.role === 'admin') {
        return true;
    }
    
    // Casos especiales
    if (user.permissions) {
        // Caso especial para supervisor con permiso de combustible
        if (user.role === 'Combustible' && 
            requiredPermission === 'dashboard-abastecimiento' && 
            user.permissions.includes('combustible')) {
            return true;
        }
    // Caso especial para formulario-1 (PAC)
    if (requiredPermission === 'formulario-1' && user.permissions.includes('pac')) {
            return true;
        }
        
        // Verificaci√≥n directa del permiso
        if (user.permissions.includes(requiredPermission)) {
            return true;
        }
    }
    
    // Si no cumple ninguna condici√≥n anterior, no tiene permiso
    return false;
}



// Funci√≥n para deshabilitar visualmente los botones de acceso seg√∫n permisos
function updateAccessButtonsVisibility() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    
    if (!currentUser) return;
    
    // Obtener todos los botones de m√≥dulo
    const moduleButtons = document.querySelectorAll('.module-button');
    
    moduleButtons.forEach(button => {
        // Obtener el tipo de dashboard del evento onclick
        const onclickAttr = button.getAttribute('onclick');
        if (!onclickAttr) return;
        
        // Extraer el tipo de dashboard
        const match = onclickAttr.match(/redirectToDashboard\(['"]([^'"]+)['"]\)/);
        if (!match || !match[1]) return;
        
        const dashboardType = match[1];
        
        // Mapeo de tipos de dashboard a permisos requeridos
        const permissionMap = {
            'presupuesto': 'dashboard-gps',
            'obras': 'dashboard-presupuesto',
            'servicios': 'dashboard-abastecimiento',
            'seguridad': 'dashboard-seguridad',
            'reclamos': 'dashboard-reclamos',
            'vehiculos': 'dashboard-vehiculosymaquinaria',
            'formulario': 'formulario-1',
            'formulario2': 'formulario-2',
            'formulario3': 'formulario-3',
            'formulario4': 'formulario-4',  // CORREGIDO
            'dashboard-gps': 'dashboard-gps',
            'dashboard-presupuesto': 'dashboard-presupuesto',
            'dashboard-abastecimiento': 'dashboard-abastecimiento',
            'dashboard-bodega': 'dashboard-bodega',
            'dashboard-reclamos': 'dashboard-reclamos',
            'dashboard-vehiculosymaquinaria': 'dashboard-vehiculosymaquinaria',
            'dashboard-iluminacion': 'dashboard-iluminacion',
            'dashboard-ordenes-trabajo-iluminacion': 'dashboard-ordenes-trabajo-iluminacion',
            'dashboard-stock-iluminacion': 'dashboard-stock-iluminacion',
        };
        
        const requiredPermission = permissionMap[dashboardType];
        
        // Verificar si el usuario tiene permiso
        if (!hasStrictPermission(currentUser, requiredPermission)) {
            // Deshabilitar visualmente el bot√≥n
            button.disabled = true;
            button.classList.add('disabled-button');
            button.style.backgroundColor = '#ccc';
            button.style.cursor = 'not-allowed';
            button.style.color = '#666';
            
            // Opcional: Cambiar el texto del bot√≥n
            button.innerHTML = 'Sin acceso <span class="ml-2">üîí</span>';
        }
    });
    
    // Tambi√©n actualizar los botones de dashboard
    const dashboardLinks = document.querySelectorAll('.view-dashboard');
    
    dashboardLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (!href) return;
        
        // Extraer el tipo de dashboard de la URL
        const dashboardType = href.replace('.html', '');
        
        // Verificar si el usuario tiene permiso
        if (!hasStrictPermission(currentUser, dashboardType)) {
            // Prevent default behavior
            link.addEventListener('click', function(e) {
                e.preventDefault();
                showAccessDeniedMessage();
            });
            
            // Deshabilitar visualmente el link
            link.classList.add('disabled-link');
            link.style.color = '#999';
            link.style.pointerEvents = 'all'; // Mantener habilitado para poder mostrar el mensaje
            link.style.cursor = 'not-allowed';
            
            // Opcional: Cambiar el texto
            link.innerHTML = '<span>Sin acceso</span> <i class="dashboard-icon">üîí</i>';
        }
    });
}

// Llamar a esta funci√≥n cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Verificar permisos del usuario para la p√°gina actual
    checkPagePermission();
    
    // Actualizar visibilidad de botones de acceso
    updateAccessButtonsVisibility();
});   
        // Function to open assistance chat
        function openAssistance() {
            // Replace with your actual phone number for WhatsApp
            const phoneNumber = "959414178"; // Replace with your actual number
            window.open(`https://wa.me/${phoneNumber}`, '_blank');
        }
        
        // Animation for elements when they come into view
        document.addEventListener('DOMContentLoaded', function() {
            const fadeElements = document.querySelectorAll('.fade-in');
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('in-view');
                        observer.unobserve(entry.target);
                    }
                });
            }, {
                threshold: 0.1
            });
            
            fadeElements.forEach(element => {
                observer.observe(element);
            });
            
            // Header scroll effect
            const header = document.querySelector('header');
            let lastScrollTop = 0;
            
            window.addEventListener('scroll', () => {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                if (scrollTop > 100) {
                    header.style.boxShadow = '0 5px 20px rgba(0, 0, 0, 0.1)';
                } else {
                    header.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.05)';
                }
                
                lastScrollTop = scrollTop;
            });
        });
    </script>
   
   
    <script>
        // Add this to your existing script section
        document.addEventListener('DOMContentLoaded', function() {
            const transparencyToggle = document.querySelector('.transparency-toggle');
            const transparencyLinks = document.querySelector('.transparency-links');
            
            // Check if elements exist
            if (transparencyToggle && transparencyLinks) {
                transparencyToggle.addEventListener('click', function() {
                    transparencyToggle.classList.toggle('active');
                    transparencyLinks.classList.toggle('active');
                });
                
                // Initialize menu state based on screen width
                function checkScreenWidth() {
                    if (window.innerWidth <= 768) {
                        transparencyLinks.classList.remove('active');
                    } else {
                        transparencyLinks.classList.add('active');
                    }
                }
                
                // Check on load and resize
                checkScreenWidth();
                window.addEventListener('resize', checkScreenWidth);
            }
        });
        // Loader - ocultar despu√©s de cargar la p√°gina
    window.addEventListener('load', function() {
        setTimeout(function() {
            document.querySelector('.loader').classList.add('hidden');
        }, 800);
    });
    
    // Efecto de part√≠culas para el hero
    document.addEventListener('DOMContentLoaded', function() {
        const heroSection = document.querySelector('.hero');
        
        // Crear el contenedor de part√≠culas
        const particlesContainer = document.createElement('div');
        particlesContainer.className = 'particles-container';
        heroSection.appendChild(particlesContainer);
        
        // Crear part√≠culas
        for (let i = 0; i < 50; i++) {
            createParticle(particlesContainer);
        }
        
        // Agregar botones al hero
        const heroContent = document.querySelector('.hero-content');
        const heroButtons = document.createElement('div');
        heroButtons.className = 'hero-buttons';
        heroButtons.innerHTML = `
            <button class="hero-button primary">Explorar Dashboards <span>‚Üí</span></button>
            <button class="hero-button">Conoce M√°s <span>‚Üì</span></button>
        `;
        heroContent.appendChild(heroButtons);
        
        // Agregar efecto de movimiento en el hero
        heroSection.addEventListener('mousemove', function(e) {
            const xPos = (e.clientX / window.innerWidth) - 0.5;
            const yPos = (e.clientY / window.innerHeight) - 0.5;
            
            const heroImage = document.querySelector('.hero-image');
            heroImage.style.transform = `translate(${xPos * 20}px, ${yPos * 20}px) scale(1.1)`;
            
            const heroContent = document.querySelector('.hero-content');
            heroContent.style.transform = `translate(${xPos * -30}px, ${yPos * -30}px)`;
        });
    });
    
    // Funci√≥n para crear part√≠culas
    function createParticle(container) {
        const particle = document.createElement('div');
        
        // Estilo aleatorio para cada part√≠cula
        var size = Math.random() * 5 + 1;
        var opacity = Math.random() * 0.5 + 0.1;
        
        // Posici√≥n aleatoria
        var xPos = Math.random() * 100;
        var yPos = Math.random() * 100;
        
        // Velocidad aleatoria
        var speedX = (Math.random() - 0.5) * 0.5;
        var speedY = (Math.random() - 0.5) * 0.5;
        
        // Aplicar estilos
        particle.style.cssText = `
            position: absolute;
            width: ${size}px;
            height: ${size}px;
            background-color: rgba(255, 255, 255, ${opacity});
            border-radius: 50%;
            top: ${yPos}%;
            left: ${xPos}%;
            pointer-events: none;
        `;
        
        container.appendChild(particle);
        
        // Animaci√≥n de movimiento
        let x = xPos;
        let y = yPos;
        
        function moveParticle() {
            x += speedX;
            y += speedY;
            
            // Rebote en los bordes
            if (x < 0 || x > 100) {
                x = Math.max(0, Math.min(100, x));
                speedX *= -1;
            }
            
            if (y < 0 || y > 100) {
                y = Math.max(0, Math.min(100, y));
                speedY *= -1;
            }
            
            particle.style.left = x + '%';
            particle.style.top = y + '%';
            
            requestAnimationFrame(moveParticle);
        }
        
        moveParticle();
    }
    
    // Mejorar las animaciones de scroll existentes
    const fadeElements = document.querySelectorAll('.fade-in');
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('in-view');
                
                // A√±adir retraso escalonado a los elementos hijos para crear un efecto en cascada
                if (entry.target.classList.contains('module-grid')) {
                    const children = entry.target.querySelectorAll('.module');
                    children.forEach((child, index) => {
                        setTimeout(() => {
                            child.classList.add('in-view');
                        }, index * 150);
                    });
                }
                
                observer.unobserve(entry.target);
            }
        });
    }, {
        threshold: 0.15,
        rootMargin: '0px 0px -100px 0px'
    });
    
    fadeElements.forEach(element => {
        observer.observe(element);
    });
    
    // A√±adir efecto de paralaje en movimiento
    window.addEventListener('scroll', function() {
        const scrollPosition = window.scrollY;
        
        // Paralaje para las im√°genes de dashboard
        document.querySelectorAll('.dashboard-image').forEach(function(image, index) {
            const speed = 0.05 * (index + 1);
            const yPos = scrollPosition * speed;
            image.style.transform = `translateY(${yPos}px)`;
        });
    });
    </script>
    
<script>
// A√±ade este c√≥digo al final de tu archivo JavaScript existente

document.addEventListener('DOMContentLoaded', function() {
    // Obtener referencia a los botones del h√©roe una vez que se hayan creado
    const heroContent = document.querySelector('.hero-content');
    
    // Observador para detectar cuando se a√±aden los botones al DOM
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.addedNodes.length) {
                const heroButtons = document.querySelector('.hero-buttons');
                if (heroButtons) {
                    // Configurar el bot√≥n "Explorar Dashboards"
                    const dashboardButton = heroButtons.querySelector('.hero-button.primary');
                    if (dashboardButton) {
                        dashboardButton.addEventListener('click', function() {
                            // Desplazarse suavemente a la secci√≥n de dashboards
                            const dashboardSection = document.querySelector('.dashboard-modules');
                            if (dashboardSection) {
                                dashboardSection.scrollIntoView({ behavior: 'smooth' });
                            }
                        });
                    }
                    
                    // Configurar el bot√≥n "Conoce M√°s"
                    const moreButton = heroButtons.querySelector('.hero-button:not(.primary)');
                    if (moreButton) {
                        moreButton.addEventListener('click', function() {
                            // Desplazarse suavemente a la secci√≥n de formularios
                            const formulariosSection = document.querySelector('.modules');
                            if (formulariosSection) {
                                formulariosSection.scrollIntoView({ behavior: 'smooth' });
                            }
                        });
                    }
                    
                    // Detener el observador una vez que se hayan configurado los botones
                    observer.disconnect();
                }
            }
        });
    });
    
    // Iniciar la observaci√≥n del elemento hero-content
    observer.observe(heroContent, { childList: true, subtree: true });
    
    // En caso de que los botones ya existan en el DOM
    const existingHeroButtons = document.querySelector('.hero-buttons');
    if (existingHeroButtons) {
        const dashboardButton = existingHeroButtons.querySelector('.hero-button.primary');
        if (dashboardButton) {
            dashboardButton.addEventListener('click', function() {
                const dashboardSection = document.querySelector('.dashboard-modules');
                if (dashboardSection) {
                    dashboardSection.scrollIntoView({ behavior: 'smooth' });
                }
            });
        }
        
        const moreButton = existingHeroButtons.querySelector('.hero-button:not(.primary)');
        if (moreButton) {
            moreButton.addEventListener('click', function() {
                const formulariosSection = document.querySelector('.modules');
                if (formulariosSection) {
                    formulariosSection.scrollIntoView({ behavior: 'smooth' });
                }
            });
        }
    }
});
</script>
<script>
   // JavaScript actualizado para el frontend del chat
// Reemplaza el script existente en tu HTML

// Configuraci√≥n de Google Apps Script
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw6Wbq6iN6F4xDiajLwQjCy8ChnB_mqHQUFBfLoLOQ47FMzt7vSsr2dGhC89qmKBHk5/exec'; // Reemplaza con tu URL real

// Variables globales
let currentUser = null;
let messages = [];
let onlineUsers = [];
let lastMessageId = 0;
let isPolling = false;
let pollingInterval = null;
let userActivityInterval = null;

// Inicializar la aplicaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    initializeForum();
    setupEventListeners();
    startPolling();
});

// Inicializar el foro
function initializeForum() {
    // Verificar autenticaci√≥n
    currentUser = JSON.parse(localStorage.getItem('currentUser'));
    
    if (!currentUser) {
        alert('Debes iniciar sesi√≥n para acceder al foro');
        window.location.href = 'login.html';
        return;
    }

    // Registrar actividad del usuario
    updateUserActivity();
    
    // Configurar actualizaci√≥n peri√≥dica de actividad
    userActivityInterval = setInterval(updateUserActivity, 30000); // Cada 30 segundos
}

// Configurar event listeners
function setupEventListeners() {
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');

    // Enviar mensaje con Enter
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Auto-resize del textarea
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 100) + 'px';
    });

    // Enviar mensaje con bot√≥n
    sendButton.addEventListener('click', sendMessage);

    // Detectar cuando el usuario sale de la p√°gina
    window.addEventListener('beforeunload', function() {
        stopPolling();
    });

    // Detectar cuando la p√°gina se vuelve visible/invisible
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopPolling();
        } else {
            startPolling();
            updateUserActivity();
        }
    });
}

// Iniciar polling para mensajes y usuarios
function startPolling() {
    if (isPolling) return;
    
    isPolling = true;
    
    // Cargar mensajes inmediatamente
    loadMessages();
    loadOnlineUsers();
    
    // Configurar polling
    pollingInterval = setInterval(() => {
        loadMessages();
        loadOnlineUsers();
    }, 2000); // Cada 2 segundos
}

// Detener polling
function stopPolling() {
    isPolling = false;
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
    }
    if (userActivityInterval) {
        clearInterval(userActivityInterval);
        userActivityInterval = null;
    }
}

// Enviar mensaje
async function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const messageText = messageInput.value.trim();

    if (!messageText || !currentUser) return;

    // Deshabilitar bot√≥n mientras se env√≠a
    const sendButton = document.getElementById('sendButton');
    sendButton.disabled = true;

    try {
        const response = await fetch(GAS_WEB_APP_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'sendMessage',
                author: currentUser.fullName,
                role: currentUser.role,
                content: messageText,
                userId: currentUser.username || currentUser.email
            })
        });

        const result = await response.json();

        if (result.success) {
            // Limpiar input
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // Cargar mensajes inmediatamente
            await loadMessages();
            scrollToBottom();
        } else {
            console.error('Error enviando mensaje:', result.error);
            showNotification('Error enviando mensaje. Int√©ntalo de nuevo.', 'error');
        }

    } catch (error) {
        console.error('Error de conexi√≥n:', error);
        showNotification('Error de conexi√≥n. Verifica tu internet.', 'error');
    } finally {
        sendButton.disabled = false;
    }
}

// Cargar mensajes desde el servidor
async function loadMessages() {
    try {
        const url = `${GAS_WEB_APP_URL}?action=getMessages&lastMessageId=${lastMessageId}`;
        const response = await fetch(url);
        const data = await response.json();

        if (data.success && data.messages.length > 0) {
            // Agregar nuevos mensajes
            data.messages.forEach(message => {
                if (!messages.find(m => m.id === message.id)) {
                    messages.push(message);
                }
            });

            // Actualizar ID del √∫ltimo mensaje
            lastMessageId = data.lastMessageId;

            // Mantener solo los √∫ltimos 100 mensajes en memoria
            if (messages.length > 100) {
                messages = messages.slice(-100);
            }

            renderMessages();
        }

    } catch (error) {
        console.error('Error cargando mensajes:', error);
    }
}

// Cargar usuarios en l√≠nea
async function loadOnlineUsers() {
    try {
        const url = `${GAS_WEB_APP_URL}?action=getOnlineUsers`;
        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
            onlineUsers = data.users;
            renderOnlineUsers();
        }

    } catch (error) {
        console.error('Error cargando usuarios:', error);
    }
}

// Actualizar actividad del usuario
async function updateUserActivity() {
    if (!currentUser) return;

    try {
        await fetch(GAS_WEB_APP_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'updateUserActivity',
                userId: currentUser.username || currentUser.email,
                name: currentUser.fullName,
                role: currentUser.role,
                ip: await getUserIP()
            })
        });

    } catch (error) {
        console.error('Error actualizando actividad:', error);
    }
}

// Obtener IP del usuario (opcional)
async function getUserIP() {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
    } catch {
        return '';
    }
}

// Renderizar mensajes
function renderMessages() {
    const messagesArea = document.getElementById('messagesArea');
    const welcomeMessage = messagesArea.querySelector('.welcome-message');
    
    // Limpiar mensajes anteriores pero mantener mensaje de bienvenida
    const existingMessages = messagesArea.querySelectorAll('.message');
    existingMessages.forEach(msg => msg.remove());

    // Ordenar mensajes por timestamp
    const sortedMessages = [...messages].sort((a, b) => 
        new Date(a.timestamp) - new Date(b.timestamp)
    );

    sortedMessages.forEach(message => {
        const messageElement = createMessageElement(message);
        messagesArea.appendChild(messageElement);
    });

    scrollToBottom();
}

// Crear elemento de mensaje
function createMessageElement(message) {
    const messageDiv = document.createElement('div');
    const isOwnMessage = message.userId === (currentUser.username || currentUser.email);
    
    messageDiv.className = `message ${isOwnMessage ? 'own' : 'other'}`;
    
    const messageTime = new Date(message.timestamp).toLocaleString('es-CL', {
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });

    messageDiv.innerHTML = `
        <div class="message-header">
            <div class="message-author">
                <span>${escapeHtml(message.author)}</span>
                <span class="role-badge role-${message.role.toLowerCase()}">${getRoleDisplayName(message.role)}</span>
            </div>
            <div class="message-time">${messageTime}</div>
        </div>
        <div class="message-content">${escapeHtml(message.content).replace(/\n/g, '<br>')}</div>
    `;

    return messageDiv;
}

// Renderizar usuarios en l√≠nea
function renderOnlineUsers() {
    const userList = document.getElementById('userList');
    
    if (onlineUsers.length === 0) {
        userList.innerHTML = '<div class="empty-state">No hay usuarios conectados</div>';
        return;
    }

    // Ordenar usuarios: usuario actual primero, luego por nombre
    const sortedUsers = [...onlineUsers].sort((a, b) => {
        const currentUserId = currentUser.username || currentUser.email;
        if (a.userId === currentUserId) return -1;
        if (b.userId === currentUserId) return 1;
        return a.name.localeCompare(b.name);
    });

    userList.innerHTML = sortedUsers.map(user => {
        const isCurrentUser = user.userId === (currentUser.username || currentUser.email);
        return `
            <div class="user-chip ${isCurrentUser ? 'current-user' : ''}">
                <span class="online-indicator"></span>
                <span>${escapeHtml(user.name)}${isCurrentUser ? ' (T√∫)' : ''}</span>
                <span class="role-badge role-${user.role.toLowerCase()}">${getRoleDisplayName(user.role)}</span>
            </div>
        `;
    }).join('');
}

// Funci√≥n para mostrar nombre del rol
function getRoleDisplayName(role) {
    const roleNames = {
        'director': 'Director',
        'admin': 'Administrador',
        'combustible': 'Combustible',
        'user': 'Usuario'
    };
    return roleNames[role.toLowerCase()] || role;
}

// Escapar HTML para prevenir XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Scroll hacia abajo
function scrollToBottom() {
    const messagesArea = document.getElementById('messagesArea');
    messagesArea.scrollTop = messagesArea.scrollHeight;
}

// Mostrar notificaci√≥n
function showNotification(message, type = 'info') {
    // Crear elemento de notificaci√≥n
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    
    // Estilos inline para la notificaci√≥n
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
        ${type === 'error' ? 'background: #e74c3c;' : 'background: #27ae60;'}
    `;
    
    document.body.appendChild(notification);
    
    // Animar entrada
    setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Remover despu√©s de 3 segundos
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Manejar errores de conexi√≥n
window.addEventListener('online', function() {
    showNotification('Conexi√≥n restaurada', 'info');
    if (!isPolling) {
        startPolling();
    }
});

window.addEventListener('offline', function() {
    showNotification('Sin conexi√≥n a internet', 'error');
    stopPolling();
});
</script>
</body>
</html>