<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Municipalidad de Arica | mejor ciudad</title>
    <link rel="stylesheet" href="styles.css">
   <script src="comando_general.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
</head>

<body>
    <script src="auth.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<div class="loader">
    <div class="loader-animation">
        <div class="loader-circle"></div>
        <img src="images.png" alt="Logo" class="loader-logo">
    </div>
</div>
    <header>
    
        <div class="transparency-container">
        </div>
</div>
</header>
 
                <div class="top-header">
                    <div class="logo">
                        <img src="logo_MUNI.png" alt="Logo Municipalidad de Arica">
                        <div class="logo-text">
                            <h1>ARICA</h1>
                            <span>MUNICIPALIDAD | mejor ciudad</span>
                        </div>
                    </div>
                </div>
    
  

   
    <nav>
        <ul class="main-menu">
            <li><a href="index.html">INICIO</a></li>
            <li><a href="dashboard-gps.html">GPS DIMAO</a></li>
            <li><a href="dashboard-presupuesto.html">PRESUPUESTO ANUAL</a></li>
            <li><a href="dashboard-abastecimiento.html">ABASTECIMIENTO</a></li>
            <li><a href="dashboard-bodega.html">BODEGA</a></li>
        </ul>
    </nav>
    

    <section class="hero">
        <img src="fondo.jpg" alt="JUNIOR BARRERA" class="hero-image">
        <div class="hero-content">
            <h2>DIMAO</h2>
            <p>"Mejoremos Juntos"</p>
        </div>
    </section>
   
 
<section class="modules">
    <h2 class="fade-in">Sistema Integral de Gestión DIMAO</h2>
    <div class="module-grid">
        <div class="module fade-in">
            <div class="module-icon">📄</div>
            
            <h3>Sistema de Gestión de Presupuesto Anual de Compra</h3>
            <p>Este formulario permite planificar, registrar y gestionar el Presupuesto Anual de Compra (PAC) de materiales y servicios necesarios para el funcionamiento de DIMAO. Facilita la proyección de necesidades, el control del gasto y la programación de adquisiciones, asegurando una correcta administración de los recursos financieros durante el año.</p>
            <button class="module-button" onclick="redirectToDashboard('formulario')">
                Acceder <span class="ml-2">→</span>
                
            </button>
        </div>
        
        <div class="module fade-in">
            <div class="module-icon">🚗</div>
            <h3>Sistema de Gestión de Mantenimiento de Vehículos y Maquinaria </h3>
            <p>Este formulario está diseñado para registrar solicitudes de mantenimiento preventivo y correctivo de vehículos y maquinaria pertenecientes a la institución. Por favor, asegúrese de llenar todos los campos requeridos con información clara y precisa para facilitar una atención eficiente y oportuna por parte de la Oficina de Mantenimiento.</p>
            <button class="module-button" onclick="redirectToDashboard('formulario2')">
                Acceder <span class="ml-2">→</span>
            </button>
        </div>
        
        <div class="module fade-in">
            <div class="module-icon">💡</div>
            <h3>Sistema de Control y Mantenimiento de Iluminación Pública</h3>
            <p>Este formulario está destinado a registrar, actualizar y gestionar información relacionada con las solicitudes, reportes, y gestiones internas de la Oficina de Iluminación Pública. Permite sistematizar datos sobre mantenimiento, instalación, stock de materiales, y atención de requerimientos ciudadanos, contribuyendo a una administración más eficiente y organizada de los recursos de iluminación urbana.</p>
            <button class="module-button" onclick="redirectToDashboard('formulario3')">
                Acceder <span class="ml-2">→</span>
            </button>
        </div>
        <div class="module fade-in">
            <div class="module-icon">📄</div>
            
            <h3>Sistema de Reclamos</h3>
            <p>Plataforma para reportar y dar seguimiento a problemas relacionados con iluminación pública, áreas verdes y espacios públicos en la comunidad.</p>
            <button class="module-button" onclick="redirectToDashboard('formulario4')">
                Acceder <span class="ml-2">→</span> 
            </button>
        </div>

    </div>
</section>
<div class="container">
     <div class="container">
        <div class="forum-header">
            <h1 class="forum-title">🌐 DIMAO Conecta</h1>
            <p class="forum-subtitle">Foro de Comunicación Interdepartamental</p>
        </div>

        <div class="chat-container">
            <div class="messages-area" id="messagesArea">
                <div class="welcome-message">
                    <strong>¡Bienvenido al foro DIMAO Conecta!</strong><br>
                    Este es un espacio para la comunicación entre todos los departamentos.
                </div>
            </div>
            
            <div class="input-area">
                  <div class="message-type-selector">
                    <div class="type-button active" onclick="setMessageType('general')">
                        💬 General
                    </div>
                    <div class="type-button" onclick="setMessageType('direct')">
                        📧 Directo
                    </div>
                </div>
            
                <div class="recipient-selector" id="recipientSelector">
                    <select class="recipient-select" id="recipientSelect">
                        <option value="">Seleccionar destinatario...</option>
                    </select>
                </div>
                <div class="input-container">
                    <textarea 
                        id="messageInput" 
                        class="message-input" 
                        placeholder="Escribe tu mensaje aquí..."
                        rows="1"></textarea>
                          
    <button id="emojiButton" class="emoji-button" title="Seleccionar emoji">
👋
    </button>
                    <button id="sendButton" class="send-button">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                    </button>
                </div>
                
            </div>
        </div>

<div id="emojiPicker" class="emoji-picker">
    <div class="emoji-header">Selecciona un emoji</div>
    <div class="emoji-search">
        <input type="text" id="emojiSearch" placeholder="Buscar emoji...">
    </div>
    <div class="emoji-categories">
        <button class="category-btn active" data-category="smileys">😀</button>
        <button class="category-btn" data-category="people">👋</button>
        <button class="category-btn" data-category="nature">🐶</button>
        <button class="category-btn" data-category="food">🍎</button>
        <button class="category-btn" data-category="activities">⚽</button>
        <button class="category-btn" data-category="travel">🚗</button>
        <button class="category-btn" data-category="objects">⌚</button>
        <button class="category-btn" data-category="symbols">❤️</button>
    </div>
    <div id="emojiGrid" class="emoji-grid">
       
    </div>
</div>
        
        <div class="online-users">
            <h3>
                <span class="online-indicator"></span>
                Usuarios Conectados
            </h3>
            <div class="user-list" id="userList">
             
            </div>
        </div>
    </div>
</div>

<section class="modules">
    <h2 class="fade-in">DIMAO 360°</h2>
    <h4>Supervisión integral operativa, táctica y estratégica en tiempo real</h4>
 <div class="widgets-grid">
        
        <div class="widget weather">
            <div class="widget-icon">🌤️</div>
            <h3 class="widget-title">Clima en Arica</h3>
            <div class="widget-data" id="weather-temp">--°C</div>
            <div class="widget-details">
                <div id="weather-desc">Cargando...</div>
                <div>💧 <span id="weather-humidity">--%</span> | 🌬️ <span id="weather-wind">-- km/h</span></div>
            </div>
            <div class="update-time" id="weather-update">Actualizado: --</div>
        </div>
    </div>
    <div class="container">

            <div class="control-panel">
                <div class="controls-row">
                    <button class="control-btn" onclick="centerMap()">
                        📍 Centrar Mapa
                    </button>
                    <button class="control-btn" onclick="toggleSatellite()">
                        🛰️ Vista Satélite
                    </button>
                </div>
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>
<div class="module-grid">
  
      <div class="module fade-in">
        <div class="module-icon">📊</div>
        <h3>Centro de Mando DIMAO</h3>
        <p>Panel estratégico que consolida los indicadores clave de gestión de todas las áreas de DIMAO: iluminación, vehículos, áreas verdes, aseo, reclamos ciudadanos y PAC. Facilita la toma de decisiones rápidas y efectivas mediante visualización de datos en tiempo real y proyecciones inteligentes.</p>
        <button class="module-button" onclick="redirectToDashboard('centroMando')">
          Acceder <span class="ml-2">→</span>
        </button>
      </div>
  
      <div class="module fade-in">
        <div class="module-icon">🚨</div>
        <h3>Panel de Alertas Críticas</h3>
        <p>Herramienta de monitoreo proactivo que detecta, clasifica y notifica situaciones urgentes en los servicios municipales. Desde fallas en iluminación hasta vehículos fuera de servicio, el sistema prioriza incidentes y ayuda a coordinar una respuesta rápida con las unidades responsables.</p>
        <button class="module-button" onclick="redirectToDashboard('alertasCriticas')">
          Acceder <span class="ml-2">→</span>
        </button>
      </div>
    </div>

</section>

<section class="dashboard-modules">
    <h2 class="animated-title">Visualización de Módulos</h2>
    <p class="animated-subtitle">Accede a nuestros paneles de datos para conocer el funcionamiento de DIMAO</p>

    <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align: center; margin-top: 40px;">

        <h2>Asesoría Técnica</h2>
        <div style="height: 5px; width: 100%; background: linear-gradient(270deg, #ff0000, #ff7300, #fffb00, #00ff00, #00aaff, #a200ff, #ff00ff); background-size: 600% 600%; animation: moveGradient 10s ease infinite; margin-bottom: 40px;"></div>

        <div class="dashboard-grid">
            <div class="dashboard-card fade-in">
                <div class="dashboard-card-image" style="background-image: url('GPS.jpg')">
                    <div class="image-overlay">
                        <span class="card-badge">GPS</span>
                    </div>
                </div>
                <div class="dashboard-card-content">
                    <h3 class="animated-heading">GPS DIMAO</h3>
                    <p>Este módulo permite el seguimiento en tiempo real de los vehículos recolectores, analizando rutas, tiempos de operación y eficiencia del servicio para optimizar la gestión.</p>
                    <a href="dashboard-gps.html" class="view-dashboard">
                        <span>Ver Dashboard</span>
                        <i class="dashboard-icon">→</i>
                    </a>
                </div>
            </div>

            <div class="dashboard-card fade-in">
                <div class="dashboard-card-image" style="background-image: url('presupuesto.webp')">
                    <div class="image-overlay">
                        <span class="card-badge">PAC & F1</span>
                    </div>
                </div>
                <div class="dashboard-card-content">
                    <h3 class="animated-heading">Cuentas de Presupuesto Anual</h3>
                    <p>Este módulo permite el seguimiento y control del presupuesto anual, analizando ingresos, egresos y su distribución para una planificación eficiente de los recursos.</p>
                    <a href="dashboard-presupuesto.html" class="view-dashboard">
                        <span>Ver Dashboard</span>
                        <i class="dashboard-icon">→</i>
                    </a>
                </div>
            </div>

           
            <div class="dashboard-card fade-in">
                <div class="dashboard-card-image" style="background-image: url('abastecimiento.jpg')">
                    <div class="image-overlay">
                        <span class="card-badge">Combustible</span>
                    </div>
                </div>
                <div class="dashboard-card-content">
                    <h3 class="animated-heading">Abastecimiento de Combustible</h3>
                    <p>Este módulo proporciona información clave sobre el abastecimiento de combustible, incluyendo consumo, trámites realizados y tiempos de respuesta. Permite analizar tendencias y optimizar la gestión del suministro.</p>
                    <a href="dashboard-abastecimiento.html" class="view-dashboard">
                        <span>Ver Dashboard</span>
                        <i class="dashboard-icon">→</i>
                    </a>
                </div>
            </div>
            <div class="dashboard-card fade-in">
                <div class="dashboard-card-image" style="background-image: url('blog-tinta-toner.jpeg')">
                    <div class="image-overlay">
                        <span class="card-badge">Toner & Tintas</span>
                    </div>
                </div>
                <div class="dashboard-card-content">
                    <h3 class="animated-heading">Inventario de Toner & Tintas </h3>
                    <p>Este módulo permite visualizar y gestionar en tiempo real el stock de tóner y tintas disponibles. Ofrece un registro detallado y actualizado que facilita el control eficiente de insumos.</p>
                    <a href="toner.html" class="view-dashboard">
                        <span>Ver Inventario</span>
                        <i class="dashboard-icon">→</i>
                    </a>
                </div>
            </div>
        </div>
        <h2 style="margin-top: 60px;">Oficina de Mantenimiento de Vehículos y Maquinaria</h2>
        <div style="height: 5px; width: 100%; background: linear-gradient(270deg, #ff7300, #fffb00, #00ff00, #00aaff, #a200ff); background-size: 600% 600%; animation: moveGradient 10s ease infinite; margin-bottom: 40px;"></div>

        <div class="dashboard-grid">
            <div class="dashboard-card fade-in">
                <div class="dashboard-card-image" style="background-image: url('bodega.avif')">
                    <div class="image-overlay">
                        <span class="card-badge">Stock de Bodega Mecánica</span>
                    </div>
                </div>
                <div class="dashboard-card-content">
                    <h3 class="animated-heading">Stock de Bodega Mecánica</h3>
                    <p>Este módulo permite el control de inventario en la bodega mecánica, facilitando la gestión de repuestos, insumos y herramientas para un mantenimiento eficiente.</p>
                    <a href="dashboard-bodega.html" class="view-dashboard">
                        <span>Ver Dashboard</span>
                        <i class="dashboard-icon">→</i>
                    </a>
                </div>
            </div>
            <div class="dashboard-card fade-in">
                <div class="dashboard-card-image" style="background-image: url('vehiculo y maquinaria .jpeg')">
                    <div class="image-overlay">
                        <span class="card-badge">Vehículos y Maquinaria</span>
                    </div>
                </div>
                <div class="dashboard-card-content">
                    <h3 class="animated-heading">Vehículos y Maquinaria</h3>
                    <p>Este módulo proporciona información clave sobre el abastecimiento de combustible, incluyendo consumo, trámites realizados y tiempos de respuesta. Permite analizar tendencias y optimizar la gestión del suministro.</p>
                    <a href="dashboard-vehiculosymaquinaria.html" class="view-dashboard">
                        <span>Ver Dashboard</span>
                        <i class="dashboard-icon">→</i>
                    </a>
                </div>
            </div>
        </div>
        <h2 style="margin-top: 60px;">Iluminación Pública</h2>
        <div style="height: 5px; width: 100%; background: linear-gradient(270deg, #00c3ff, #ffff1c, #ff3c00); background-size: 600% 600%; animation: moveGradient 10s ease infinite; margin-bottom: 40px;"></div>

        <div class="dashboard-grid">
            <div class="dashboard-card fade-in">
                <div class="dashboard-card-image" style="background-image: url('CEMAFORO.jpeg')">
                    <div class="image-overlay">
                        <span class="card-badge">Iluminación Pública</span>
                    </div>
                </div>
                <div class="dashboard-card-content">
                    <h3 class="animated-heading">Iluminación Pública</h3>
                    <p>Este módulo proporciona información clave sobre la gestión de solicitudes de iluminación pública, incluyendo mantenimiento de luminarias, tiempos de atención, resolución de trabajos y localización geográfica. Permite visualizar las incidencias en un mapa de calor, analizar tendencias de fallas, optimizar la asignación de recursos y mejorar la eficiencia en la atención ciudadana.</p>
                    <a href="dashboard-iluminacion.html" class="view-dashboard">
                        <span>Ver Dashboard</span>
                        <i class="dashboard-icon">→</i>
                    </a>
                </div>
            </div>
            <div class="dashboard-card fade-in">
                <div class="dashboard-card-image" style="background-image: url('bombillas-electricas-aisladas_23-2151045845')">
                    <div class="image-overlay">
                        <span class="card-badge">Órdenes de Trabajo</span>
                    </div>
                </div>
                <div class="dashboard-card-content">
                    <h3 class="animated-heading">Órdenes de Trabajo de Iluminación</h3>
                    <p>Este módulo proporciona información clave sobre las órdenes de trabajo de iluminación pública, incluyendo mantenimiento de luminarias, tiempos de atención, estado de ejecución y ubicación geográfica de las solicitudes. Permite visualizar las intervenciones mediante mapas de calor, identificar patrones de fallas, optimizar la planificación de trabajos y mejorar la eficiencia operativa.</p>
                    <a href="dashboard-ordenes-trabajo-iluminacion.html" class="view-dashboard">
                        <span>Ver Dashboard</span>
                        <i class="dashboard-icon">→</i>
                    </a>
                </div>
            </div>
            <div class="dashboard-card fade-in">
                <div class="dashboard-card-image" style="background-image: url('iluminacion-en-bodegas.1.2.jpg')">
                    <div class="image-overlay">
                        <span class="card-badge">Stock Bodega Iluminación</span>
                    </div>
                </div>
                <div class="dashboard-card-content">
                    <h3 class="animated-heading">Stock Bodega de Iluminación</h3>
                    <p>El módulo "Stock bodega de iluminación" permite gestionar y visualizar en tiempo real la cantidad, tipo y estado de los productos de iluminación almacenados en la bodega. Incluye el control de entradas, salidas, stock disponible, y alertas de reposición para asegurar una adecuada disponibilidad de insumos como ampolletas, tubos, reflectores, cables, entre otros artículos relacionados.</p>
                    <a href="dashboard-stock-iluminacion.html" class="view-dashboard">
                        <span>Ver Dashboard</span>
                        <i class="dashboard-icon">→</i>
                    </a>
                </div>
            </div>
        </div>
        <h2 style="margin-top: 60px;">Reclamos</h2>
        <div style="height: 5px; width: 100%; background: linear-gradient(270deg, #f00000, #f4d03f, #16a085); background-size: 600% 600%; animation: moveGradient 10s ease infinite; margin-bottom: 40px;"></div>

        <div class="dashboard-grid">
            <div class="dashboard-card fade-in">
                <div class="dashboard-card-image" style="background-image: url('reclamociudadano.jpeg')">
                    <div class="image-overlay">
                        <span class="card-badge">Reclamos Ciudadanos</span>
                    </div>
                </div>
                <div class="dashboard-card-content">
                    <h3 class="animated-heading">Reclamos Ciudadanos</h3>
                    <p>Este módulo proporciona información clave sobre la gestión de solicitudes de iluminación pública, incluyendo mantenimiento de luminarias, tiempos de atención, resolución de trabajos y localización geográfica. Permite visualizar las incidencias en un mapa de calor, analizar tendencias de fallas, optimizar la asignación de recursos y mejorar la eficiencia en la atención ciudadana.</p>
                    <a href="dashboard-reclamos.html" class="view-dashboard">
                        <span>Ver Dashboard</span>
                        <i class="dashboard-icon">→</i>
                    </a>
                </div>
            </div>
        </div>

    </div>
</section>
<section class="modules">
    <h2 class="fade-in">Biblioteca Digital DIMAO</h2>
    <p class="section-subtitle">Todo el conocimiento institucional organizado y accesible en un solo lugar (EN CONSTRUCCION)</p>
    
    <div class="library-container">
        <div class="library-card search-card">
            <div class="search-box">
                <input type="text" id="docSearch" placeholder="Buscar manuales, procedimientos...">
                <button class="search-button">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </button>
            </div>
            <div class="search-filters">
                <select id="categoryFilter">
                    <option value="">Todas las categorías</option>
                    <option value="iluminacion">Iluminación Pública</option>
                    <option value="vehiculos">Vehículos y Maquinaria</option>
                    <option value="areas-verdes">Áreas Verdes</option>
                    <option value="aseo">Aseo y Ornato</option>
                </select>
                <select id="typeFilter">
                    <option value="">Todos los tipos</option>
                    <option value="manual">Manuales</option>
                    <option value="procedimiento">Procedimientos</option>
                    <option value="formato">Formatos</option>
                    <option value="video">Videotutoriales</option>
                </select>
            </div>
        </div>
        <div class="library-card category-card" data-category="iluminacion" onclick="showCategory('iluminacion')">
            <div class="category-icon">💡</div>
            <h3>Iluminación Pública</h3>
            <p>Manuales técnicos, diagramas eléctricos y protocolos de mantenimiento</p>
            <span class="doc-count">48 documentos</span>
        </div>

        <div class="library-card category-card" data-category="vehiculos" onclick="showCategory('vehiculos')">
            <div class="category-icon">🚛</div>
            <h3>Vehículos y Maquinaria</h3>
            <p>Fichas técnicas, checklist de revisión y manuales de taller</p>
            <span class="doc-count">32 documentos</span>
        </div>

        <div class="library-card category-card" data-category="areas-verdes" onclick="showCategory('areas-verdes')">
            <div class="category-icon">🌳</div>
            <h3>Áreas Verdes</h3>
            <p>Guías de poda, especies recomendadas y sistemas de riego</p>
            <span class="doc-count">25 documentos</span>
        </div>

        <div class="library-card category-card" data-category="aseo" onclick="showCategory('aseo')">
            <div class="category-icon">🧹</div>
            <h3>Aseo y Ornato</h3>
            <p>Protocolos de limpieza, rutas de recolección y manejo de residuos</p>
            <span class="doc-count">41 documentos</span>
        </div>
        <div class="library-card recent-docs">
            <h3>📌 Documentos Recientes</h3>
            <ul class="documents-list">
                <li>
                    <a href="#">
                        <span class="doc-icon">📄</span>
                        <span class="doc-title">Protocolo de mantenimiento preventivo - Camiones recolectores</span>
                        <span class="doc-date">Actualizado: 15/06/2024</span>
                    </a>
                </li>
                <li>
                    <a href="#">
                        <span class="doc-icon">🎥</span>
                        <span class="doc-title">Videotutorial: Reparación básica de luminarias LED</span>
                        <span class="doc-date">Publicado: 10/06/2024</span>
                    </a>
                </li>
                <li>
                    <a href="#">
                        <span class="doc-icon">📝</span>
                        <span class="doc-title">Formulario F-007: Solicitud de materiales en bodega</span>
                        <span class="doc-date">Versión: 2.1 (2024)</span>
                    </a>
                </li>
            </ul>
            <button class="view-all-btn">Ver todos los documentos →</button>
        </div>
    </div>
</section>
<div id="docModal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <div class="modal-header">
            <h2 id="modalTitle">Manual de Procedimientos</h2>
            <div class="doc-meta">
                <span class="doc-category">Iluminación Pública</span>
                <span class="doc-version">Versión 3.2</span>
                <span class="doc-date">Actualizado: 05/06/2024</span>
            </div>
        </div>
        <div class="modal-body">
            <iframe id="docViewer" src="" frameborder="0"></iframe>
        </div>
        <div class="modal-footer">
            <button class="download-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Descargar PDF
            </button>
            <div class="doc-actions">
                <button class="action-btn" title="Imprimir">🖨️</button>
                <button class="action-btn" title="Compartir">📤</button>
                <button class="action-btn" title="Marcar como favorito">⭐</button>
            </div>
        </div>
    </div>
</div>

<footer>
    <div class="footer-container">
        <div class="footer-column">
            <h3>Municipalidad de Arica</h3>
            <p>Renato Rocca , Arica</p>
            <p>Anexo: 6959</p>
            <p>Email: roberto.mamani@municipalidadarica.cl</p>
            <div class="social-icons">
                <a href="#">📘</a>
                <a href="#">📱</a>
                <a href="#">🐦</a>
                <a href="#">📸</a>
            </div>
        </div>
        
        <div class="footer-column">
            <h3>Colaboración Interdepartamental</h3>
            <p style="line-height: 1.6;">
                Este proyecto surge con el propósito de fortalecer la colaboración entre diversas áreas municipales, como <strong>iluminación pública</strong>, <strong>Of. Mantenimiento de Vehículos y Maquinaria</strong>, <strong>Aseo y Ornato</strong>, <strong>Asesoría Técnica</strong> y más, en un solo sistema integral. 
                Buscando consolidar la información y los procesos en un solo sistema, permitiendo un <strong>mayor control operativo</strong>, <strong>gestión por áreas</strong> y una visión integral para la <strong>mejora continua de los servicios municipales</strong>.
            </p>
        </div>
        <div class="footer-column licitaciones">
            <h3>Licitaciones</h3>
            <ul class="licitaciones-list">
                <li><a href="licitacion_agil.html">Licitación Ágil</a></li>
                <li><a href="licitacion_gran_compra.html">Gran Compra</a></li>
                <li><a href="licitacion_trato_directo.html">Trato Directo</a></li>
                <li><a href="licitacion_publica.html">Licitación Pública</a></li>
                <li><a href="licitacion_convenio_marco.html">Convenio Marco</a></li>
            </ul>
        </div>
    </div>

    <div class="footer-bottom">
        <p>© 2025 Municipalidad de Arica. Todos los derechos reservados.</p>
        <p>Desarrollado por Junior Barrera</p>
    </div>
</footer>


    <div class="assistant-button" onclick="openAssistance()">💬</div>

<div class="accessibility-floating-btn" id="accessibilityBtn" title="Accesibilidad">
    <span aria-hidden="true">♿</span>
</div>

<div class="accessibility-panel" id="accessibilityPanel">
    <div class="accessibility-header">
        <h3>Accesibilidad</h3>
        <button class="close-panel" id="closePanel">&times;</button>
    </div>
    
    <div class="accessibility-option">
        <button id="darkModeToggle">🌙 Modo oscuro</button>
    </div>
    
    <div class="accessibility-option">
        <label>Tamaño del texto:</label>
        <div class="font-controls">
            <button id="fontDecrease" title="Texto más pequeño">A-</button>
            <button id="fontReset" title="Tamaño normal">A</button>
            <button id="fontIncrease" title="Texto más grande">A+</button>
        </div>
    </div>
</div>

<script>
// Mostrar/ocultar panel
const accessibilityBtn = document.getElementById('accessibilityBtn');
const accessibilityPanel = document.getElementById('accessibilityPanel');
const closePanel = document.getElementById('closePanel');

accessibilityBtn.addEventListener('click', () => {
    accessibilityPanel.style.display = accessibilityPanel.style.display === 'block' ? 'none' : 'block';
});

closePanel.addEventListener('click', () => {
    accessibilityPanel.style.display = 'none';
});

// Modo oscuro
const darkModeToggle = document.getElementById('darkModeToggle');

darkModeToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    darkModeToggle.textContent = document.body.classList.contains('dark-mode') ? '☀️ Modo claro' : '🌙 Modo oscuro';
});

// Tamaño de texto
document.getElementById('fontIncrease').addEventListener('click', () => changeFontSize(1));
document.getElementById('fontReset').addEventListener('click', () => changeFontSize(0));
document.getElementById('fontDecrease').addEventListener('click', () => changeFontSize(-1));

function changeFontSize(change) {
    const sizes = ['font-small', 'font-medium', 'font-large'];
    let currentSize = localStorage.getItem('fontSize') || 'font-medium';
    let currentIndex = sizes.indexOf(currentSize);
    
    if (change === 1 && currentIndex < sizes.length - 1) currentIndex++;
    if (change === -1 && currentIndex > 0) currentIndex--;
    if (change === 0) currentIndex = 1; // Reset a medium
    
    document.body.classList.remove(...sizes);
    document.body.classList.add(sizes[currentIndex]);
    localStorage.setItem('fontSize', sizes[currentIndex]);
}

// Cargar preferencias al iniciar
function loadPreferences() {
    // Modo oscuro
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        darkModeToggle.textContent = '☀️ Modo claro';
    }
    
    // Tamaño de texto
    const savedFontSize = localStorage.getItem('fontSize');
    if (savedFontSize) {
        document.body.classList.add(savedFontSize);
    }
}

// Inicializar
document.addEventListener('DOMContentLoaded', loadPreferences);

</script>
      <script>
        // Datos de Arica
        const ARICA_COORDS = [-18.4746, -70.2979];
        
        // Actualizar hora
        function getCurrentTime() {
            return new Date().toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' });
        }
        
        // ===== WIDGET CLIMA =====
        async function updateWeather() {
            try {
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${ARICA_COORDS[0]}&longitude=${ARICA_COORDS[1]}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code&timezone=auto`);
                const data = await response.json();
                
                document.getElementById('weather-temp').textContent = `${data.current.temperature_2m}°C`;
                document.getElementById('weather-humidity').textContent = `${data.current.relative_humidity_2m}%`;
                document.getElementById('weather-wind').textContent = `${data.current.wind_speed_10m} km/h`;
                document.getElementById('weather-desc').textContent = getWeatherDescription(data.current.weather_code);
                document.getElementById('weather-update').textContent = `Actualizado: ${getCurrentTime()}`;
            } catch (error) {
                console.error("Error al cargar clima:", error);
                document.getElementById('weather-desc').textContent = "Datos no disponibles";
            }
        }
        
   
         
        // Helper: Traducir códigos de clima
        function getWeatherDescription(code) {
            const codes = {
                0: "Despejado", 1: "Mayormente despejado", 2: "Parcialmente nublado",
                3: "Nublado", 45: "Niebla", 61: "Lluvia ligera", 80: "Chubascos"
            };
            return codes[code] || "Despejado";
        }
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            updateWeather();
            updateAirQuality();
            updateAlerts();
            updateTraffic();
            
            // Actualizar cada 5 minutos
            setInterval(updateWeather, 300000);
            setInterval(updateAirQuality, 300000);
            setInterval(updateAlerts, 300000);
            setInterval(updateTraffic, 300000);
        });
    </script>
    <script>
    let map;
    let showLighting = true;
    let currentBaseLayer = 'street';
    let currentStatusFilter = 'all';
    let currentPriorityFilter = 'all';
    let assignments = [];
    let satelliteTileLayer;
    let streetTileLayer;

    // Inicializar el mapa
    function initMap() {
        map = L.map('map', {
            attributionControl: false // Desactiva el control de atribución
        }).setView([-18.4746, -70.3045], 13);

        // Eliminar cualquier atribución existente (doble protección)
        setTimeout(removeLeafletAttribution, 50);

        // Capas base sin atribución
        streetTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ''
        });

        satelliteTileLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: ''
        });

        streetTileLayer.addTo(map);
        
        // Cargar datos iniciales
        loadRecyclingPoints();
        loadMunicipalPoints();
        loadLightingZones();
        updateZoneSelects();
        updateStats();
        setupFilters();
    }

    // Función para eliminar la atribución de Leaflet
    function removeLeafletAttribution() {
        const attributions = document.querySelectorAll('.leaflet-control-attribution');
        attributions.forEach(attribution => {
            attribution.remove();
        });
    }

    // Centrar mapa
    function centerMap() {
        map.setView([-18.4746, -70.3045], 13);
    }

    // Alternar vista satelital
    function toggleSatellite() {
        if (currentBaseLayer === 'street') {
            map.removeLayer(streetTileLayer);
            map.addLayer(satelliteTileLayer);
            currentBaseLayer = 'satellite';
        } else {
            map.removeLayer(satelliteTileLayer);
            map.addLayer(streetTileLayer);
            currentBaseLayer = 'street';
        }
        removeLeafletAttribution(); // Limpiar por si acaso
    }

    // Mostrar formulario de zona
    function showZoneForm() {
        document.getElementById('zoneForm').style.display = 'block';
        document.querySelectorAll('.form-input, .form-select').forEach(input => {
            input.value = input.type !== 'number' ? '' : '';
        });
        document.getElementById('zoneStatus').value = 'Regular';
        document.getElementById('zonePriority').value = 'Media';
    }

    // Inicializar cuando la página esté lista
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initMap);
    } else {
        initMap();
    }

    </script>
    
    <script>
        // Función para redirigir a dashboards o formularios con verificación estricta de permisos
function redirectToDashboard(dashboardType) {
    // Primero verificamos si el usuario está autenticado
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    
    if (!currentUser) {
        window.location.href = 'login.html';
        return;
    }
    
    // Mapeo exacto de tipos de dashboard a páginas y permisos requeridos
    const dashboardMappings = {
        'presupuesto': {
            page: 'dashboard-gps.html',
            permission: 'dashboard-gps'
        },
        'obras': {
            page: 'dashboard-presupuesto.html',
            permission: 'dashboard-presupuesto'
        },
        'servicios': {
            page: 'dashboard-abastecimiento.html',
            permission: 'dashboard-abastecimiento'
        },
        'seguridad': {
            page: 'dashboard-seguridad.html',
            permission: 'dashboard-seguridad'
        },
        'formulario': {
            page: 'formulario-1.html',
            permission: 'formulario-1'
        },
        'formulario2': {
            page: 'formulario-2.html',
            permission: 'formulario-2'
        },
        'formulario3': {
            page: 'formulario-3.html',
            permission: 'formulario-3'
        },
        'formulario4': {
            page: 'formulario-4.html',
            permission: 'formulario-4' 
        },
        // Añadir mapeos directos para cada tipo de dashboard
        'dashboard-gps': {
            page: 'dashboard-gps.html',
            permission: 'dashboard-gps'
        },
        'dashboard-presupuesto': {
            page: 'dashboard-presupuesto.html',
            permission: 'dashboard-presupuesto'
        },
        'dashboard-abastecimiento': {
            page: 'dashboard-abastecimiento.html',
            permission: 'dashboard-abastecimiento'
        },
        'dashboard-bodega': {
            page: 'dashboard-bodega.html',
            permission: 'dashboard-bodega'
        },
        'dashboard-reclamos': {
            page: 'dashboard-reclamos.html',
            permission: 'dashboard-reclamos'
        },
        'dashboard-vehiculosymaquinaria': {
            page: 'dashboard-vehiculosymaquinaria.html',
            permission: 'dashboard-vehiculosymaquinaria'
        },
        'dashboard-iluminacion': {
            page: 'dashboard-iluminacion.html',
            permission: 'dashboard-iluminacion'
        },
        'dashboard-ordenes-trabajo-iluminacion': {
            page: 'dashboard-ordenes-trabajo-iluminacion',
            permission: 'dashboard-ordenes-trabajo-iluminacion'
        },
        'dashboard-stock-iluminacion': {
            page: 'dashboard-stock-iluminacion.html',
            permission: 'dashboard-stock-iluminacion'
        },
         'centroMando': {
        page: 'director.html',
        permission: 'director'
    },
    'alertasCriticas': {
        page: 'alerta.html',
        permission: 'alertas'
    }
};
    
    // Obtener la configuración para este tipo de dashboard
    const dashboardConfig = dashboardMappings[dashboardType];
    
    // Si no se identificó una configuración válida, no hacer nada
    if (!dashboardConfig) {
        console.error('Tipo de dashboard no reconocido:', dashboardType);
        return;
    }
    
    // Verificar permisos de manera estricta
    if (hasStrictPermission(currentUser, dashboardConfig.permission)) {
        window.location.href = dashboardConfig.page;
    } else {
        // Mostrar mensaje de acceso denegado
        showAccessDeniedMessage();
    }
}

// Función mejorada para verificar permisos de manera estricta
function hasStrictPermission(user, requiredPermission) {
    // Director y admin tienen acceso completo
    if (user.role === 'director' || user.role === 'admin') {
        return true;
    }
    
    // Casos especiales
    if (user.permissions) {
        // Caso especial para supervisor con permiso de combustible
        if (user.role === 'Combustible' && 
            requiredPermission === 'dashboard-abastecimiento' && 
            user.permissions.includes('combustible')) {
            return true;
        }
    // Caso especial para formulario-1 (PAC)
    if (requiredPermission === 'formulario-1' && user.permissions.includes('pac')) {
            return true;
        }
        
        // Verificación directa del permiso
        if (user.permissions.includes(requiredPermission)) {
            return true;
        }
    }
    
    // Si no cumple ninguna condición anterior, no tiene permiso
    return false;
}



// Función para deshabilitar visualmente los botones de acceso según permisos
function updateAccessButtonsVisibility() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    
    if (!currentUser) return;
    
    // Obtener todos los botones de módulo
    const moduleButtons = document.querySelectorAll('.module-button');
    
    moduleButtons.forEach(button => {
        // Obtener el tipo de dashboard del evento onclick
        const onclickAttr = button.getAttribute('onclick');
        if (!onclickAttr) return;
        
        // Extraer el tipo de dashboard
        const match = onclickAttr.match(/redirectToDashboard\(['"]([^'"]+)['"]\)/);
        if (!match || !match[1]) return;
        
        const dashboardType = match[1];
        
        // Mapeo de tipos de dashboard a permisos requeridos
        const permissionMap = {
            'presupuesto': 'dashboard-gps',
            'obras': 'dashboard-presupuesto',
            'servicios': 'dashboard-abastecimiento',
            'seguridad': 'dashboard-seguridad',
            'reclamos': 'dashboard-reclamos',
            'vehiculos': 'dashboard-vehiculosymaquinaria',
            'formulario': 'formulario-1',
            'formulario2': 'formulario-2',
            'formulario3': 'formulario-3',
            'formulario4': 'formulario-4',  // CORREGIDO
            'dashboard-gps': 'dashboard-gps',
            'dashboard-presupuesto': 'dashboard-presupuesto',
            'dashboard-abastecimiento': 'dashboard-abastecimiento',
            'dashboard-bodega': 'dashboard-bodega',
            'dashboard-reclamos': 'dashboard-reclamos',
            'dashboard-vehiculosymaquinaria': 'dashboard-vehiculosymaquinaria',
            'dashboard-iluminacion': 'dashboard-iluminacion',
            'dashboard-ordenes-trabajo-iluminacion': 'dashboard-ordenes-trabajo-iluminacion',
            'dashboard-stock-iluminacion': 'dashboard-stock-iluminacion',
        };
        
        const requiredPermission = permissionMap[dashboardType];
        
        // Verificar si el usuario tiene permiso
        if (!hasStrictPermission(currentUser, requiredPermission)) {
            // Deshabilitar visualmente el botón
            button.disabled = true;
            button.classList.add('disabled-button');
            button.style.backgroundColor = '#ccc';
            button.style.cursor = 'not-allowed';
            button.style.color = '#666';
            
            // Opcional: Cambiar el texto del botón
            button.innerHTML = 'Sin acceso <span class="ml-2">🔒</span>';
        }
    });
    
    // También actualizar los botones de dashboard
    const dashboardLinks = document.querySelectorAll('.view-dashboard');
    
    dashboardLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (!href) return;
        
        // Extraer el tipo de dashboard de la URL
        const dashboardType = href.replace('.html', '');
        
        // Verificar si el usuario tiene permiso
        if (!hasStrictPermission(currentUser, dashboardType)) {
            // Prevent default behavior
            link.addEventListener('click', function(e) {
                e.preventDefault();
                showAccessDeniedMessage();
            });
            
            // Deshabilitar visualmente el link
            link.classList.add('disabled-link');
            link.style.color = '#999';
            link.style.pointerEvents = 'all'; // Mantener habilitado para poder mostrar el mensaje
            link.style.cursor = 'not-allowed';
            
            // Opcional: Cambiar el texto
            link.innerHTML = '<span>Sin acceso</span> <i class="dashboard-icon">🔒</i>';
        }
    });
}

// Llamar a esta función cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
    // Verificar permisos del usuario para la página actual
    checkPagePermission();
    
    // Actualizar visibilidad de botones de acceso
    updateAccessButtonsVisibility();
});   
        // Function to open assistance chat
        function openAssistance() {
            // Replace with your actual phone number for WhatsApp
            const phoneNumber = "959414178"; // Replace with your actual number
            window.open(`https://wa.me/${phoneNumber}`, '_blank');
        }
        
        // Animation for elements when they come into view
        document.addEventListener('DOMContentLoaded', function() {
            const fadeElements = document.querySelectorAll('.fade-in');
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('in-view');
                        observer.unobserve(entry.target);
                    }
                });
            }, {
                threshold: 0.1
            });
            
            fadeElements.forEach(element => {
                observer.observe(element);
            });
            
            // Header scroll effect
            const header = document.querySelector('header');
            let lastScrollTop = 0;
            
            window.addEventListener('scroll', () => {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                if (scrollTop > 100) {
                    header.style.boxShadow = '0 5px 20px rgba(0, 0, 0, 0.1)';
                } else {
                    header.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.05)';
                }
                
                lastScrollTop = scrollTop;
            });
        });
    </script>
   
   
    <script>
        // Add this to your existing script section
        document.addEventListener('DOMContentLoaded', function() {
            const transparencyToggle = document.querySelector('.transparency-toggle');
            const transparencyLinks = document.querySelector('.transparency-links');
            
            // Check if elements exist
            if (transparencyToggle && transparencyLinks) {
                transparencyToggle.addEventListener('click', function() {
                    transparencyToggle.classList.toggle('active');
                    transparencyLinks.classList.toggle('active');
                });
                
                // Initialize menu state based on screen width
                function checkScreenWidth() {
                    if (window.innerWidth <= 768) {
                        transparencyLinks.classList.remove('active');
                    } else {
                        transparencyLinks.classList.add('active');
                    }
                }
                
                // Check on load and resize
                checkScreenWidth();
                window.addEventListener('resize', checkScreenWidth);
            }
        });
        // Loader - ocultar después de cargar la página
    window.addEventListener('load', function() {
        setTimeout(function() {
            document.querySelector('.loader').classList.add('hidden');
        }, 800);
    });
    
    // Efecto de partículas para el hero
    document.addEventListener('DOMContentLoaded', function() {
        const heroSection = document.querySelector('.hero');
        
        // Crear el contenedor de partículas
        const particlesContainer = document.createElement('div');
        particlesContainer.className = 'particles-container';
        heroSection.appendChild(particlesContainer);
        
        // Crear partículas
        for (let i = 0; i < 50; i++) {
            createParticle(particlesContainer);
        }
        
        // Agregar botones al hero
        const heroContent = document.querySelector('.hero-content');
        const heroButtons = document.createElement('div');
        heroButtons.className = 'hero-buttons';
        heroButtons.innerHTML = `
            <button class="hero-button primary">Explorar Dashboards <span>→</span></button>
            <button class="hero-button">Conoce Más <span>↓</span></button>
        `;
        heroContent.appendChild(heroButtons);
        
        // Agregar efecto de movimiento en el hero
        heroSection.addEventListener('mousemove', function(e) {
            const xPos = (e.clientX / window.innerWidth) - 0.5;
            const yPos = (e.clientY / window.innerHeight) - 0.5;
            
            const heroImage = document.querySelector('.hero-image');
            heroImage.style.transform = `translate(${xPos * 20}px, ${yPos * 20}px) scale(1.1)`;
            
            const heroContent = document.querySelector('.hero-content');
            heroContent.style.transform = `translate(${xPos * -30}px, ${yPos * -30}px)`;
        });
    });
    
    // Función para crear partículas
    function createParticle(container) {
        const particle = document.createElement('div');
        
        // Estilo aleatorio para cada partícula
        var size = Math.random() * 5 + 1;
        var opacity = Math.random() * 0.5 + 0.1;
        
        // Posición aleatoria
        var xPos = Math.random() * 100;
        var yPos = Math.random() * 100;
        
        // Velocidad aleatoria
        var speedX = (Math.random() - 0.5) * 0.5;
        var speedY = (Math.random() - 0.5) * 0.5;
        
        // Aplicar estilos
        particle.style.cssText = `
            position: absolute;
            width: ${size}px;
            height: ${size}px;
            background-color: rgba(255, 255, 255, ${opacity});
            border-radius: 50%;
            top: ${yPos}%;
            left: ${xPos}%;
            pointer-events: none;
        `;
        
        container.appendChild(particle);
        
        // Animación de movimiento
        let x = xPos;
        let y = yPos;
        
        function moveParticle() {
            x += speedX;
            y += speedY;
            
            // Rebote en los bordes
            if (x < 0 || x > 100) {
                x = Math.max(0, Math.min(100, x));
                speedX *= -1;
            }
            
            if (y < 0 || y > 100) {
                y = Math.max(0, Math.min(100, y));
                speedY *= -1;
            }
            
            particle.style.left = x + '%';
            particle.style.top = y + '%';
            
            requestAnimationFrame(moveParticle);
        }
        
        moveParticle();
    }
    
    // Mejorar las animaciones de scroll existentes
    const fadeElements = document.querySelectorAll('.fade-in');
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('in-view');
                
                // Añadir retraso escalonado a los elementos hijos para crear un efecto en cascada
                if (entry.target.classList.contains('module-grid')) {
                    const children = entry.target.querySelectorAll('.module');
                    children.forEach((child, index) => {
                        setTimeout(() => {
                            child.classList.add('in-view');
                        }, index * 150);
                    });
                }
                
                observer.unobserve(entry.target);
            }
        });
    }, {
        threshold: 0.15,
        rootMargin: '0px 0px -100px 0px'
    });
    
    fadeElements.forEach(element => {
        observer.observe(element);
    });
    
    // Añadir efecto de paralaje en movimiento
    window.addEventListener('scroll', function() {
        const scrollPosition = window.scrollY;
        
        // Paralaje para las imágenes de dashboard
        document.querySelectorAll('.dashboard-image').forEach(function(image, index) {
            const speed = 0.05 * (index + 1);
            const yPos = scrollPosition * speed;
            image.style.transform = `translateY(${yPos}px)`;
        });
    });
    </script>
    
<script>
// Añade este código al final de tu archivo JavaScript existente

document.addEventListener('DOMContentLoaded', function() {
    // Obtener referencia a los botones del héroe una vez que se hayan creado
    const heroContent = document.querySelector('.hero-content');
    
    // Observador para detectar cuando se añaden los botones al DOM
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.addedNodes.length) {
                const heroButtons = document.querySelector('.hero-buttons');
                if (heroButtons) {
                    // Configurar el botón "Explorar Dashboards"
                    const dashboardButton = heroButtons.querySelector('.hero-button.primary');
                    if (dashboardButton) {
                        dashboardButton.addEventListener('click', function() {
                            // Desplazarse suavemente a la sección de dashboards
                            const dashboardSection = document.querySelector('.dashboard-modules');
                            if (dashboardSection) {
                                dashboardSection.scrollIntoView({ behavior: 'smooth' });
                            }
                        });
                    }
                    
                    // Configurar el botón "Conoce Más"
                    const moreButton = heroButtons.querySelector('.hero-button:not(.primary)');
                    if (moreButton) {
                        moreButton.addEventListener('click', function() {
                            // Desplazarse suavemente a la sección de formularios
                            const formulariosSection = document.querySelector('.modules');
                            if (formulariosSection) {
                                formulariosSection.scrollIntoView({ behavior: 'smooth' });
                            }
                        });
                    }
                    
                    // Detener el observador una vez que se hayan configurado los botones
                    observer.disconnect();
                }
            }
        });
    });
    
    // Iniciar la observación del elemento hero-content
    observer.observe(heroContent, { childList: true, subtree: true });
    
    // En caso de que los botones ya existan en el DOM
    const existingHeroButtons = document.querySelector('.hero-buttons');
    if (existingHeroButtons) {
        const dashboardButton = existingHeroButtons.querySelector('.hero-button.primary');
        if (dashboardButton) {
            dashboardButton.addEventListener('click', function() {
                const dashboardSection = document.querySelector('.dashboard-modules');
                if (dashboardSection) {
                    dashboardSection.scrollIntoView({ behavior: 'smooth' });
                }
            });
        }
        
        const moreButton = existingHeroButtons.querySelector('.hero-button:not(.primary)');
        if (moreButton) {
            moreButton.addEventListener('click', function() {
                const formulariosSection = document.querySelector('.modules');
                if (formulariosSection) {
                    formulariosSection.scrollIntoView({ behavior: 'smooth' });
                }
            });
        }
    }
});
</script>
<script>
   
// Variables para el selector de emojis
let currentEmojiCategory = 'smileys';
let emojiPickerVisible = false;

// Configuración de emojis por categorías
const emojiCategories = {
    smileys: [
        '😀', '😃', '😄', '😁', '😆', '😅', '🤣', '😂', '🙂', '🙃', '😉', '😊', '😇', '🥰', '😍', '🤩',
        '😘', '😗', '☺️', '😚', '😙', '🥲', '😋', '😛', '😜', '🤪', '😝', '🤑', '🤗', '🤭', '🤫', '🤔',
        '🤐', '🤨', '😐', '😑', '😶', '😶‍🌫️', '😏', '😒', '🙄', '😬', '😮‍💨', '🤥', '😔', '😪', '🤤', '😴'
    ],
    people: [
        '👋', '🤚', '🖐️', '✋', '🖖', '👌', '🤌', '🤏', '✌️', '🤞', '🤟', '🤘', '🤙', '👈', '👉', '👆',
      , '👇', '☝️', '👍', '👎', '👊', '✊', '🤛', '🤜', '👏', '🙌', '👐', '🤲', '🤝', '🙏', '✍️',
        '💅', '🤳', '💪', '🦾', '🦿', '🦵', '🦶', '👂', '🦻', '👃', '🧠', '🫀', '🫁', '🦷', '🦴', '👀'
    ],
    nature: [
        '🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼', '🐻‍❄️', '🐨', '🐯', '🦁', '🐮', '🐷', '🐸', '🐵',
        '🙈', '🙉', '🙊', '🐒', '🐔', '🐧', '🐦', '🐤', '🐣', '🐥', '🦆', '🦅', '🦉', '🦇', '🐺', '🐗',
        '🌱', '🌿', '🍀', '🎍', '🎋', '🍃', '🍂', '🍁', '🍄', '🐚', '🌾', '💐', '🌷', '🌹', '🥀', '🌺'
    ],
    food: [
        '🍎', '🍐', '🍊', '🍋', '🍌', '🍉', '🍇', '🍓', '🫐', '🍈', '🍒', '🍑', '🥭', '🍍', '🥥', '🥝',
        '🍅', '🍆', '🥑', '🥦', '🥬', '🥒', '🌶️', '🫑', '🌽', '🥕', '🫒', '🧄', '🧅', '🥔', '🍠', '🥐',
        '🥖', '🍞', '🥨', '🥯', '🧀', '🥚', '🍳', '🧈', '🥞', '🧇', '🥓', '🥩', '🍗', '🍖', '🦴', '🌭'
    ],
    activities: [
        '⚽', '🏀', '🏈', '⚾', '🥎', '🎾', '🏐', '🏉', '🥏', '🎱', '🪀', '🏓', '🏸', '🏒', '🏑', '🥍',
        '🏏', '🪃', '🥅', '⛳', '🪁', '🏹', '🎣', '🤿', '🥊', '🥋', '🎽', '🛹', '🛷', '⛸️', '🥌', '🎿',
        '⛷️', '🏂', '🪂', '🏋️‍♀️', '🏋️', '🏋️‍♂️', '🤼‍♀️', '🤼', '🤼‍♂️', '🤸‍♀️', '🤸', '🤸‍♂️', '⛹️‍♀️', '⛹️', '⛹️‍♂️', '🤺'
    ],
    travel: [
        '🚗', '🚕', '🚙', '🚌', '🚎', '🏎️', '🚓', '🚑', '🚒', '🚐', '🛻', '🚚', '🚛', '🚜', '🏍️', '🛵',
        '🚲', '🛴', '🛹', '🛼', '🚁', '🛸', '✈️', '🛩️', '🪂', '⛵', '🚤', '🛥️', '🛳️', '⛴️', '🚢', '⚓',
        '⛽', '🚧', '🚦', '🚥', '🚏', '🗺️', '🗿', '🗽', '🗼', '🏰', '🏯', '🏟️', '🎡', '🎢', '🎠', '⛲'
    ],
    objects: [
        '⌚', '📱', '📲', '💻', '⌨️', '🖥️', '🖨️', '🖱️', '🖲️', '🕹️', '🗜️', '💽', '💾', '💿', '📀', '📼',
        '📷', '📸', '📹', '🎥', '📽️', '🎞️', '📞', '☎️', '📟', '📠', '📺', '📻', '🎙️', '🎚️', '🎛️', '🧭',
        '⏱️', '⏲️', '⏰', '🕰️', '⌛', '⏳', '📡', '🔋', '🔌', '💡', '🔦', '🕯️', '🪔', '🧯', '🛢️', '💸'
    ],
    symbols: [
        '❤️', '🧡', '💛', '💚', '💙', '💜', '🖤', '🤍', '🤎', '💔', '❣️', '💕', '💞', '💓', '💗', '💖',
        '💘', '💝', '💟', '☮️', '✝️', '☪️', '🕉️', '☸️', '✡️', '🔯', '🕎', '☯️', '☦️', '🛐', '⛎', '♈',
        '♉', '♊', '♋', '♌', '♍', '♎', '♏', '♐', '♑', '♒', '♓', '🆔', '⚛️', '🉑', '☢️', '☣️', '📴', '📳'
    ]
};

// Configuración de emojis (mantener tu objeto emojiCategories existente)

document.addEventListener('DOMContentLoaded', function() {
    // Inicializar el foro
    initializeForum();
    
    // Inicializar el emoji picker
    initEmojiPicker();
    
    // Configurar otros event listeners
    setupEventListeners();
});

// Modifica la función initEmojiPicker() para agregar estos event listeners
function initEmojiPicker() {
    const emojiButton = document.getElementById('emojiButton');
    const emojiPicker = document.getElementById('emojiPicker');
    const categoryButtons = document.querySelectorAll('.category-btn');
    const emojiSearch = document.getElementById('emojiSearch');
    
    if (!emojiButton || !emojiPicker) {
        console.error('Elementos del emoji picker no encontrados');
        return;
    }
    
    // Configurar botón de emoji
    emojiButton.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        toggleEmojiPicker();
    });
    
    // Configurar botones de categoría
    categoryButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const category = this.getAttribute('data-category');
            currentEmojiCategory = category;
            
            // Actualizar botones activos
            categoryButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Cargar emojis de la categoría seleccionada
            loadEmojiCategory(category);
        });
    });
    
    // Configurar buscador de emojis
    if (emojiSearch) {
        emojiSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            if (searchTerm.length > 0) {
                searchEmojis(searchTerm);
            } else {
                loadEmojiCategory(currentEmojiCategory);
            }
        });
    }
    
    // Cerrar al hacer click fuera
    document.addEventListener('click', function(e) {
        if (!emojiPicker.contains(e.target) && e.target !== emojiButton) {
            hideEmojiPicker();
        }
    });
    
    // Cargar emojis iniciales
    loadEmojiCategory('smileys');
}

// Función para buscar emojis
function searchEmojis(term) {
    const emojiGrid = document.getElementById('emojiGrid');
    if (!emojiGrid) return;
    
    let foundEmojis = [];
    
    // Buscar en todas las categorías
    for (const category in emojiCategories) {
        emojiCategories[category].forEach(emoji => {
            // Aquí podrías agregar lógica para buscar por nombre si tuvieras esa información
            if (emoji.includes(term)) {
                foundEmojis.push(emoji);
            }
        });
    }
    
    emojiGrid.innerHTML = foundEmojis.map(emoji => 
        `<button class="emoji-item" onclick="insertEmojiToInput('${emoji}')">${emoji}</button>`
    ).join('');
}

function toggleEmojiPicker() {
    const emojiPicker = document.getElementById('emojiPicker');
    if (!emojiPicker) return;
    
    emojiPickerVisible ? hideEmojiPicker() : showEmojiPicker();
}

function showEmojiPicker() {
    const emojiPicker = document.getElementById('emojiPicker');
    if (emojiPicker) {
        emojiPicker.style.display = 'block';
        emojiPickerVisible = true;
    }
}

function hideEmojiPicker() {
    const emojiPicker = document.getElementById('emojiPicker');
    if (emojiPicker) {
        emojiPicker.style.display = 'none';
        emojiPickerVisible = false;
    }
}

function loadEmojiCategory(category) {
    const emojiGrid = document.getElementById('emojiGrid');
    if (!emojiGrid) return;
    
    const emojis = emojiCategories[category] || [];
    emojiGrid.innerHTML = emojis.map(emoji => 
        `<button class="emoji-item" onclick="insertEmojiToInput('${emoji}')">${emoji}</button>`
    ).join('');
}

function insertEmojiToInput(emoji) {
    const messageInput = document.getElementById('messageInput');
    if (!messageInput) return;
    
    const start = messageInput.selectionStart;
    const end = messageInput.selectionEnd;
    messageInput.value = messageInput.value.substring(0, start) + emoji + messageInput.value.substring(end);
    messageInput.focus();
    messageInput.setSelectionRange(start + emoji.length, start + emoji.length);
    hideEmojiPicker();
}
// Verificar si el elemento existe
document.getElementById('emojiPicker');

// Forzar a mostrar el picker
document.getElementById('emojiPicker').style.display = 'block';

   const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbws3ckXIZJebtwEdAk0nmeE1uIEaEYN4ZanWWRfJcc0ulOcG29vdfW-R8_mFPzi5w01/exec";     // Implementacion
        // const WEB_APP_URL = dir_cnx;

        var dato_ms = [];          // Datos de la hoja Mensajes
        var dato_pp = [];          // Datos de la hoja Mensajes

        var mensajesLista = "";     // Variable para almacenar los datos obtenidos de la hoja Mensajes

        cargarDatosGenerales();     // Cargar los datos generales al inicio


        const userData1 = {
            username: "junior",
            role: "admin",
            fullName: "Junior Alejandro Barrera ",
            permissions: [
                "dashboard-gps",
                "dashboard-presupuesto",
                "dashboard-abastecimiento",
                "dashboard-bodega"
                // Agrega más si hay más permisos
            ]
        };

        // Guardar en localStorage como 'currentUser'
        // localStorage.setItem('currentUser', JSON.stringify(userData1));

        // Variables globales
        let currentUser = null;
        let messages = [];
        let onlineUsers = [];


        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function () {
            initializeForum();
            setupEventListeners();
            // loadMessages();
            updateOnlineUsers();
        });

        // Inicializar el foro
        function initializeForum() {
            // Verificar autenticación (usando tu sistema existente)
            currentUser = JSON.parse(localStorage.getItem('currentUser'));

            if (!currentUser) {
                alert('Debes iniciar sesión para acceder al foro');
                window.location.href = 'login.html';
                return;
            }

            // Actualizar usuario como activo
            updateUserActivity();
             // Agregar estilos de validación
    agregarEstilosValidacion();
    
    // IMPORTANTE: Inicializar el selector de emojis
    initEmojiPicker();
    

        }

        // Configurar event listeners
        function setupEventListeners() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');

            // Enviar mensaje con Enter
            messageInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Auto-resize del textarea
            messageInput.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });

            // Enviar mensaje con botón
            sendButton.addEventListener('click', sendMessage);

            // Actualizar mensajes cada 3 segundos
            // setInterval(loadMessages, 3000);

            // Actualizar usuarios en línea cada 10 segundos
            setInterval(updateOnlineUsers, 10000);
        }
// REEMPLAZA tu función sendMessage() existente con esta versión mejorada:

function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const messageText = messageInput.value.trim();

    // Validación básica
    if (!messageText) {
        mostrarError('Por favor escribe un mensaje');
        return;
    }

    // Validación de contenido
    const validacion = validarContenido(messageText);
    if (!validacion.esValido) {
        mostrarError(validacion.razon);
        
        // Ofrecer corrección si es posible
        const textoLimpio = limpiarTexto(messageText);
        if (textoLimpio && textoLimpio !== messageText && textoLimpio.length > 2) {
            if (confirm(`Tu mensaje tiene problemas. ¿Quieres enviarlo así?\n\n"${textoLimpio}"`)) {
                messageInput.value = textoLimpio;
                // Volver a validar el texto limpio
                const validacionLimpia = validarContenido(textoLimpio);
                if (validacionLimpia.esValido) {
                    // Si ahora es válido, proceder con el envío
                    enviarMensajeFinal(textoLimpio);
                }
            }
        }
        return;
    }

    // Si pasa todas las validaciones, enviar
    enviarMensajeFinal(messageText);
}
// Función auxiliar para enviar el mensaje ya validado
function enviarMensajeFinal(messageText) {
    const messageInput = document.getElementById('messageInput');
    
    // Crear objeto de mensaje
    const message = {
        id: Date.now(),
        author: currentUser.fullName,
        role: currentUser.role,
        content: messageText,
        timestamp: new Date().toISOString(),
        userId: currentUser.username || currentUser.email
    };

    // Enviar a Google Sheets
    const mensajeArray = [
        message.id,
        message.author,
        message.role,
        message.content,
        message.timestamp,
        message.userId
    ];
    
    enviarDatos("mensajes", 0, mensajeArray, 1);

    // Agregar a la lista local de mensajes
    messages.push(message);
    saveMessages();

    // Limpiar y resetear el input
    messageInput.value = '';
    messageInput.style.height = 'auto';

    // Actualizar la vista
    renderMessages();
    scrollToBottom();
    
    // Mostrar confirmación
    mostrarExito('Mensaje enviado correctamente ✓');
}


// MODIFICA tu función setupEventListeners() para incluir la validación en tiempo real:
function setupEventListeners() {
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');

    // Enviar mensaje con Enter
    messageInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage(); // Esta función ya incluye validación
        }
    });

    // Auto-resize del textarea
    messageInput.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
        
        // VALIDACIÓN EN TIEMPO REAL
        const texto = this.value.trim();
        const validacion = validarContenido(texto);
        
        // Cambiar apariencia del botón según validación
        if (validacion.esValido || texto.length === 0) {
            sendButton.style.backgroundColor = '#007bff';
            sendButton.style.cursor = 'pointer';
            sendButton.disabled = false;
            sendButton.title = 'Enviar mensaje';
        } else {
            sendButton.style.backgroundColor = '#dc3545';
            sendButton.style.cursor = 'not-allowed';
            sendButton.disabled = true;
            sendButton.title = validacion.razon;
        }
    });

    // Enviar mensaje con botón
    sendButton.addEventListener('click', sendMessage);

    // Actualizar usuarios en línea cada 10 segundos
    setInterval(updateOnlineUsers, 10000);
}

// AGREGA estas funciones CSS dinámicas para mejorar la interfaz:
function agregarEstilosValidacion() {
    const style = document.createElement('style');
    style.textContent = `
        /* Estilos para el sistema de validación */
        #messageInput.invalid {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }
        
        #messageInput.valid {
            border-color: #28a745 !important;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
        }
        
        .content-filter-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 8px 12px;
            margin: 5px 0;
            color: #856404;
            font-size: 12px;
            display: none;
        }
        
        .message-counter {
            font-size: 11px;
            color: #6c757d;
            text-align: right;
            margin-top: 2px;
        }
        
        .message-counter.warning {
            color: #dc3545;
        }
    `;
    document.head.appendChild(style);
}

// MODIFICA tu función initializeForum() para incluir los estilos:
function initializeForum() {
    // Verificar autenticación (usando tu sistema existente)
    currentUser = JSON.parse(localStorage.getItem('currentUser'));

    if (!currentUser) {
        alert('Debes iniciar sesión para acceder al foro');
        window.location.href = 'login.html';
        return;
    }

    // Agregar estilos de validación
    agregarEstilosValidacion();
    
    // Actualizar usuario como activo
    updateUserActivity();
}

// FUNCIÓN OPCIONAL: Agregar contador de caracteres
function agregarContadorCaracteres() {
    const messageInput = document.getElementById('messageInput');
    if (!messageInput) return;
    
    // Crear contador
    const contador = document.createElement('div');
    contador.className = 'message-counter';
    contador.id = 'messageCounter';
    messageInput.parentNode.appendChild(contador);
    
    // Actualizar contador
    messageInput.addEventListener('input', function() {
        const length = this.value.length;
        contador.textContent = `${length}/500 caracteres`;
        
        if (length > 450) {
            contador.classList.add('warning');
        } else {
            contador.classList.remove('warning');
        }
    });
}
        

        // Cargar mensajes
        function loadMessages() {
            // const savedMessages1 = localStorage.getItem('dimao_forum_messages');
            const savedMessages = mensajesLista;
            if (savedMessages) {
                messages = JSON.parse(savedMessages);
                renderMessages();
            }
        }

        // Guardar mensajes
        function saveMessages() {
            // localStorage.setItem('dimao_forum_messages', JSON.stringify(messages));
        }

        // Renderizar mensajes
        function renderMessages() {
            const messagesArea = document.getElementById('messagesArea');
            const welcomeMessage = messagesArea.querySelector('.welcome-message');

            // Limpiar mensajes anteriores pero mantener mensaje de bienvenida
            const existingMessages = messagesArea.querySelectorAll('.message');
            existingMessages.forEach(msg => msg.remove());

            // Mostrar solo los últimos 50 mensajes
            const recentMessages = messages.slice(-50);

            recentMessages.forEach(message => {
                const messageElement = createMessageElement(message);
                messagesArea.appendChild(messageElement);
            });

            scrollToBottom();
        }

        // Crear elemento de mensaje
        function createMessageElement(message) {
            const messageDiv = document.createElement('div');
            const isOwnMessage = message.userId === (currentUser.username || currentUser.email);

            messageDiv.className = `message ${isOwnMessage ? 'own' : 'other'}`;

            const messageTime = new Date(message.timestamp).toLocaleString('es-CL', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });

            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="message-author">
                        <span>${message.author}</span>
                        <span class="role-badge role-${message.role.toLowerCase()}">${getRoleDisplayName(message.role)}</span>
                    </div>
                    <div class="message-time">${messageTime}</div>
                </div>
                <div class="message-content">${escapeHtml(message.content)}</div>
            `;

            return messageDiv;
        }

        // Actualizar actividad del usuario
        function updateUserActivity() {
            const activityData = {
                userId: currentUser.username || currentUser.email,
                name: currentUser.fullName,
                role: currentUser.role,
                lastActivity: new Date().toISOString()
            };


            let userActivities = JSON.parse(localStorage.getItem('dimao_user_activities') || '[]');

            // Remover actividad anterior del usuario
            userActivities = userActivities.filter(user => user.userId !== activityData.userId);

            // Agregar nueva actividad
            userActivities.push(activityData);

            // Guardar
            localStorage.setItem('dimao_user_activities', JSON.stringify(userActivities));

        }

        // Actualizar usuarios en línea
        function updateOnlineUsers() {
            updateUserActivity();

            const userActivities = JSON.parse(localStorage.getItem('dimao_user_activities') || '[]');

            const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);

            // Filtrar usuarios activos en los últimos 5 minutos
            onlineUsers = userActivities.filter(user =>
                new Date(user.lastActivity) > fiveMinutesAgo
            );

            renderOnlineUsers();
        }

        // Renderizar usuarios en línea
        function renderOnlineUsers() {
            const userList = document.getElementById('userList');

            if (onlineUsers.length === 0) {
                userList.innerHTML = '<div class="empty-state">No hay usuarios conectados</div>';
                return;
            }

            userList.innerHTML = onlineUsers.map(user => `
                <div class="user-chip">
                    <span class="online-indicator"></span>
                    <span>${user.name}</span>
                    <span class="role-badge role-${user.role.toLowerCase()}">${getRoleDisplayName(user.role)}</span>
                </div>
            `).join('');
        }

        // Función para mostrar nombre del rol
        function getRoleDisplayName(role) {
            const roleNames = {
                'director': 'Director',
                'admin': 'Administrador',
                'combustible': 'Combustible',
                'user': 'Usuario'
            };
            return roleNames[role.toLowerCase()] || role;
        }

        // Escapar HTML para prevenir XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Scroll hacia abajo
        function scrollToBottom() {
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        // Limpiar datos antiguos periódicamente
        function cleanupOldData() {
            // Limpiar mensajes antiguos (más de 7 días)
            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            messages = messages.filter(message => new Date(message.timestamp) > sevenDaysAgo);
            saveMessages();

            // Limpiar actividades de usuarios antiguos
            const userActivities = JSON.parse(localStorage.getItem('dimao_user_activities') || '[]');
            const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
            const activeUsers = userActivities.filter(user => new Date(user.lastActivity) > oneHourAgo);
            localStorage.setItem('dimao_user_activities', JSON.stringify(activeUsers));
        }

        // Ejecutar limpieza cada hora
        setInterval(cleanupOldData, 60 * 60 * 1000);

        // Limpiar al salir de la página
        window.addEventListener('beforeunload', function () {
            cleanupOldData();
        });


        // ************************************************************


        function enviarDatos(pagina, fila, datos, tipo) {

            fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pagina, fila, datos, tipo })
            })
                .then(() => {
                    // mostrarToast('Datos enviados exitosamente 🎉', '#27ae60');
                    // alert('Datos enviados exitosamente');
                    document.getElementById("cargandoOverlay").style.display = "none";     // Ocultar mensaje Cargando ...
                    ingresar_compra1();
                    window.scrollTo({ top: 0, behavior: 'smooth' });                       // Scroll al inicio con animacion                                            // Scroll sin animación
                })
                .catch(error => {
                    // console.error('Error al enviar datos:', error);
                    // mostrarToast('Error al enviar los datos.', '#e74c3c');
                    // alert('Error al enviar los datos');
                })
                .finally(() => {
                });

        }


        // *************************************************************

        function cargarDatosGenerales() {

            fetch(WEB_APP_URL + "?h=MUA")           // Lee la hoja Mensajes, UserActivity y Activity
                .then(response => response.json())
                .then(data => {
                    // Asigna los datos recibidos a las variables bidimensionales
                    dato_ms = data.dato_ms;    // Datos de la hoja "Mensajes"
                    dato_ua = data.dato_ua;    // Datos de la hoja "UserActivity"
                    dato_ac = data.dato_ac;    // Datos de la hoja "Activity"

                    // Convertir desde la fila 1 en adelante a objetos
                    const objetos = dato_ms.slice(1).map(fila => ({
                        id: Number(fila[0]),
                        author: fila[1],
                        role: fila[2],
                        content: fila[3],
                        timestamp: fila[4],
                        userId: fila[5]
                    }));

                    // Convertir a texto JSON como string único
                    mensajesLista = JSON.stringify(objetos);

                    baul = 0;
                    cargarMensajes();

                })
                .catch(error => {
                    console.error('Error al obtener los datos:', error);
                });
        }


        function cargarMensajes() {
            loadMessages();

            setInterval(function () {
                fetch(WEB_APP_URL + "?h=M")           // Lee la hoja Mensajes, UserActivity y Activity
                    .then(response => response.json())
                    .then(data => {
                        // Asigna los datos recibidos a las variables bidimensionales
                        dato_pp = data.dato_ms;    // Datos de la hoja "Mensajes"
                        baul11 = JSON.stringify(dato_pp);
                        baul22 = JSON.stringify(dato_ms)
                        if (baul11 !== baul22) {
                            dato_ms = data.dato_ms;

                            // Convertir desde la fila 1 en adelante a objetos
                            const objetos = dato_ms.slice(1).map(fila => ({
                                id: Number(fila[0]),
                                author: fila[1],
                                role: fila[2],
                                content: fila[3],
                                timestamp: fila[4],
                                userId: fila[5]
                            }));

                            // Convertir a texto JSON como string único
                            mensajesLista = JSON.stringify(objetos);

                            loadMessages();
                        }

                    })
                    .catch(error => {
                        console.error('Error al obtener los datos:', error);
                    });

            }, 5000);
        }
        // Sistema de filtro de contenido inapropiado para el foro

// Lista de palabras y frases prohibidas (puedes agregar más según tus necesidades)
const palabrasProhibidas = [
    // Palabras groseras comunes
    'mierda','maraca', 'puta', 'puto', 'cabrón', 'cabron', 'pendejo', 'idiota', 'estúpido', 'estupido',
    'imbécil', 'imbecil', 'gilipollas', 'joder', 'coño', 'maricón', 'maricon', 'culero',
    'pinche', 'chingada', 'verga', 'huevón', 'huevon', 'ojete', 'mamón', 'mamon',
    
    // Insultos y ofensas
    'tonto', 'bobo', 'inútil', 'inutil', 'fracasado', 'perdedor', 'basura', 'escoria',
    'cerdo', 'rata', 'cucaracha', 'parásito', 'parasito', 'lacra',
    
    // Contenido discriminatorio
    'negro de mierda', 'indio', 'sudaca', 'gringo', 'pocho', 'wetback',
    
    // Amenazas y violencia
    'te voy a matar', 'te mato', 'voy a matarte', 'muérete', 'murete', 'ojalá te mueras',
    'ojala te mueras', 'vete a morir', 'maldito', 'desgraciado', 'hijo de puta',
    
    // Contenido sexual inapropiado
    'porno', 'sexo', 'masturbación', 'masturbacion', 'orgasmo', 'penetración', 'penetracion',
    
    // Drogas y sustancias
    'marihuana', 'coca', 'drogas', 'cocaína', 'cocaina', 'heroína', 'heroina',
    
    // Spam y caracteres repetitivos (se detectará por patrón)
];

// Patrones de texto inapropiado
const patronesProhibidos = [
    /(.)\1{4,}/g,           // Caracteres repetidos más de 4 veces (aaaaa, 11111)
    /[A-Z]{5,}/g,           // Texto en mayúsculas excesivo
    /(.{1,3})\1{3,}/g,      // Patrones repetitivos (jajajajaja, hehehehehe)
    /^\s*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]{3,}\s*$/g, // Solo símbolos
];

// Función principal para validar contenido
function validarContenido(texto) {
    if (!texto || typeof texto !== 'string') {
        return {
            esValido: false,
            razon: 'El mensaje no puede estar vacío'
        };
    }

    const textoLimpio = texto.trim();
    
    // Verificar longitud mínima y máxima
    if (textoLimpio.length < 2) {
        return {
            esValido: false,
            razon: 'El mensaje es demasiado corto'
        };
    }
    
    if (textoLimpio.length > 500) {
        return {
            esValido: false,
            razon: 'El mensaje es demasiado largo (máximo 500 caracteres)'
        };
    }

    // Normalizar texto para comparación
    const textoNormalizado = textoLimpio.toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') // Remover acentos
        .replace(/[^a-z0-9\s]/gi, ' ')   // Reemplazar símbolos por espacios
        .replace(/\s+/g, ' ');           // Normalizar espacios

    // Verificar palabras prohibidas
    for (const palabra of palabrasProhibidas) {
        if (textoNormalizado.includes(palabra.toLowerCase())) {
            return {
                esValido: false,
                razon: 'El mensaje contiene lenguaje inapropiado'
            };
        }
    }

    // Verificar patrones prohibidos
    for (const patron of patronesProhibidos) {
        if (patron.test(textoLimpio)) {
            return {
                esValido: false,
                razon: 'El mensaje contiene patrones no permitidos (spam, exceso de mayúsculas, etc.)'
            };
        }
    }

    // Verificar si es solo espacios o caracteres especiales
    if (textoNormalizado.trim().length === 0) {
        return {
            esValido: false,
            razon: 'El mensaje debe contener texto válido'
        };
    }

    // Verificar URLs sospechosas (opcional)
    const urlPattern = /https?:\/\/[^\s]+/gi;
    const urls = textoLimpio.match(urlPattern);
    if (urls && urls.length > 2) {
        return {
            esValido: false,
            razon: 'Demasiados enlaces en el mensaje'
        };
    }

    return {
        esValido: true,
        razon: null
    };
}

// Función para limpiar y sugerir corrección de texto
function limpiarTexto(texto) {
    if (!texto) return '';
    
    return texto
        .replace(/(.)\1{3,}/g, '$1$1')  // Reducir caracteres repetidos
        .replace(/[A-Z]{4,}/g, (match) => 
            match.charAt(0) + match.slice(1).toLowerCase()) // Corregir mayúsculas excesivas
        .trim();
}

// Función mejorada para enviar mensaje con validación
function sendMessageWithValidation() {
    const messageInput = document.getElementById('messageInput');
    const messageText = messageInput.value.trim();

    if (!messageText) {
        mostrarError('Por favor escribe un mensaje');
        return;
    }

    // Validar contenido
    const validacion = validarContenido(messageText);
    
    if (!validacion.esValido) {
        mostrarError(validacion.razon);
        
        // Sugerir texto limpio si es posible
        const textoLimpio = limpiarTexto(messageText);
        if (textoLimpio && textoLimpio !== messageText) {
            if (confirm(`Tu mensaje tiene problemas. ¿Quieres enviarlo así?\n\nTexto sugerido: "${textoLimpio}"`)) {
                messageInput.value = textoLimpio;
            }
        }
        return;
    }

    // Si el contenido es válido, proceder con el envío original
    const message = {
        id: Date.now(),
        author: currentUser.fullName,
        role: currentUser.role,
        content: messageText,
        timestamp: new Date().toISOString(),
        userId: currentUser.username || currentUser.email
    };

    mensaje = [Date.now(), currentUser.fullName, currentUser.role, messageText, new Date().toISOString(), currentUser.username || currentUser.email];
    enviarDatos("mensajes", 0, mensaje, 1);

    // Guardar mensaje
    messages.push(message);
    saveMessages();

    // Limpiar input
    messageInput.value = '';
    messageInput.style.height = 'auto';

    // Actualizar vista
    renderMessages();
    scrollToBottom();
    
}

// Función para mostrar errores
function mostrarError(mensaje) {
    // Crear elemento de error si no existe
    let errorDiv = document.getElementById('errorMessage');
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = 'errorMessage';
        errorDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            font-family: Arial, sans-serif;
            max-width: 300px;
            word-wrap: break-word;
        `;
        document.body.appendChild(errorDiv);
    }
    
    errorDiv.textContent = mensaje;
    errorDiv.style.display = 'block';
    
    // Ocultar después de 4 segundos
    setTimeout(() => {
        errorDiv.style.display = 'none';
    }, 4000);
}

// Función para mostrar mensajes de éxito
function mostrarExito(mensaje) {
    let exitoDiv = document.getElementById('exitoMessage');
    if (!exitoDiv) {
        exitoDiv = document.createElement('div');
        exitoDiv.id = 'exitoMessage';
        exitoDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            font-family: Arial, sans-serif;
            max-width: 300px;
            word-wrap: break-word;
        `;
        document.body.appendChild(exitoDiv);
    }
    
    exitoDiv.textContent = mensaje;
    exitoDiv.style.display = 'block';
    
    // Ocultar después de 2 segundos
    setTimeout(() => {
        exitoDiv.style.display = 'none';
    }, 2000);
}

// Función para validar texto en tiempo real
function validarTextoEnTiempoReal() {
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    
    if (!messageInput || !sendButton) return;
    
    messageInput.addEventListener('input', function() {
        const texto = this.value.trim();
        const validacion = validarContenido(texto);
        
        // Cambiar color del botón según validación
        if (validacion.esValido) {
            sendButton.style.backgroundColor = '#007bff';
            sendButton.style.cursor = 'pointer';
            sendButton.disabled = false;
        } else {
            sendButton.style.backgroundColor = '#dc3545';
            sendButton.style.cursor = 'not-allowed';
            sendButton.disabled = texto.length > 0; // Solo deshabilitar si hay texto inválido
        }
    });
}
        
</script>
</body>
</html>